---
title: "Avances LAPOP"
author: "José Rodríguez de la Fuente - Gonzalo Assusa"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: True
    toc_float: True
    code_folding: hide
---


```{r librerias y base, echo=FALSE, warning=FALSE, message=FALSE}
rm(list = ls())

if (!require("pacman")) install.packages("pacman") 

pacman::p_load(tidyverse, kableExtra, GDAtools, FactoMineR, VIM, janitor, gridExtra,
               janitor, readxl, gtsummary, lme4, texreg, reghelper, nlme, plm)

load("bases/lapop2004_2018.RData")

# Filtro países
lapop2004_2018 <- lapop2004_2018 %>% 
  filter(country %in% c(1, 8, 11, 13, 14, 15, 17) & wave >= 2008)

#Bases contextuales
paises_desempleo <- read_excel("bases/datos_agregados.xlsx", sheet = "Desempleo")
paises_informalidad <- read_excel("bases/datos_agregados.xlsx", sheet = "Informalidad")
paises_empleopub <- read_excel("bases/datos_agregados.xlsx", sheet = "Empleo público")
paises_brecha <- read_excel("bases/datos_agregados.xlsx", sheet = "Brecha remun")

agregados <- paises_desempleo %>% 
  left_join(paises_informalidad, by = c("country_f", "wave")) %>% 
  left_join(paises_empleopub, by = c("country_f", "wave")) %>% 
  left_join(paises_brecha, by = c("country_f", "wave")) %>% 
  mutate(wave = ifelse(wave == 2013 & country_f != "Chile", 2012, wave),
         wave = case_when(country_f == "Chile" & wave == 2006 ~ 2008,
                          country_f == "Chile" & wave == 2009 ~ 2010,
                          country_f == "Chile" & wave == 2011 ~ 2012,
                          country_f == "Chile" & wave == 2013 ~ 2014,
                          country_f == "Chile" & wave == 2015 ~ 2016,
                          country_f == "Chile" & wave == 2017 ~ 2018,
                          TRUE ~ wave)) %>% 
  filter(wave >= 2008)

```

# Preparación de la base

```{r prepación variables}

#2008-2018
lapop2004_2018$democracia7 <- lapop2004_2018$ing4
lapop2004_2018$democracia_ord <- lapop2004_2018$pn4
lapop2004_2018$reduc_desigualdad <- lapop2004_2018$ros4

lapop2004_2018$country_f <- factor(lapop2004_2018$country, 
                                   labels = c("México", "Colombia", "Perú", 
                                              "Chile", "Uruguay", "Brasil", "Argentina"))

lapop2004_2018$sexo <- factor(lapop2004_2018$q1, labels = c("Varón", "Mujer"))

lapop2004_2018 <- lapop2004_2018 %>% 
  mutate(categoria_ocup = case_when((colocup4a <= 2 | ocup4a <= 2) & ocup1a == 3 ~ 1,
                                  (colocup4a <= 2 | ocup4a <= 2) & ocup1a == 1 ~ 2,
                                  (colocup4a <= 2 | ocup4a <= 2) & ocup1a == 2 ~ 3,
                                  (colocup4a <= 2 | ocup4a <= 2) & ocup1a == 4 ~ 4,
                                  (colocup4a == 3 |ocup4a == 3) | ocup1a == 5 ~ 5,
                                  colocup4a >= 4 |ocup4a >= 4 ~ 6),
         categoria_ocup_f = factor(categoria_ocup, labels = c("Patrón", "Asalariado público",
                                                          "Asalariado privado",
                                                          "Cuenta propia", "Desocupado",
                                                          "Inactivo")),
         ing_decil = case_when(wave == 2008 | wave == 2010 ~ q10,
                               wave == 2012 ~ q10new_12,
                               wave == 2014 ~ q10new_14,
                               wave == 2016 ~ q10new_16,
                               wave == 2018 ~ q10new_18),
         ideologia = car::recode(l1, "1=10; 2=9; 3=8; 4=7; 5=6; 6=5; 7=4; 8=3; 9=2; 10=1"))

#2018
lapop2004_2018$desempleados <- lapop2004_2018$redist3
lapop2004_2018$desempleados <- car::recode(lapop2004_2018$desempleados,
                                           "7=1;6=2;5=3;4=4;3=5;2=6;1=7")

lapop2004_2018$ayuda_pobres <- lapop2004_2018$redist1

lapop2004_2018 <- lapop2004_2018 %>%
  mutate(redist2_inv = ifelse(wave == 2018, car::recode(redist2, "1=7; 2=6; 3=5; 4=4; 5=3; 
                                                        6=2; 7=1"), NA),
         impuestos_ricos = ifelse(wave == 2018, case_when(country == 8 ~ redist2_inv,
                                     TRUE ~ redist2a), NA),
         urbano = ifelse(wave == 2018, factor(ur, labels = c("Urbano", "Rural")), NA),
         informal = ifelse(wave == 2018, car::recode(formal, "1=0; 2=1"), NA),
         formal_f = ifelse(wave == 2018, factor(formal, labels = c("formal", "informal")), NA),
         formal_estado = factor(ifelse(wave == 2018, case_when(formal == 1 ~ 1,
                                   formal == 2 ~ 2,
                                   categoria_ocup == 5 ~ 3,
                                   categoria_ocup == 6 ~ 4,
                                   TRUE ~ NA_real_), NA)),
         formal_estado = factor(formal_estado, labels = c("Formal", "Informal", "Desocupado",
                                                          "Inactivo")),
         formal_estado2 = factor(ifelse(wave == 2018, case_when(formal == 1 ~ 1,
                                   formal == 2 ~ 2,
                                   categoria_ocup >= 5 ~ 3,
                                   TRUE ~ NA_real_), NA)),
         formal_estado2 = factor(formal_estado2, labels = c("Formal", "Informal", "No ocupados")),
         estatus_ocup = ifelse(wave == 2018, case_when(ocupoit <= 2 ~ 1,
                                  ocupoit > 2 & ocupoit < 4 ~ 2,
                                  ocupoit %in% c(5, 7, 8, 10) ~ 3,
                                  ocupoit %in% c(6, 9) ~ 4,
                                  categoria_ocup >= 5 ~ 5,
                                  TRUE ~ NA_real_), NA),
         estatus_ocup_f = factor(estatus_ocup, labels =
                                                        c("Directivos-Profesionales",
                                                          "Técnicos-administrativos-vendedores",
                                                          "Trabajadores manuales calificados",
                                                          "Trabajadores manuales no calificados",
                                                          "No ocupados")))

#Pegado bases

lapop2004_2018 <- lapop2004_2018 %>% 
  left_join(agregados, by = c("country_f", "wave"))

rm(paises_brecha, paises_desempleo, paises_empleopub, paises_informalidad)
 
```


# Casos perdidos variables objetivo

```{r Resumen casos perdidos variables objetivo 2008-2018, echo=FALSE, warning=FALSE, message=FALSE}
print(lapop2004_2018 %>% 
  select(democracia7, reduc_desigualdad) %>% 
  summarytools::dfSummary(plain.ascii  = FALSE, 
          style        = "grid", 
          graph.magnif = 0.75, 
          valid.col    = FALSE),
  method = "render")
```

```{r Casos perdidos democracia7, echo=FALSE, warning=FALSE, message=FALSE}

kable(round(prop.table(table(lapop2004_2018$democracia7, lapop2004_2018$wave, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Democracia 7 categorías x onda") %>% 
  kable_styling()

kable(round(prop.table(table(lapop2004_2018$democracia7, lapop2004_2018$ed, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Democracia 7 categorías x educación") %>% 
  kable_styling()

kable(round(prop.table(table(lapop2004_2018$democracia7, lapop2004_2018$categoria_ocup_f, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Democracia 7 categorías x ocupación") %>% 
  kable_styling()

kable(round(prop.table(table(lapop2004_2018$democracia7, lapop2004_2018$ing_decil, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Democracia 7 categorías x ingresos (decil)") %>% 
  kable_styling()

```

```{r Casos perdidos Desigualdad7, echo=FALSE, warning=FALSE, message=FALSE}
kable(round(prop.table(table(lapop2004_2018$reduc_desigualdad, lapop2004_2018$wave, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Reducción de la desigualdad x onda") %>% 
  kable_styling()

kable(round(prop.table(table(lapop2004_2018$reduc_desigualdad, lapop2004_2018$ed, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Reducción desigualdad x educación") %>% 
  kable_styling()

kable(round(prop.table(table(lapop2004_2018$reduc_desigualdad, lapop2004_2018$categoria_ocup_f,
                             useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Reducción desigualdad x ocupación") %>% 
  kable_styling()

kable(round(prop.table(table(lapop2004_2018$reduc_desigualdad, lapop2004_2018$ing_decil, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Reducción desigualdad x ingresos (decil)") %>% 
  kable_styling()
```

```{r Resumen casos perdidos variables objetivo 2018, echo=FALSE, warning=FALSE, message=FALSE}
lapop2018 <- subset(lapop2004_2018, wave == 2018)

print(lapop2018 %>% 
  select(desempleados, impuestos_ricos, ayuda_pobres) %>% 
  summarytools::dfSummary(plain.ascii  = FALSE, 
          style        = "grid", 
          graph.magnif = 0.75, 
          valid.col    = FALSE),
  method = "render")
```

```{r Casos perdidos Desempleados, echo=FALSE, warning=FALSE, message=FALSE}

kable(round(prop.table(table(lapop2018$desempleados, lapop2018$ed, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Desempleados x educación") %>% 
  kable_styling()

kable(round(prop.table(table(lapop2018$desempleados, lapop2018$categoria_ocup_f,
                             useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Desempleados x ocupación") %>% 
  kable_styling()

kable(round(prop.table(table(lapop2018$desempleados, lapop2018$ing_decil, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Desempleados x ingresos (decil)") %>% 
  kable_styling()
```

```{r Casos perdidos Ayuda pobreza, echo=FALSE, warning=FALSE, message=FALSE}

kable(round(prop.table(table(lapop2018$ayuda_pobres, lapop2018$ed, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Ayuda pobres x educación") %>% 
  kable_styling()

kable(round(prop.table(table(lapop2018$ayuda_pobres, lapop2018$categoria_ocup_f,
                             useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Ayuda pobres x ocupación") %>% 
  kable_styling()

kable(round(prop.table(table(lapop2018$ayuda_pobres, lapop2018$ing_decil, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Ayuda pobres x ingresos (decil)") %>% 
  kable_styling()
```

```{r Casos perdidos impuesto ricos, echo=FALSE, warning=FALSE, message=FALSE}

kable(round(prop.table(table(lapop2018$impuestos_ricos, lapop2018$ed, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Impuestos ricos x educación") %>% 
  kable_styling()

kable(round(prop.table(table(lapop2018$impuestos_ricos, lapop2018$categoria_ocup_f,
                             useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Impuestos ricos x ocupación") %>% 
  kable_styling()

kable(round(prop.table(table(lapop2018$impuestos_ricos, lapop2018$ing_decil, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Impuestos ricos x ingresos (decil)") %>% 
  kable_styling()
```


Se observa que para las variables objetivo de *impuestos*, *ayuda a la pobreza* y *desempleo* no existiría un sesgo importante por parte de los grupos más desfavorecidos en educación, ingresos y trabajo. Por tal motivo, esos casos perdidos pueden ser no considerados en el análisis.  

Se realiza un análisis de correspondencias múltiples para observar el vínculo entre la variable de *democracia* y *reducción de la desigualdad*. De este surge que los grupos más desfavorecidos son los que menos reponden a dichas preguntas. 

```{r Análisis multivariado casos perdidos, echo=FALSE, warning=FALSE, message=FALSE}
lapop2018$ed_f <- factor(lapop2018$ed, labels = c(0:18))
lapop2018$ing_decil_f <- factor(lapop2018$ing_decil, labels = c(0:16))
lapop2018$democracia7_f <- factor(lapop2018$democracia7, labels = c(1:7))
lapop2018$reduc_desigualdad_f <- factor(lapop2018$reduc_desigualdad, labels = c(1:7))
lapop2018$ayuda_pobres_f <- factor(lapop2018$ayuda_pobres, labels = c(1:7))
lapop2018$impuestos_ricos_f <- factor(lapop2018$impuestos_ricos, labels = c(1:7))
lapop2018$desempleados_f <- factor(lapop2018$desempleados, labels = c(1:7))

variables_mca <- lapop2018 %>% 
  select(democracia7_f, reduc_desigualdad_f,
         ed_f, categoria_ocup_f, ing_decil_f)

mca1 <- MCA(variables_mca, ncp = 2, graph = F)

ggcloud_variables(mca1, vlab = F, shapes = T, shapesize = 2, points = "besth")

```

Se opta entonces por imputar a los casos sin respuesta en las variables de *democracia* y *reducción de la desigualdad*, utilizando la técnica de hot deck. Esta realiza una imputación aleatoria, brindándole un valor válido a un caso con valor faltante. Para ello, la imputación se hará al interior de los grupos de ingresos y posteriormente, en el caso los grupos con ingresos faltantes, se utilizará el nivel educativo.

## Imputación variables objetivo

```{r Imputación variables objetivo, results="asis", warning=FALSE}
#1) Random Hot Deck para la variable democracia7 -----

lapop2004_2018$democracia7_imp <- lapop2004_2018$democracia7

set.seed(971986)
lapop2004_2018 <- lapop2004_2018 %>%
  hotdeck(variable = "democracia7_imp",
          domain_var = "ing_decil",
          imp_suffix = "check")

print(lapop2004_2018 %>% 
  select(democracia7, democracia7_imp) %>% 
  summarytools::dfSummary(plain.ascii  = FALSE, 
          style        = "grid", 
          graph.magnif = 0.75, 
          valid.col    = FALSE),
  method = "render")


#2) Random Hot Deck para la variable reduc_desigualdad -----
lapop2004_2018$reduc_desigualdad_imp <- lapop2004_2018$reduc_desigualdad

set.seed(971986)
lapop2004_2018 <- lapop2004_2018 %>%
  hotdeck(variable = "reduc_desigualdad_imp",
          domain_var = "ing_decil",
          imp_suffix = "check")

print(lapop2004_2018 %>% 
  select(reduc_desigualdad, reduc_desigualdad_imp) %>% 
  summarytools::dfSummary(plain.ascii  = FALSE, 
          style        = "grid", 
          graph.magnif = 0.75, 
          valid.col    = FALSE),
  method = "render")

```

# Casos perdidos variables predictoras

```{r Casos perdidos variables predictoras, results="asis", warning=FALSE}

print(lapop2004_2018 %>% 
  select(ideologia) %>% 
  summarytools::dfSummary(plain.ascii  = FALSE, 
          style        = "grid", 
          graph.magnif = 0.75, 
          valid.col    = FALSE),
  method = "render")


kable(round(prop.table(table(lapop2004_2018$ideologia, lapop2004_2018$wave, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Ideología x onda") %>% 
  kable_styling()

kable(round(prop.table(table(lapop2004_2018$ideologia, lapop2004_2018$ing_decil, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Ideología x ingreso") %>% 
  kable_styling()

kable(round(prop.table(table(lapop2004_2018$ideologia, lapop2004_2018$ed, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Ideología x educacion") %>% 
  kable_styling()

#MCA
lapop2004_2018$ed_f <- factor(lapop2004_2018$ed, labels = c(0:18))
lapop2004_2018$ing_decil_f <- factor(lapop2004_2018$ing_decil, labels = c(0:16))
lapop2004_2018$ideologia_f <- factor(lapop2004_2018$ideologia, labels = c(1:10))

variables_mca <- lapop2004_2018 %>% 
  select(ideologia_f, ed_f, categoria_ocup_f, ing_decil_f)

mca2 <- MCA(variables_mca, ncp = 2, graph = F)

ggcloud_variables(mca2, vlab = F, shapes = T, shapesize = 2, points = "besth")

```

Los casos perdidos en la variable *ideología* se encuentran muy asociaciados al nivel educativo bajo y a los ingresos bajos. Nuevamente, como en el caso de las variables objetivo, lo mejor sería imputarlas según nivel económico, ya que está relacionada y no formará parte del modelo de regresión.

```{r Imputación ideologia, echo=FALSE, warning=FALSE, message=FALSE}
#Random Hot Deck para la variable ideologia -----

lapop2004_2018$ideologia_imp <- lapop2004_2018$ideologia

set.seed(971986)
lapop2004_2018 <- lapop2004_2018 %>%
  hotdeck(variable = "ideologia_imp",
          domain_var = "ing_decil",
          imp_suffix = "check")

print(lapop2004_2018 %>% 
  select(ideologia, ideologia_imp) %>% 
  summarytools::dfSummary(plain.ascii  = FALSE, 
          style        = "grid", 
          graph.magnif = 0.75, 
          valid.col    = FALSE),
  method = "render")
```

# Problema variable Tranferencias Condicionadas 

```{r Transferencias condicionadas, echo=FALSE, warning=FALSE, message=FALSE}
kable(lapop2004_2018 %>% 
  filter(wave == 2016 & country_f %in% "Chile") %>% 
  group_by(wf1, cct1b) %>% 
  tally() %>% 
  pivot_wider(id_cols = wf1, names_from = cct1b, values_from = n) %>%
  adorn_totals(where = c("row", "col")) %>% 
  adorn_percentages(denominator = "col") %>% 
  adorn_pct_formatting(digits = 1),
  format = "html", 
  caption = "Ayuda gobierno x Transferencias condicionadas. Chile 2016.") %>% 
  kable_styling()

kable(lapop2004_2018 %>% 
  filter(wave == 2016) %>% 
  group_by(wf1, cct1b) %>% 
  tally() %>% 
  pivot_wider(id_cols = wf1, names_from = cct1b, values_from = n) %>%
  adorn_totals(where = c("row", "col")) %>% 
  adorn_percentages(denominator = "col") %>% 
  adorn_pct_formatting(digits = 1),
  format = "html", 
  caption = "Ayuda gobierno x Transferencias condicionadas. Todos los países 2016.") %>% 
  kable_styling()


```

Las variables de *Ayuda económica del gobierno* y *Transferencias condicionadas* parecieran no apuntar a lo mismo. Del total de familias que recibió transferencias condicionadas, solo un 35,5% indicó declarar que recibió ayuda económica del gobierno. 


# Descriptivos

## Tablas resumen 

```{r tablas, echo=FALSE, warning=FALSE, message=FALSE, results='asis'}
variables_seleccion <- lapop2004_2018 %>% 
  select(democracia7, reduc_desigualdad, desempleados, ayuda_pobres, impuestos_ricos,
         categoria_ocup_f, formal_estado, estatus_ocup_f, ideologia_imp, sexo, 
         q2, ed, urbano, desempleo, informalidad, empleo_publico, brecha_remun, country_f,
         wave)

variables_seleccion$informalidad <- variables_seleccion$informalidad * 100
variables_seleccion$desempleo <- variables_seleccion$desempleo * 100
variables_seleccion$empleo_publico <- variables_seleccion$empleo_publico * 100
variables_seleccion$brecha_remun <- variables_seleccion$brecha_remun * 100

theme_gtsummary_language("es")

variables_seleccion %>%
  tbl_summary(by = wave,
              type = list(c(democracia7, reduc_desigualdad, 
                          desempleados, ayuda_pobres,
                          impuestos_ricos) ~ "continuous"),
              label = c(democracia7 ~ "Acuerdo con democracia", 
                           reduc_desigualdad ~ "Acuerdo con políticas de 
                           reducción de desigualdad", 
                          desempleados ~ "Desempleo como fenómeno voluntario",
                          ayuda_pobres ~ "Los gobiernos deben invertir en ayudar 
                          a los pobres",
                          impuestos_ricos ~ "Injusto que los ricos paguen altos
                          impuestos",
                          categoria_ocup_f ~ "Categoría ocupacional",
                          formal_estado ~ "Formalidad",
                          estatus_ocup_f ~ "Estatus ocupacional",
                          ideologia_imp ~ "Ideología (der-izq)",
                          sexo ~ "Sexo",
                          q2 ~ "Edad",
                          ed ~ "Años educativos",
                          urbano ~ "Región",
                          desempleo ~ "Nivel de desempleo",
                          informalidad ~ "Nivel de informalidad",
                          empleo_publico ~ "Nivel de empleo público",
                          brecha_remun ~ "Brecha informales / asalariados reg.",
                          country_f ~ "País"
                          ),
                 statistic = list(all_continuous() ~ "{mean} ({sd})", 
                                  all_categorical() ~ "{n} ({p}%)"),
                 digits = list(all_categorical() ~ c(0, 1)),
  							 missing = "no") %>% 
  add_overall(col_label = "**Total**", last = TRUE)
```


## Boxplot y gráficos de medias (año y país)  

```{r Análisis de boxplot por año y país democracia, echo=FALSE, warning=FALSE, message=FALSE}

lapop2004_2018 %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(democracia7) %>%
  ggplot(aes(x=as.factor(wave), y=democracia7, fill = country_f)) +
  geom_boxplot(outlier.shape = NA, show.legend = FALSE) +
  labs(title = "Democracia como mejor forma de gobierno por año y país", 
       y = "Aprobación de la democracia",
       caption = "Elaboración propia en base a LAPOP 2008-2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 8),
        axis.text.y = element_text(size = 8)) +
  scale_y_continuous(breaks=seq(1, 7, 1)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/boxplot_democracia.png", dpi = 300, type = "cairo", width = 8, height = 6)

lapop2004_2018 %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(democracia7) %>%
  group_by(country_f, wave) %>% 
  summarise(media = mean(democracia7)) %>% 
  ggplot(aes(x=as.factor(wave), y=media, group = 1)) +
  geom_line(size = 0.5) +
  geom_point(aes(y=media), size = 2) +
  labs(title = "Democracia como mejor forma de gobierno por año y país", 
       y = "Aprobación de la democracia",
       caption = "Elaboración propia en base a LAPOP 2008-2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 8),
        axis.text.y = element_text(size = 8)) +
  scale_y_continuous(breaks=seq(1, 7, 1), limits = c(4,7)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/medias_democracia.png", dpi = 300, type = "cairo", width = 8, height = 6)


```

```{r Análisis de boxplot por año y país reducción de la desigualdad, echo=FALSE, warning=FALSE, message=FALSE}

lapop2004_2018 %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(reduc_desigualdad) %>% 
  ggplot(aes(x=as.factor(wave), y=reduc_desigualdad, fill= country_f)) +
  geom_boxplot(outlier.shape = NA, show.legend = FALSE) +
  labs(title = "Acuerdo con reducción de la desigualdad entre ricos y pobres por año y país", 
       y = "Aprobación de reducción de la desigualdad",
       caption = "Elaboración propia en base a LAPOP 2008-2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 8),
        axis.text.y = element_text(size = 8)) +
  scale_y_continuous(breaks=seq(1, 7, 1)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/boxplot_desigualdad.png", dpi = 300, type = "cairo", width = 8, height = 6)


lapop2004_2018 %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(reduc_desigualdad) %>%
  group_by(country_f, wave) %>% 
  summarise(media = mean(reduc_desigualdad)) %>% 
  ggplot(aes(x=as.factor(wave), y=media, group = 1)) +
  geom_line(size = 0.5) +
  geom_point(aes(y=media), size = 2) +
  labs(title = "Acuerdo con reducción de la desigualdad entre ricos y pobres por año y país", 
       y = "Aprobación de reducción de la desigualdad",
       caption = "Elaboración propia en base a LAPOP 2008-2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 8),
        axis.text.y = element_text(size = 8)) +
  scale_y_continuous(breaks=seq(1, 7, 1), limits = c(4,7)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/medias_desigualdad.png", dpi = 300, type = "cairo", width = 8, height = 6)


```

## Boxplot 2018  

```{r Análisis de boxplot 2018, echo=FALSE, warning=FALSE, message=FALSE}

desempleados <- lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(desempleados) %>%
  ggplot(aes(x=fct_relevel(country_f, "Total", after = Inf), y=desempleados, 
             fill= country_f)) +
  geom_boxplot(outlier.shape = NA, show.legend = FALSE) +
  stat_summary(fun.y = mean, geom ="point", aes(group = 1), show.legend = F) +
  stat_summary(fun.y = mean, geom = "line", linetype = "dotted", aes(group = 1)) +
  labs(title = "Los desempleados no pueden encontrar \ntrabajo solo por su voluntad", 
       y = "Nivel de acuerdo") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 8),
        axis.text.y = element_text(size = 8)) +
  scale_y_continuous(breaks=seq(1, 7, 1))

ayuda_pobres <- lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(ayuda_pobres) %>% 
  ggplot(aes(x=fct_relevel(country_f, "Total", after = Inf), y=ayuda_pobres, fill= country_f)) +
  geom_boxplot(outlier.shape = NA, show.legend = FALSE) +
  stat_summary(fun.y = mean, geom ="point", aes(group = 1), show.legend = F) +
  stat_summary(fun.y = mean, geom = "line", linetype = "dotted", aes(group = 1)) +
  labs(title = "Los gobiernos deben gastar más en el \ncombate de la pobreza", 
       y = "Nivel de acuerdo") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 8),
        axis.text.y = element_text(size = 8)) +
  scale_y_continuous(breaks=seq(1, 7, 1))

impuestos_ricos <- lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(ayuda_pobres) %>% 
  ggplot(aes(x=fct_relevel(country_f, "Total", after = Inf), 
             y=impuestos_ricos, fill= country_f)) +
  geom_boxplot(outlier.shape = NA, show.legend = FALSE) +
  stat_summary(fun.y = mean, geom ="point", aes(group = 1), show.legend = F) +
  stat_summary(fun.y = mean, geom = "line", linetype = "dotted", aes(group = 1)) +
  labs(title = "Los ricos paguen mucho en impuestos pero \nreciban poco en servicios del Estado", 
       y = "Nivel de acuerdo") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 8),
        axis.text.y = element_text(size = 8)) +
  scale_y_continuous(breaks=seq(1, 7, 1))

boxplot_objetivo2018 <- grid.arrange(desempleados, ayuda_pobres, impuestos_ricos, nrow = 2,
             bottom = textGrob("Fuente: elaboración propia en base a LAPOP 2018",
                               gp = gpar(fontsize = 9),
                               hjust = 1.1, 
                               x = 1))



ggsave(filename = "salidas/boxplot_objetivo2018.png", dpi = 300, type = "cairo", width = 8, height = 6,
       boxplot_objetivo2018)


```


# Descriptivos variables independientes 

```{r Barras variable laboral, echo=FALSE, warning=FALSE, message=FALSE}
lapop2004_2018 %>%
  drop_na(categoria_ocup_f) %>% 
  group_by(country_f, wave, categoria_ocup_f) %>% 
  tally() %>%
  group_by(country_f, wave) %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  ggplot(aes(x=as.factor(wave), y=porcentaje, fill= categoria_ocup_f)) +
  geom_col() +
  labs(title = "Categorías laborales por año y país", 
       caption = "Elaboración propia en base a LAPOP 2008-2018",
       fill = "Categorías laborales") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7),
        axis.text.y = element_text(size = 7)) +
  scale_y_continuous(labels= scales::percent_format(accuracy = 1L), 
                     breaks=seq(0, 1, 0.2)) +
  facet_wrap(~country_f, ncol = 3)

ggsave(filename = "salidas/categoria_laboral.png", dpi = 300, type = "cairo", width = 8, height = 6)


```

```{r Barras informalidad, echo=FALSE, warning=FALSE, message=FALSE}

lapop2004_2018 %>%
  filter(wave==2018) %>%
  group_by(country_f) %>% 
  summarise(informal_lapop = mean(informal, na.rm = T)*100,
            informal_ext = mean(informalidad)*100) %>% 
  pivot_longer(!country_f, names_to = "tipo",
               values_to = "porcentaje") %>% 
  ggplot(aes(x=country_f, y=porcentaje, fill= tipo)) +
  geom_bar(stat = "identity", position="dodge") +
  geom_text(aes(label = round(porcentaje, digits = 2), y = porcentaje + 1),
            position = position_dodge(.9), vjust = 0, size = 3) +
  labs(title = "Informalidad por país",
       caption = "Elaboración propia en base a LAPOP 2018 y encuestas de hogares",
       fill = "Tipo de fuente",
       y = "Porcentaje") +
  theme(plot.title = element_text(size = 12, face = "bold"),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 10),
        axis.text.x = element_text(size = 8),
        axis.text.y = element_text(size = 8)) +
  scale_y_continuous(breaks=seq(0, 100, 10)) +
  scale_fill_discrete(labels = c("Informalidad LAPOP", 
                                 "Informalidad fuentes \nexternas"))

ggsave(filename = "salidas/informalidad.png", dpi = 300, type = "cairo", width = 8, height = 6)


```


# Cruces variable laboral y variables objetivo 2008-2018

```{r Cruce variable laboral y democracia, echo=FALSE, warning=FALSE, message=FALSE}

lapop2004_2018 %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(democracia7, categoria_ocup_f) %>% 
  ggplot(aes(x=categoria_ocup_f, y=democracia7, fill= country_f)) +
  geom_boxplot(outlier.shape = NA, show.legend = FALSE) +
  labs(title = "Democracia como mejor forma de gobierno según categoría laboral por país", 
       caption = "Elaboración propia en base a LAPOP 2008-2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 8)) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  scale_y_continuous(breaks=seq(1, 7, 1)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/boxplot_democracia_categoria.png", dpi = 300, type = "cairo", width = 8, height = 6)


lapop2004_2018 %>%
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(democracia7, categoria_ocup_f) %>% 
  group_by(country_f, categoria_ocup_f) %>% 
  summarise(media = mean(democracia7)) %>% 
  ggplot(aes(x=categoria_ocup_f, y=media, group=1)) +
  geom_line(size = 0.5) +
  geom_point(aes(y=media), size = 2) +
  labs(title = "Democracia como mejor forma de gobierno según categoría laboral por país (media)", 
       subtitle = "Variable democracia7 sin imputar",
       caption = "Elaboración propia en base a LAPOP 2008-2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 8)) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  scale_y_continuous(breaks=seq(1, 7, 1), limits = c(4,7)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/medias_democracia_categoria.png", dpi = 300, type = "cairo", width = 8, height = 6)
  
```


```{r Cruce variable laboral y reducción de la desigualdad, echo=FALSE, warning=FALSE, message=FALSE}

lapop2004_2018 %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(reduc_desigualdad, categoria_ocup_f) %>% 
  ggplot(aes(x=categoria_ocup_f, y=reduc_desigualdad, fill= country_f)) +
  geom_boxplot(outlier.shape = NA, show.legend = FALSE) +
  labs(title = "Acuerdo con reducción de la desigualdad entre ricos y pobres según categoría laboral por país", 
       subtitle = "Variable reduc_desigualdad sin imputar",
       y = "Aprobación de reducción de la desigualdad",
       caption = "Elaboración propia en base a LAPOP 2008-2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 8)) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  scale_y_continuous(breaks=seq(1, 7, 1)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/boxplot_desigualdad_categoria.png", dpi = 300, type = "cairo", width = 8, height = 6)

lapop2004_2018 %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(reduc_desigualdad, categoria_ocup_f) %>% 
  group_by(country_f, categoria_ocup_f) %>% 
  summarise(media = mean(reduc_desigualdad), sd = sqrt(var(reduc_desigualdad)), 
            se = sd / sqrt(length(reduc_desigualdad))) %>% 
  ggplot(aes(x=categoria_ocup_f, y=media, group=1)) +
  geom_line(size = 0.5) +
  geom_point(aes(y=media), size = 2) +
  labs(title = "Acuerdo con reducción de la desigualdad entre ricos y pobres según categoría laboral por país (media)", 
       subtitle = "Variable reduc_desigualdad sin imputar",
       y = "Aprobación de reducción de la desigualdad",
       caption = "Elaboración propia en base a LAPOP 2008-2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 8)) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  scale_y_continuous(breaks=seq(1, 7, 1), limits = c(4,7)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/medias_desigualdad_categoria.png", dpi = 300, type = "cairo", width = 8, height = 6)
  
```


# Cruces variable laboral / informal y variables objetivo 2018  


```{r Cruce variable laboral y variables objetivo 2018, echo=FALSE, warning=FALSE, message=FALSE}

#Desempleados

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(desempleados, categoria_ocup_f) %>% 
  group_by(country_f, categoria_ocup_f) %>% 
  summarise(media = mean(desempleados)) %>% 
  ggplot(aes(x=categoria_ocup_f, y=media, group=1)) +
  geom_line(size = 0.5) +
  geom_point(aes(y=media), size = 2) +
  labs(title = "Los desempleados no pueden encontrar trabajo solo por su voluntad (media)", 
       y = "Nivel de acuerdo",
       caption = "Elaboración propia en base a LAPOP 2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 8)) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  scale_y_continuous(breaks=seq(1, 7, 1), limits = c(2,5)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/desempleados_categoria.png", dpi = 300, type = "cairo", width = 8, height = 6)

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(desempleados, formal_estado) %>% 
  group_by(country_f, formal_estado) %>% 
  summarise(media = mean(desempleados)) %>% 
  ggplot(aes(x=formal_estado, y=media, group=1)) +
  geom_line(size = 0.5) +
  geom_point(aes(y=media), size = 2) +
  labs(title = "Los desempleados no pueden encontrar trabajo solo por su voluntad (media)", 
       y = "Nivel de acuerdo",
       caption = "Elaboración propia en base a LAPOP 2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 8)) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  scale_y_continuous(breaks=seq(1, 7, 1), limits = c(2,5)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/desempleados_formal.png", dpi = 300, type = "cairo", width = 8, height = 6)

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(desempleados, estatus_ocup) %>% 
  group_by(country_f, estatus_ocup_f) %>% 
  summarise(media = mean(desempleados)) %>% 
  ggplot(aes(x=estatus_ocup_f, y=media, group=1)) +
  geom_line(size = 0.5) +
  geom_point(aes(y=media), size = 2) +
  labs(title = "Los desempleados no pueden encontrar trabajo solo por su voluntad (media)", 
       y = "Nivel de acuerdo",
       caption = "Elaboración propia en base a LAPOP 2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 8)) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  scale_y_continuous(breaks=seq(1, 7, 1), limits = c(2,5)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/desempleados_estatus.png", dpi = 300, type = "cairo", width = 8, height = 6)


#ayuda pobres

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(ayuda_pobres, categoria_ocup_f) %>% 
  group_by(country_f, categoria_ocup_f) %>% 
  summarise(media = mean(ayuda_pobres)) %>% 
  ggplot(aes(x=categoria_ocup_f, y=media, group=1)) +
  geom_line(size = 0.5) +
  geom_point(aes(y=media), size = 2) +
  labs(title = "Los gobiernos deben gastar más en el combate de la pobreza (media)", 
       y = "Nivel de acuerdo",
       caption = "Elaboración propia en base a LAPOP 2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 8)) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  scale_y_continuous(breaks=seq(1, 7, 1), limits = c(4,7)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/ayuda_pobres_categoria.png", dpi = 300, type = "cairo", width = 8, height = 6)

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(ayuda_pobres, formal_estado) %>% 
  group_by(country_f, formal_estado) %>% 
  summarise(media = mean(ayuda_pobres)) %>% 
  ggplot(aes(x=formal_estado, y=media, group=1)) +
  geom_line(size = 0.5) +
  geom_point(aes(y=media), size = 2) +
  labs(title = "Los gobiernos deben gastar más en el combate de la pobreza (media)", 
       y = "Nivel de acuerdo",
       caption = "Elaboración propia en base a LAPOP 2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 8)) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  scale_y_continuous(breaks=seq(1, 7, 1), limits = c(4,7)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/ayuda_pobres_formal.png", dpi = 300, type = "cairo", width = 8, height = 6)


lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(ayuda_pobres, estatus_ocup) %>% 
  group_by(country_f, estatus_ocup_f) %>% 
  summarise(media = mean(ayuda_pobres)) %>% 
  ggplot(aes(x=estatus_ocup_f, y=media, group=1)) +
  geom_line(size = 0.5) +
  geom_point(aes(y=media), size = 2) +
  labs(title = "Los gobiernos deben gastar más en el combate de la pobreza (media)", 
       y = "Nivel de acuerdo",
       caption = "Elaboración propia en base a LAPOP 2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 8)) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  scale_y_continuous(breaks=seq(1, 7, 1), limits = c(4,7)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/ayuda_pobres_estatus.png", dpi = 300, type = "cairo", width = 8, height = 6)



#impuestos ricos

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(impuestos_ricos, categoria_ocup_f) %>% 
  group_by(country_f, categoria_ocup_f) %>% 
  summarise(media = mean(impuestos_ricos)) %>% 
  ggplot(aes(x=categoria_ocup_f, y=media, group=1)) +
  geom_line(size = 0.5) +
  geom_point(aes(y=media), size = 2) +
  labs(title = "Los ricos paguen mucho en impuestos pero reciban poco en servicios del Estado (media)", 
       y = "Nivel de acuerdo",
       caption = "Elaboración propia en base a LAPOP 2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 8)) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  scale_y_continuous(breaks=seq(1, 7, 1), limits = c(3,6)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/impuestos_categoria.png", dpi = 300, type = "cairo", width = 8, height = 6)


lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(impuestos_ricos, formal_estado) %>% 
  group_by(country_f, formal_estado) %>% 
  summarise(media = mean(impuestos_ricos)) %>% 
  ggplot(aes(x=formal_estado, y=media, group=1)) +
  geom_line(size = 0.5) +
  geom_point(aes(y=media), size = 2) +
  labs(title = "Los ricos paguen mucho en impuestos pero reciban poco en servicios del Estado (media)", 
       y = "Nivel de acuerdo",
       caption = "Elaboración propia en base a LAPOP 2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 8)) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  scale_y_continuous(breaks=seq(1, 7, 1), limits = c(3,6)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/impuestos_formal.png", dpi = 300, type = "cairo", width = 8, height = 6)


lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(impuestos_ricos, estatus_ocup) %>% 
  group_by(country_f, estatus_ocup_f) %>% 
  summarise(media = mean(impuestos_ricos)) %>% 
  ggplot(aes(x=estatus_ocup_f, y=media, group=1)) +
  geom_line(size = 0.5) +
  geom_point(aes(y=media), size = 2) +
  labs(title = "Los ricos paguen mucho en impuestos pero reciban poco en servicios del Estado (media)", 
       y = "Nivel de acuerdo",
       caption = "Elaboración propia en base a LAPOP 2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 8)) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  scale_y_continuous(breaks=seq(1, 7, 1), limits = c(3,6)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/impuestos_estatus.png", dpi = 300, type = "cairo", width = 8, height = 6)



#Reducción desigualdad

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(reduc_desigualdad, formal_estado) %>% 
  group_by(country_f, formal_estado) %>% 
  summarise(media = mean(reduc_desigualdad)) %>% 
  ggplot(aes(x=formal_estado, y=media, group=1)) +
  geom_line(size = 0.5) +
  geom_point(aes(y=media), size = 2) +
  labs(title = "Acuerdo con reducción de la desigualdad entre ricos y pobres según categoría laboral por país (media)", 
       subtitle = "Variable reduc_desigualdad sin imputar",
       y = "Aprobación de reducción de la desigualdad",
       caption = "Elaboración propia en base a LAPOP 2008-2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 8)) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  scale_y_continuous(breaks=seq(1, 7, 1), limits = c(4,7)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/desigualdad_formal.png", dpi = 300, type = "cairo", width = 8, height = 6)


lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(reduc_desigualdad, estatus_ocup) %>% 
  group_by(country_f, estatus_ocup_f) %>% 
  summarise(media = mean(reduc_desigualdad)) %>% 
  ggplot(aes(x=estatus_ocup_f, y=media, group=1)) +
  geom_line(size = 0.5) +
  geom_point(aes(y=media), size = 2) +
  labs(title = "Acuerdo con reducción de la desigualdad entre ricos y pobres según categoría laboral por país (media)", 
       subtitle = "Variable reduc_desigualdad sin imputar",
       y = "Aprobación de reducción de la desigualdad",
       caption = "Elaboración propia en base a LAPOP 2008-2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 8)) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  scale_y_continuous(breaks=seq(1, 7, 1), limits = c(4,7)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/desigualdad_estatus.png", dpi = 300, type = "cairo", width = 8, height = 6)




#Democracia
lapop2004_2018 %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(democracia7, formal_estado) %>% 
  group_by(country_f, formal_estado) %>% 
  summarise(media = mean(democracia7)) %>% 
  ggplot(aes(x=formal_estado, y=media, group=1)) +
  geom_line(size = 0.5) +
  geom_point(aes(y=media), size = 2) +
  labs(title = "Democracia como mejor forma de gobierno según categoría laboral por país (media)", 
       subtitle = "Variable democracia7 sin imputar",
       caption = "Elaboración propia en base a LAPOP 2008-2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 8)) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  scale_y_continuous(breaks=seq(1, 7, 1), limits = c(4,7)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/democracia_formal.png", dpi = 300, type = "cairo", width = 8, height = 6)


lapop2004_2018 %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(democracia7, estatus_ocup) %>% 
  group_by(country_f, estatus_ocup_f) %>% 
  summarise(media = mean(democracia7)) %>% 
  ggplot(aes(x=estatus_ocup_f, y=media, group=1)) +
  geom_line(size = 0.5) +
  geom_point(aes(y=media), size = 2) +
  labs(title = "Democracia como mejor forma de gobierno según categoría laboral por país (media)", 
       subtitle = "Variable democracia7 sin imputar",
       caption = "Elaboración propia en base a LAPOP 2008-2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 8)) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  scale_y_continuous(breaks=seq(1, 7, 1), limits = c(4,7)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/democracia_estatus.png", dpi = 300, type = "cairo", width = 8, height = 6)



```

# Modelos Multinivel 2008-2018


```{r Modelo multinivel ICC, echo=FALSE, warning=FALSE, message=FALSE}

base_ml <- lapop2004_2018 %>% 
  mutate(pais_anio = paste(country_f, wave, sep = "_")) %>% 
  drop_na(democracia7, reduc_desigualdad, categoria_ocup_f, ideologia_imp, sexo, 
         q2, ed, desempleo, informalidad, empleo_publico, brecha_remun)

democracia_null <- lmer(democracia7 ~ 1 + (1 | pais_anio), data = base_ml)

reduc_desigualdad_null <- lmer(reduc_desigualdad ~ 1 + (1 | pais_anio), data = base_ml)

```

El **ICC** para la variable objetivo de _acuerdo con la democracia_ es de **`r round(ICC(democracia_null), digits = 3)`**.  

El **ICC** para la variable objetivo de _reducción de la desigualdad_ es de **`r round(ICC(reduc_desigualdad_null), digits = 3)`**.


```{r Centrado de variables, echo=FALSE, warning=FALSE, message=FALSE}

#Centrado de variables
base_ml$sexo_dic <- car::recode(base_ml$sex, "2=0")

base_ml$patron <- ifelse(base_ml$categoria_ocup == 1, 1, 0) 
base_ml$asal_pub <- ifelse(base_ml$categoria_ocup == 2, 1, 0) 
base_ml$asal_pri <- ifelse(base_ml$categoria_ocup == 3, 1, 0)
base_ml$cuenta_prop <- ifelse(base_ml$categoria_ocup == 4, 1, 0)
base_ml$desocupado <- ifelse(base_ml$categoria_ocup == 5, 1, 0)

base_ml <- base_ml %>% 
  mutate(sexo_cwc = sexo_dic - ave(sexo_dic, pais_anio),
         edad_cwc = q2 - ave(q2, pais_anio, FUN=function(x) mean(x, na.rm=T)),
         educ_cwc = ed - ave(ed, pais_anio, FUN=function(x) mean(x, na.rm=T)),
         patron_cwc = patron - ave(patron, pais_anio, 
                                   FUN=function(x) mean(x, na.rm=T)),
         asal_pub_cwc = asal_pub - ave(asal_pub, pais_anio, 
                                   FUN=function(x) mean(x, na.rm=T)),
         asal_pri_cwc = asal_pri - ave(asal_pri, pais_anio, 
                                   FUN=function(x) mean(x, na.rm=T)),
         cuenta_prop_cwc = cuenta_prop - ave(cuenta_prop, pais_anio, 
                                   FUN=function(x) mean(x, na.rm=T)),
         desocupado_cwc = desocupado - ave(desocupado, pais_anio, 
                                   FUN=function(x) mean(x, na.rm=T)),
         ideologia_cwc = ideologia_imp - ave(ideologia_imp, pais_anio),
         desempleo_cgm = (desempleo - mean(desempleo))*100,
         informalidad_cgm = (informalidad - mean(informalidad))*100,
         empleo_pub_cgm = (empleo_publico - mean(empleo_publico))*100,
         brecha_remun_cgm = (brecha_remun - mean(brecha_remun))*100)

```


```{r Multinivel democracia, echo=FALSE, warning=FALSE, message=FALSE, results='asis'}

democracia_ind <- lmer(democracia7 ~ 1 + patron_cwc + asal_pub_cwc + asal_pri_cwc + 
                         cuenta_prop_cwc + desocupado_cwc + ideologia_cwc + sexo_cwc +
                         edad_cwc + educ_cwc + (1 | pais_anio), 
                         data = base_ml)

democracia_ind_grup <- lmer(democracia7 ~ 1 + patron_cwc + asal_pub_cwc + asal_pri_cwc + 
                         cuenta_prop_cwc + desocupado_cwc + ideologia_cwc + sexo_cwc +
                         edad_cwc + educ_cwc + desempleo_cgm + informalidad_cgm +
                         empleo_pub_cgm + brecha_remun_cgm + (1 | pais_anio), 
                         data = base_ml)

democracia_ind_grup_int <- lmer(democracia7 ~ 1 + patron_cwc + asal_pub_cwc + asal_pri_cwc + 
                         cuenta_prop_cwc + desocupado_cwc + ideologia_cwc + sexo_cwc +
                         edad_cwc + educ_cwc + desempleo_cgm + informalidad_cgm +
                         empleo_pub_cgm + brecha_remun_cgm + desocupado_cwc*desempleo_cgm + 
                           (1 | pais_anio), 
                         data = base_ml)

democracia_random_apub <- lmer(democracia7 ~ 1 + patron_cwc + asal_pub_cwc + asal_pri_cwc + 
                         cuenta_prop_cwc + desocupado_cwc + ideologia_cwc + sexo_cwc +
                         edad_cwc + educ_cwc + desempleo_cgm + informalidad_cgm +
                         empleo_pub_cgm + brecha_remun_cgm + desocupado_cwc*desempleo_cgm + (1 + asal_pub_cwc | pais_anio), 
                         data = base_ml)

democracia_random_apri <- lmer(democracia7 ~ 1 + patron_cwc + asal_pub_cwc + asal_pri_cwc + 
                         cuenta_prop_cwc + desocupado_cwc + ideologia_cwc + sexo_cwc +
                         edad_cwc + educ_cwc + desempleo_cgm + informalidad_cgm +
                         empleo_pub_cgm + brecha_remun_cgm + desocupado_cwc*desempleo_cgm + (1 + asal_pri_cwc | pais_anio), 
                         data = base_ml)

democracia_random_cuent <- lmer(democracia7 ~ 1 + patron_cwc + asal_pub_cwc + asal_pri_cwc + 
                         cuenta_prop_cwc + desocupado_cwc + ideologia_cwc + sexo_cwc +
                         edad_cwc + educ_cwc + desempleo_cgm + informalidad_cgm +
                         empleo_pub_cgm + brecha_remun_cgm + desocupado_cwc*desempleo_cgm + (1 + cuenta_prop_cwc | pais_anio), 
                         data = base_ml)

democracia_random_desoc <- lmer(democracia7 ~ 1 + patron_cwc + asal_pub_cwc + asal_pri_cwc + 
                         cuenta_prop_cwc + desocupado_cwc + ideologia_cwc + sexo_cwc +
                         edad_cwc + educ_cwc + desempleo_cgm + informalidad_cgm +
                         empleo_pub_cgm + brecha_remun_cgm + desocupado_cwc*desempleo_cgm + (1 + desocupado_cwc | pais_anio), 
                         data = base_ml)

htmlreg(list(democracia_ind, democracia_ind_grup, democracia_ind_grup_int,
             democracia_random_apub, democracia_random_apri, democracia_random_cuent,
             democracia_random_desoc),
        custom.model.names = c("Ind", "Ind + grup", "Ind + grup + int", "Random_apub",
                               "Random_apri", "Random_cuent", "Random_desoc"),
        custom.coef.names = c("Intercepto", "Patrón", "Asalariado pub.", "Asalariado priv.",
                              "Cuenta propia", "Desocupado", "Ideología (der-izq)",
                              "Varón", "Edad", "Años educ.", "Desempleo", "Informalidad",
                              "Empleo pub.", "Brecha remun.", "Desocupado*desempleo"),
        caption = "Democracia",
        caption.above = T,
        type = "html", doctype = T, file = "salidas/multilevel1.doc")

htmlreg(list(democracia_ind, democracia_ind_grup, democracia_ind_grup_int,
             democracia_random_apub, democracia_random_apri, democracia_random_cuent,
             democracia_random_desoc),
        custom.model.names = c("Ind", "Ind + grup", "Ind + grup + int", "Random_apub",
                               "Random_apri", "Random_cuent", "Random_desoc"),
        custom.coef.names = c("Intercepto", "Patrón", "Asalariado pub.", "Asalariado priv.",
                              "Cuenta propia", "Desocupado", "Ideología (der-izq)",
                              "Varón", "Edad", "Años educ.", "Desempleo", "Informalidad",
                              "Empleo pub.", "Brecha remun.", "Desocupado*desempleo"),
        caption = "Democracia",
        caption.above = T,
        type = "html", doctype = F)
```


```{r ajustes 1, warning=FALSE, message=FALSE, echo=FALSE}
anova(democracia_null, democracia_ind)
anova(democracia_ind, democracia_ind_grup)
anova(democracia_ind_grup, democracia_ind_grup_int)
anova(democracia_ind_grup_int, democracia_random_apub)
anova(democracia_ind_grup_int, democracia_random_apri)
anova(democracia_ind_grup_int, democracia_random_cuent)
anova(democracia_ind_grup_int, democracia_random_desoc)

```


```{r Pseudo R2 1, echo=FALSE, warning=FALSE, message=FALSE}

varcomp_0=as.data.frame(VarCorr(democracia_null))
tau00_0=varcomp_0[1,4]
sigma2_0=varcomp_0[2,4]

varcomp_1=as.data.frame(VarCorr(democracia_ind))
tau00_1=varcomp_1[1,4]
sigma2_1=varcomp_1[2,4]

varcomp_2=as.data.frame(VarCorr(democracia_ind_grup))
tau00_2=varcomp_2[1,4]
sigma2_2=varcomp_2[2,4]

varcomp_3=as.data.frame(VarCorr(democracia_ind_grup_int))
tau00_3=varcomp_3[1,4]
sigma2_3=varcomp_3[2,4]

varcomp_4=as.data.frame(VarCorr(democracia_random_apub))
tau00_4=varcomp_4[1,4]
sigma2_4=varcomp_4[2,4]

varcomp_5=as.data.frame(VarCorr(democracia_random_apri))
tau00_5=varcomp_5[1,4]
sigma2_5=varcomp_5[2,4]


R2_ind_m1=(sigma2_0-sigma2_1)/sigma2_0
R2_grup_m1=(tau00_0-tau00_1)/tau00_0

R2_ind_m2=(sigma2_0-sigma2_2)/sigma2_0
R2_grup_m2=(tau00_0-tau00_2)/tau00_0

R2_ind_m3=(sigma2_0-sigma2_3)/sigma2_0
R2_grup_m3=(tau00_0-tau00_3)/tau00_0

R2_ind_m4=(sigma2_0-sigma2_4)/sigma2_0
R2_grup_m4=(tau00_0-tau00_4)/tau00_0

```


**Importante**  
El test de devianza muestra que los modelos de pendiente aleatoria para los **cuentapropia** y para **desocupados** no mejoran el ajuste.
El pseudo r2 para el segundo nivel (países años) 

* en el modelo con predictores individuales es de **`r R2_grup_m1`**,  
* en el modelo de predictores individuales y grupales es de  **`r R2_grup_m2`**, 
* en el modelo con interacciones es de **`r R2_grup_m3`**,
* en el los modelos de pendiente aleatoria es de **`r R2_grup_m4`**.



```{r Multinivel reducción desigualdad, echo=FALSE, warning=FALSE, message=FALSE, results='asis'}

reduc_desigualdad_ind <- lmer(reduc_desigualdad ~ 1 + patron_cwc + asal_pub_cwc + asal_pri_cwc + 
                         cuenta_prop_cwc + desocupado_cwc + ideologia_cwc + sexo_cwc +
                         edad_cwc + educ_cwc + (1 | pais_anio), data = base_ml)

reduc_desigualdad_ind_grup <- lmer(reduc_desigualdad  ~ 1 + patron_cwc + asal_pub_cwc +
                                     asal_pri_cwc + cuenta_prop_cwc + desocupado_cwc +
                                     ideologia_cwc + sexo_cwc +
                         edad_cwc + educ_cwc + desempleo_cgm + informalidad_cgm +
                         empleo_pub_cgm + brecha_remun_cgm + (1 | pais_anio), 
                         data = base_ml)

reduc_desigualdad_random_apub <- lmer(reduc_desigualdad  ~ 1 + patron_cwc + asal_pub_cwc + asal_pri_cwc + 
                         cuenta_prop_cwc + desocupado_cwc + ideologia_cwc + sexo_cwc +
                         edad_cwc + educ_cwc + desempleo_cgm + informalidad_cgm +
                         empleo_pub_cgm + brecha_remun_cgm + (1 + asal_pub_cwc | pais_anio), 
                         data = base_ml)

reduc_desigualdad_random_apri <- lmer(reduc_desigualdad ~ 1 + patron_cwc + asal_pub_cwc + asal_pri_cwc + 
                         cuenta_prop_cwc + desocupado_cwc + ideologia_cwc + sexo_cwc +
                         edad_cwc + educ_cwc + desempleo_cgm + informalidad_cgm +
                         empleo_pub_cgm + brecha_remun_cgm + (1 + asal_pri_cwc | pais_anio), 
                         data = base_ml)

reduc_desigualdad_random_cuent <- lmer(reduc_desigualdad ~ 1 + patron_cwc + asal_pub_cwc + asal_pri_cwc + 
                         cuenta_prop_cwc + desocupado_cwc + ideologia_cwc + sexo_cwc +
                         edad_cwc + educ_cwc + desempleo_cgm + informalidad_cgm +
                         empleo_pub_cgm + brecha_remun_cgm + (1 + cuenta_prop_cwc | pais_anio), 
                         data = base_ml)

htmlreg(list(reduc_desigualdad_ind, reduc_desigualdad_ind_grup),
        custom.model.names = c("Ind","Ind+grup"),
        custom.coef.names = c("Intercepto", "Patrón", "Asalariado pub.", "Asalariado priv.",
                              "Cuenta propia", "Desocupado", "Ideología (der-izq)",
                              "Varón", "Edad", "Años educ.", "Desempleo", "Informalidad",
                              "Empleo pub.", "Brecha remun."),
        caption = "Reducción de la desigualdad",
        caption.above = T,
        type = "html", doctype = T, file = "salidas/multilevel2.doc")

htmlreg(list(reduc_desigualdad_ind, reduc_desigualdad_ind_grup),
        custom.model.names = c("Ind","Ind+grup"),
        custom.coef.names = c("Intercepto", "Patrón", "Asalariado pub.", "Asalariado priv.",
                              "Cuenta propia", "Desocupado", "Ideología (der-izq)",
                              "Varón", "Edad", "Años educ.", "Desempleo", "Informalidad",
                              "Empleo pub.", "Brecha remun."),
        caption = "Reducción de la desigualdad",
        caption.above = T,
        type = "html", doctype = F)


```


```{r ajustes 2, warning=FALSE, message=FALSE, echo=FALSE}
anova(reduc_desigualdad_null, reduc_desigualdad_ind)
anova(reduc_desigualdad_ind, reduc_desigualdad_ind_grup)

```

**Importante**  
Para la variable objetivo *reducción de la desigualdad* la prueba de devianza muestra que el modelo con variables contextuales agregadas no mejora el ajuste por sobre el modelo de variables individuales.  


# Modelos de efectos fijos (2018) 

## Utilizando todas las variables laborales

```{r modelos efectos fijos 1, warning=FALSE, message=FALSE, echo=FALSE, results='asis'}

lapop2018 <- lapop2004_2018 %>% 
  filter(wave == 2018)

lapop2018$estatus_ocup_f <- relevel(lapop2018$estatus_ocup_f, ref = "No ocupados")
lapop2018$formal_estado2 <- relevel(lapop2018$formal_estado2, ref = "No ocupados")
lapop2018$categoria_ocup_f <- relevel(lapop2018$categoria_ocup_f, ref = "Inactivo")

democracia_fijo <- plm(democracia7 ~ categoria_ocup_f + formal_estado2 + estatus_ocup_f +
                         ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018, index=c("country_f"), model="within")

desigualdad_fijo <- plm(reduc_desigualdad ~ categoria_ocup_f + formal_estado2 +
                          estatus_ocup_f + ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018, index=c("country_f"), model="within")

desempleados_fijo <- plm(desempleados ~ categoria_ocup_f + formal_estado2 +
                          estatus_ocup_f + ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018, index=c("country_f"), model="within")

ayuda_pobres_fijo <- plm(ayuda_pobres ~ categoria_ocup_f + formal_estado2 +
                          estatus_ocup_f + ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018, index=c("country_f"), model="within")

impuestos_ricos_fijo <- plm(impuestos_ricos ~ categoria_ocup_f + formal_estado2 +
                          estatus_ocup_f + ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018, index=c("country_f"), model="within")

htmlreg(list(democracia_fijo, desigualdad_fijo, desempleados_fijo, ayuda_pobres_fijo, impuestos_ricos_fijo),
        custom.model.names = c("Democracia", "Desigualdad", "Desempleados", "Ayuda pobres", "Impuestos ricos"),
        caption = "Con variables laborales",
        caption.above = T,
        type = "html", doctype = T, file = "salidas/efectosfijos1.doc")

htmlreg(list(democracia_fijo, desigualdad_fijo, desempleados_fijo, ayuda_pobres_fijo, impuestos_ricos_fijo),
        custom.model.names = c("Democracia", "Desigualdad", "Desempleados", "Ayuda pobres", "Impuestos ricos"),
        caption = "Con variables laborales",
        caption.above = T,
        type = "html", doctype = FALSE)


```


```{r vif, warning=FALSE, message=FALSE, echo=FALSE}
democracia <- lm(democracia7 ~ categoria_ocup_f + formal_estado2 + estatus_ocup_f +
                         ideologia_imp + urbano + sexo + q2 + ed + country_f, data=lapop2018)

reduc_desigualdad <- lm(reduc_desigualdad ~ categoria_ocup_f + formal_estado2 + estatus_ocup_f +
                         ideologia_imp + urbano + sexo + q2 + ed + country_f, data=lapop2018)

car::vif(democracia)
car::vif(reduc_desigualdad)

```

## Utilizando solo formalidad  


```{r modelos efectos fijos 2, warning=FALSE, message=FALSE, echo=FALSE, results='asis'}

democracia_fijo <- plm(democracia7 ~ formal_estado +
                         ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018, index=c("country_f"), model="within")

desigualdad_fijo <- plm(reduc_desigualdad ~ formal_estado +
                          ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018, index=c("country_f"), model="within")

desempleados_fijo <- plm(desempleados ~ formal_estado +
                          ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018, index=c("country_f"), model="within")

ayuda_pobres_fijo <- plm(ayuda_pobres ~ formal_estado +
                          ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018, index=c("country_f"), model="within")

impuestos_ricos_fijo <- plm(impuestos_ricos ~ formal_estado +
                          ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018, index=c("country_f"), model="within")

htmlreg(list(democracia_fijo, desigualdad_fijo, desempleados_fijo, ayuda_pobres_fijo, impuestos_ricos_fijo),
        custom.model.names = c("Democracia", "Desigualdad", "Desempleados", "Ayuda pobres", "Impuestos ricos"),
        caption = "Sin variables laborales",
        caption.above = T,
        type = "html", doctype = T, file = "salidas/efectosfijos2.doc")

htmlreg(list(democracia_fijo, desigualdad_fijo, desempleados_fijo, ayuda_pobres_fijo, impuestos_ricos_fijo),
        custom.model.names = c("Democracia", "Desigualdad", "Desempleados", "Ayuda pobres", "Impuestos ricos"),
        caption = "Con variables laborales",
        caption.above = T,
        type = "html", doctype = FALSE)


```


```{r prueba efectos fijos 1, warning=FALSE, message=FALSE, echo=FALSE}
democracia <- lm(democracia7 ~ formal_estado +
                         ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018)

desigualdad <- lm(reduc_desigualdad ~ formal_estado +
                          ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018)

desempleados <- lm(desempleados ~ formal_estado +
                          ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018)

ayuda_pobres <- lm(ayuda_pobres ~ formal_estado +
                          ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018)

impuestos_ricos <- lm(impuestos_ricos ~ formal_estado +
                          ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018)

pFtest(democracia_fijo, democracia)
pFtest(desigualdad_fijo, desigualdad)
pFtest(desempleados_fijo, desempleados)
pFtest(ayuda_pobres_fijo, ayuda_pobres)
pFtest(impuestos_ricos_fijo, impuestos_ricos)

```
Para todos los modelos es significativo utilizar **efectos fijos**.  


## Utilizando estatus ocupacional  


```{r modelos efectos fijos 3, warning=FALSE, message=FALSE, echo=FALSE, results='asis'}

democracia_fijo <- plm(democracia7 ~ estatus_ocup_f +
                         ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018, index=c("country_f"), model="within")

desigualdad_fijo <- plm(reduc_desigualdad ~ estatus_ocup_f +
                          ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018, index=c("country_f"), model="within")

desempleados_fijo <- plm(desempleados ~ estatus_ocup_f +
                          ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018, index=c("country_f"), model="within")

ayuda_pobres_fijo <- plm(ayuda_pobres ~ estatus_ocup_f +
                          ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018, index=c("country_f"), model="within")

impuestos_ricos_fijo <- plm(impuestos_ricos ~ estatus_ocup_f +
                          ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018, index=c("country_f"), model="within")

htmlreg(list(democracia_fijo, desigualdad_fijo, desempleados_fijo, ayuda_pobres_fijo, impuestos_ricos_fijo),
        custom.model.names = c("Democracia", "Desigualdad", "Desempleados", "Ayuda pobres", "Impuestos ricos"),
        caption = "Con variable de estatus",
        caption.above = T,
        type = "html", doctype = T, file = "salidas/efectosfijos3.doc")

htmlreg(list(democracia_fijo, desigualdad_fijo, desempleados_fijo, ayuda_pobres_fijo, impuestos_ricos_fijo),
        custom.model.names = c("Democracia", "Desigualdad", "Desempleados", "Ayuda pobres", "Impuestos ricos"),
        caption = "Con variable de estatus",
        caption.above = T,
        type = "html", doctype = FALSE)
```


```{r prueba efectos fijos 3, warning=FALSE, message=FALSE, echo=FALSE}
democracia <- lm(democracia7 ~ estatus_ocup_f +
                         ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018)

desigualdad <- lm(reduc_desigualdad ~ estatus_ocup_f +
                          ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018)

desempleados <- lm(desempleados ~ estatus_ocup_f +
                          ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018)

ayuda_pobres <- lm(ayuda_pobres ~ estatus_ocup_f +
                          ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018)

impuestos_ricos <- lm(impuestos_ricos ~ estatus_ocup_f +
                          ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018)

pFtest(democracia_fijo, democracia)
pFtest(desigualdad_fijo, desigualdad)
pFtest(desempleados_fijo, desempleados)
pFtest(ayuda_pobres_fijo, ayuda_pobres)
pFtest(impuestos_ricos_fijo, impuestos_ricos)

```

Para todos los modelos es significativo utilizar **efectos fijos**.  

