---
title: "Avances Multinivel LAPOP"
author: "José Rodríguez de la Fuente - Gonzalo Assusa"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: simplex
---

```{r librerias y base, echo=FALSE, warning=FALSE, message=FALSE}
rm(list = ls())

if (!require("pacman")) install.packages("pacman") 

pacman::p_load(tidyverse, kableExtra, GDAtools, FactoMineR, VIM, janitor, gridExtra,
               janitor, readxl)

load("bases/lapop2004_2018.RData")

# Filtro países
lapop2004_2018 <- lapop2004_2018 %>% 
  filter(country %in% c(1, 8, 11, 13, 14, 15, 17) & wave >= 2008)

#Bases contextuales
paises <- read_excel("bases/agregados_empleo.xlsx", sheet = "formal")

```

# Preparación de la base

```{r prepación variables}

#2008-2018
lapop2004_2018$democracia7 <- lapop2004_2018$ing4
lapop2004_2018$democracia_ord <- lapop2004_2018$pn4
lapop2004_2018$reduc_desigualdad <- lapop2004_2018$ros4

lapop2004_2018$country_f <- factor(lapop2004_2018$country, 
                                   labels = c("México", "Colombia", "Perú", 
                                              "Chile", "Uruguay", "Brasil", "Argentina"))

lapop2004_2018$sexo <- factor(lapop2004_2018$q1, labels = c("Varón", "Mujer"))

lapop2004_2018 <- lapop2004_2018 %>% 
  mutate(categoria_ocup = case_when((colocup4a <= 2 | ocup4a <= 2) & ocup1a == 3 ~ 1,
                                  (colocup4a <= 2 | ocup4a <= 2) & ocup1a == 1 ~ 2,
                                  (colocup4a <= 2 | ocup4a <= 2) & ocup1a == 2 ~ 3,
                                  (colocup4a <= 2 | ocup4a <= 2) & ocup1a == 4 ~ 4,
                                  (colocup4a == 3 |ocup4a == 3) | ocup1a == 5 ~ 5,
                                  colocup4a >= 4 |ocup4a >= 4 ~ 6),
         categoria_ocup_f = factor(categoria_ocup, labels = c("Patrón", "Asalariado público",
                                                          "Asalariado privado",
                                                          "Cuenta propia", "Desocupado",
                                                          "Inactivo")),
         ing_decil = case_when(wave == 2008 | wave == 2010 ~ q10,
                               wave == 2012 ~ q10new_12,
                               wave == 2014 ~ q10new_14,
                               wave == 2016 ~ q10new_16,
                               wave == 2018 ~ q10new_18),
         ideologia = car::recode(l1, "1=10; 2=9; 3=8; 4=7; 5=6; 6=5; 7=4; 8=3; 9=2; 10=1"))

#2018
lapop2004_2018$desempleados <- lapop2004_2018$redist3
lapop2004_2018$desempleados <- car::recode(lapop2004_2018$desempleados,
                                           "7=1;6=2;5=3;4=4;3=5;2=6;1=7")

lapop2004_2018$ayuda_pobres <- lapop2004_2018$redist1

lapop2004_2018 <- lapop2004_2018 %>% 
  mutate(redist2_inv = car::recode(redist2, "1=7; 2=6; 3=5; 4=4; 5=3; 6=2; 7=1"),
         impuestos_ricos = case_when(country == 8 ~ redist2_inv,
                                     TRUE ~ redist2a),
         urbano = factor(ur, labels = c("Urbano", "Rural")),
         informal = car::recode(formal, "1=0; 2=1"),
         formal_f = factor(formal, labels = c("formal", "informal")),
         formal_estado = case_when(formal == 1 ~ 1,
                                   formal == 2 ~ 2,
                                   categoria_ocup >= 5 ~ 3,
                                   TRUE ~ NA_real_),
         formal_estado = factor(formal_estado, labels = c("Formal", "Informal",
                                                          "No ocupados")),
         estatus_ocup = case_when(ocupoit <= 2 ~ 1,
                                  ocupoit > 2 & ocupoit < 4 ~ 2,
                                  ocupoit %in% c(5, 7, 8, 10) ~ 3,
                                  ocupoit %in% c(6, 9) ~ 4,
                                  categoria_ocup >= 5 ~ 5,
                                  TRUE ~ NA_real_),
         estatus_ocup_f = factor(estatus_ocup, labels = c("Directivos-Profesionales",
                                                          "Técnicos-administrativos-vendedores",
                                                          "Trabajadores manuales calificados",
                                                          "Trabajadores manuales no calificados",
                                                          "No ocupados")))

#Pegado bases

lapop2004_2018 <- lapop2004_2018 %>% 
  left_join(paises, by = "country_f")

```


# Casos perdidos variables objetivo

```{r Resumen casos perdidos variables objetivo 2008-2018, echo=FALSE, warning=FALSE, message=FALSE}
print(lapop2004_2018 %>% 
  select(democracia7, reduc_desigualdad) %>% 
  summarytools::dfSummary(plain.ascii  = FALSE, 
          style        = "grid", 
          graph.magnif = 0.75, 
          valid.col    = FALSE),
  method = "render")
```

```{r Casos perdidos democracia7, echo=FALSE, warning=FALSE, message=FALSE}

kable(round(prop.table(table(lapop2004_2018$democracia7, lapop2004_2018$wave, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Democracia 7 categorías x onda") %>% 
  kable_styling()

kable(round(prop.table(table(lapop2004_2018$democracia7, lapop2004_2018$ed, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Democracia 7 categorías x educación") %>% 
  kable_styling()

kable(round(prop.table(table(lapop2004_2018$democracia7, lapop2004_2018$categoria_ocup_f, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Democracia 7 categorías x ocupación") %>% 
  kable_styling()

kable(round(prop.table(table(lapop2004_2018$democracia7, lapop2004_2018$ing_decil, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Democracia 7 categorías x ingresos (decil)") %>% 
  kable_styling()

```


```{r Casos perdidos Desigualdad7, echo=FALSE, warning=FALSE, message=FALSE}
kable(round(prop.table(table(lapop2004_2018$reduc_desigualdad, lapop2004_2018$wave, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Reducción de la desigualdad x onda") %>% 
  kable_styling()

kable(round(prop.table(table(lapop2004_2018$reduc_desigualdad, lapop2004_2018$ed, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Reducción desigualdad x educación") %>% 
  kable_styling()

kable(round(prop.table(table(lapop2004_2018$reduc_desigualdad, lapop2004_2018$categoria_ocup_f,
                             useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Reducción desigualdad x ocupación") %>% 
  kable_styling()

kable(round(prop.table(table(lapop2004_2018$reduc_desigualdad, lapop2004_2018$ing_decil, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Reducción desigualdad x ingresos (decil)") %>% 
  kable_styling()
```


```{r Resumen casos perdidos variables objetivo 2018, echo=FALSE, warning=FALSE, message=FALSE}
lapop2018 <- subset(lapop2004_2018, wave == 2018)

print(lapop2018 %>% 
  select(desempleados, impuestos_ricos, ayuda_pobres) %>% 
  summarytools::dfSummary(plain.ascii  = FALSE, 
          style        = "grid", 
          graph.magnif = 0.75, 
          valid.col    = FALSE),
  method = "render")
```

```{r Casos perdidos Desempleados, echo=FALSE, warning=FALSE, message=FALSE}

kable(round(prop.table(table(lapop2018$desempleados, lapop2018$ed, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Desempleados x educación") %>% 
  kable_styling()

kable(round(prop.table(table(lapop2018$desempleados, lapop2018$categoria_ocup_f,
                             useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Desempleados x ocupación") %>% 
  kable_styling()

kable(round(prop.table(table(lapop2018$desempleados, lapop2018$ing_decil, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Desempleados x ingresos (decil)") %>% 
  kable_styling()
```


```{r Casos perdidos Ayuda pobreza, echo=FALSE, warning=FALSE, message=FALSE}

kable(round(prop.table(table(lapop2018$ayuda_pobres, lapop2018$ed, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Ayuda pobres x educación") %>% 
  kable_styling()

kable(round(prop.table(table(lapop2018$ayuda_pobres, lapop2018$categoria_ocup_f,
                             useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Ayuda pobres x ocupación") %>% 
  kable_styling()

kable(round(prop.table(table(lapop2018$ayuda_pobres, lapop2018$ing_decil, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Ayuda pobres x ingresos (decil)") %>% 
  kable_styling()
```

```{r Casos perdidos impuesto ricos, echo=FALSE, warning=FALSE, message=FALSE}

kable(round(prop.table(table(lapop2018$impuestos_ricos, lapop2018$ed, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Impuestos ricos x educación") %>% 
  kable_styling()

kable(round(prop.table(table(lapop2018$impuestos_ricos, lapop2018$categoria_ocup_f,
                             useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Impuestos ricos x ocupación") %>% 
  kable_styling()

kable(round(prop.table(table(lapop2018$impuestos_ricos, lapop2018$ing_decil, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Impuestos ricos x ingresos (decil)") %>% 
  kable_styling()
```


Se observa que para las variables objetivo de *impuestos*, *ayuda a la pobreza* y *desempleo* no existiría un sesgo importante por parte de los grupos más desfavorecidos en educación, ingresos y trabajo. Por tal motivo, esos casos perdidos pueden ser no considerados en el análisis.  

Se realiza un análisis de correspondencias múltiples para observar el vínculo entre la variable de *democracia* y *reducción de la desigualdad*. De este surge que los grupos más desfavorecidos son los que menos reponden a dichas preguntas. 

```{r Análisis multivariado casos perdidos, echo=FALSE, warning=FALSE, message=FALSE}
lapop2018$ed_f <- factor(lapop2018$ed, labels = c(0:18))
lapop2018$ing_decil_f <- factor(lapop2018$ing_decil, labels = c(0:16))
lapop2018$democracia7_f <- factor(lapop2018$democracia7, labels = c(1:7))
lapop2018$reduc_desigualdad_f <- factor(lapop2018$reduc_desigualdad, labels = c(1:7))
lapop2018$ayuda_pobres_f <- factor(lapop2018$ayuda_pobres, labels = c(1:7))
lapop2018$impuestos_ricos_f <- factor(lapop2018$impuestos_ricos, labels = c(1:7))
lapop2018$desempleados_f <- factor(lapop2018$desempleados, labels = c(1:7))

variables_mca <- lapop2018 %>% 
  select(democracia7_f, reduc_desigualdad_f,
         ed_f, categoria_ocup_f, ing_decil_f)

mca1 <- MCA(variables_mca, ncp = 2, graph = F)

ggcloud_variables(mca1, vlab = F, shapes = T, shapesize = 2, points = "besth")

```

Se opta entonces por imputar a los casos sin respuesta en las variables de *democracia* y *reducción de la desigualdad*, utilizando la técnica de hot deck. Esta realiza una imputación aleatoria, brindándole un valor válido a un caso con valor faltante. Para ello, la imputación se hará al interior de los grupos de ingresos y posteriormente, en el caso los grupos con ingresos faltantes, se utilizará el nivel educativo.

## Imputación variables objetivo

```{r Imputación variables objetivo, results="asis", warning=FALSE}
#1) Random Hot Deck para la variable democracia7 -----

lapop2004_2018$democracia7_imp <- lapop2004_2018$democracia7

set.seed(971986)
lapop2004_2018 <- lapop2004_2018 %>%
  hotdeck(variable = "democracia7_imp",
          domain_var = "ing_decil",
          imp_suffix = "check")

print(lapop2004_2018 %>% 
  select(democracia7, democracia7_imp) %>% 
  summarytools::dfSummary(plain.ascii  = FALSE, 
          style        = "grid", 
          graph.magnif = 0.75, 
          valid.col    = FALSE),
  method = "render")


#2) Random Hot Deck para la variable reduc_desigualdad -----
lapop2004_2018$reduc_desigualdad_imp <- lapop2004_2018$reduc_desigualdad

set.seed(971986)
lapop2004_2018 <- lapop2004_2018 %>%
  hotdeck(variable = "reduc_desigualdad_imp",
          domain_var = "ing_decil",
          imp_suffix = "check")

print(lapop2004_2018 %>% 
  select(reduc_desigualdad, reduc_desigualdad_imp) %>% 
  summarytools::dfSummary(plain.ascii  = FALSE, 
          style        = "grid", 
          graph.magnif = 0.75, 
          valid.col    = FALSE),
  method = "render")

```

# Casos perdidos variables predictoras

```{r Casos perdidos variables predictoras, results="asis", warning=FALSE}

print(lapop2004_2018 %>% 
  select(ideologia) %>% 
  summarytools::dfSummary(plain.ascii  = FALSE, 
          style        = "grid", 
          graph.magnif = 0.75, 
          valid.col    = FALSE),
  method = "render")


kable(round(prop.table(table(lapop2004_2018$ideologia, lapop2004_2018$wave, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Ideología x onda") %>% 
  kable_styling()

kable(round(prop.table(table(lapop2004_2018$ideologia, lapop2004_2018$ing_decil, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Ideología x ingreso") %>% 
  kable_styling()

kable(round(prop.table(table(lapop2004_2018$ideologia, lapop2004_2018$ed, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Ideología x educacion") %>% 
  kable_styling()

#MCA
lapop2004_2018$ed_f <- factor(lapop2004_2018$ed, labels = c(0:18))
lapop2004_2018$ing_decil_f <- factor(lapop2004_2018$ing_decil, labels = c(0:16))
lapop2004_2018$ideologia_f <- factor(lapop2004_2018$ideologia, labels = c(1:10))

variables_mca <- lapop2004_2018 %>% 
  select(ideologia_f, ed_f, categoria_ocup_f, ing_decil_f)

mca2 <- MCA(variables_mca, ncp = 2, graph = F)

ggcloud_variables(mca2, vlab = F, shapes = T, shapesize = 2, points = "besth")

```

Los casos perdidos en la variable *ideología* se encuentran muy asociaciados al nivel educativo bajo y a los ingresos bajos. Nuevamente, como en el caso de las variables objetivo, lo mejor sería imputarlas según nivel económico, ya que está relacionada y no formará parte del modelo de regresión.

```{r Imputación ideologia, echo=FALSE, warning=FALSE, message=FALSE}
#Random Hot Deck para la variable ideologia -----

lapop2004_2018$ideologia_imp <- lapop2004_2018$ideologia

set.seed(971986)
lapop2004_2018 <- lapop2004_2018 %>%
  hotdeck(variable = "ideologia_imp",
          domain_var = "ing_decil",
          imp_suffix = "check")

print(lapop2004_2018 %>% 
  select(ideologia, ideologia_imp) %>% 
  summarytools::dfSummary(plain.ascii  = FALSE, 
          style        = "grid", 
          graph.magnif = 0.75, 
          valid.col    = FALSE),
  method = "render")
```

# Problema variable Tranferencias Condicionadas 

```{r Transferencias condicionadas, echo=FALSE, warning=FALSE, message=FALSE}
kable(lapop2004_2018 %>% 
  filter(wave == 2016 & country_f %in% "Chile") %>% 
  group_by(wf1, cct1b) %>% 
  tally() %>% 
  pivot_wider(id_cols = wf1, names_from = cct1b, values_from = n) %>%
  adorn_totals(where = c("row", "col")) %>% 
  adorn_percentages(denominator = "col") %>% 
  adorn_pct_formatting(digits = 1),
  format = "html", 
  caption = "Ayuda gobierno x Transferencias condicionadas. Chile 2016.") %>% 
  kable_styling()

kable(lapop2004_2018 %>% 
  filter(wave == 2016) %>% 
  group_by(wf1, cct1b) %>% 
  tally() %>% 
  pivot_wider(id_cols = wf1, names_from = cct1b, values_from = n) %>%
  adorn_totals(where = c("row", "col")) %>% 
  adorn_percentages(denominator = "col") %>% 
  adorn_pct_formatting(digits = 1),
  format = "html", 
  caption = "Ayuda gobierno x Transferencias condicionadas. Todos los países 2016.") %>% 
  kable_styling()


```

Las variables de *Ayuda económica del gobierno* y *Transferencias condicionadas* parecieran no apuntar a lo mismo. Del total de familias que recibió transferencias condicionadas, solo un 35,5% indicó declarar que recibió ayuda económica del gobierno. 


# Descriptivos

## Boxplot (año y país)  

```{r Análisis de boxplot por año y país democracia, echo=FALSE, warning=FALSE, message=FALSE}

lapop2004_2018 %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(democracia7) %>%
  ggplot(aes(x=as.factor(wave), y=democracia7, fill = country_f)) +
  geom_boxplot(outlier.shape = NA, show.legend = FALSE) +
  labs(title = "Democracia como mejor forma de gobierno por año y país", 
       y = "Aprobación de la democracia",
       caption = "Elaboración propia en base a LAPOP 2008-2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 8),
        axis.text.y = element_text(size = 8)) +
  scale_y_continuous(breaks=seq(1, 7, 1)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

```

```{r Análisis de boxplot por año y país reducción de la desigualdad, echo=FALSE, warning=FALSE, message=FALSE}

lapop2004_2018 %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(reduc_desigualdad) %>% 
  ggplot(aes(x=as.factor(wave), y=reduc_desigualdad, fill= country_f)) +
  geom_boxplot(outlier.shape = NA, show.legend = FALSE) +
  labs(title = "Acuerdo con reducción de la desigualdad entre ricos y pobres por año y país", 
       y = "Aprobación de reducción de la desigualdad",
       caption = "Elaboración propia en base a LAPOP 2008-2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 8),
        axis.text.y = element_text(size = 8)) +
  scale_y_continuous(breaks=seq(1, 7, 1)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

```

## Boxplot 2018  

```{r Análisis de boxplot 2018, echo=FALSE, warning=FALSE, message=FALSE}

desempleados <- lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(desempleados) %>%
  ggplot(aes(x=fct_relevel(country_f, "Total", after = Inf), y=desempleados, 
             fill= country_f)) +
  geom_boxplot(outlier.shape = NA, show.legend = FALSE) +
  labs(title = "Los desempleados no pueden encontrar \ntrabajo solo por su voluntad", 
       y = "Nivel de acuerdo") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 8),
        axis.text.y = element_text(size = 8)) +
  scale_y_continuous(breaks=seq(1, 7, 1))

ayuda_pobres <- lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(ayuda_pobres) %>% 
  ggplot(aes(x=fct_relevel(country_f, "Total", after = Inf), y=ayuda_pobres, fill= country_f)) +
  geom_boxplot(outlier.shape = NA, show.legend = FALSE) +
  labs(title = "Los gobiernos deben gastar más en el \ncombate de la pobreza", 
       y = "Nivel de acuerdo") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 8),
        axis.text.y = element_text(size = 8)) +
  scale_y_continuous(breaks=seq(1, 7, 1))

impuestos_ricos <- lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(ayuda_pobres) %>% 
  ggplot(aes(x=fct_relevel(country_f, "Total", after = Inf), 
             y=impuestos_ricos, fill= country_f)) +
  geom_boxplot(outlier.shape = NA, show.legend = FALSE) +
  labs(title = "Los ricos paguen mucho en impuestos pero \nreciban poco en servicios del Estado", 
       y = "Nivel de acuerdo") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 8),
        axis.text.y = element_text(size = 8)) +
  scale_y_continuous(breaks=seq(1, 7, 1))

grid.arrange(desempleados, ayuda_pobres, impuestos_ricos, nrow = 2,
             bottom = textGrob("Fuente: elaboración propia en base a LAPOP 2018",
                               gp = gpar(fontsize = 9),
                               hjust = 1.1, 
                               x = 1))

```


# Descriptivos variables independientes 

```{r Barras variable laboral, echo=FALSE, warning=FALSE, message=FALSE}
lapop2004_2018 %>%
  drop_na(categoria_ocup_f) %>% 
  group_by(country_f, wave, categoria_ocup_f) %>% 
  tally() %>%
  group_by(country_f, wave) %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  ggplot(aes(x=as.factor(wave), y=porcentaje, fill= categoria_ocup_f)) +
  geom_col() +
  labs(title = "Categorías laborales por año y país", 
       caption = "Elaboración propia en base a LAPOP 2008-2018",
       fill = "Categorías laborales") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7),
        axis.text.y = element_text(size = 7)) +
  scale_y_continuous(labels= scales::percent_format(accuracy = 1L), 
                     breaks=seq(0, 1, 0.2)) +
  facet_wrap(~country_f, ncol = 3)

```
```{r Barras informalidad, echo=FALSE, warning=FALSE, message=FALSE}

lapop2004_2018 %>%
  filter(wave==2018) %>%
  group_by(country_f) %>% 
  summarise(informal_lapop = mean(informal, na.rm = T)*100,
            informal_ext = mean(informal_ext)) %>% 
  pivot_longer(!country_f, names_to = "tipo",
               values_to = "porcentaje") %>% 
  ggplot(aes(x=country_f, y=porcentaje, fill= tipo)) +
  geom_bar(stat = "identity", position="dodge") +
  geom_text(aes(label = round(porcentaje, digits = 2), y = porcentaje + 1),
            position = position_dodge(.9), vjust = 0, size = 3) +
  labs(title = "Informalidad por país",
       caption = "Elaboración propia en base a LAPOP 2018 y encuestas de hogares",
       fill = "Tipo de fuente",
       y = "Porcentaje") +
  theme(plot.title = element_text(size = 12, face = "bold"),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 10),
        axis.text.x = element_text(size = 8),
        axis.text.y = element_text(size = 8)) +
  scale_y_continuous(breaks=seq(0, 100, 10)) +
  scale_fill_discrete(labels = c("Informalidad LAPOP", 
                                 "Informalidad fuentes \nexternas"))

```


# Cruces variable laboral y variables objetivo 2008-2018

```{r Cruce variable laboral y democracia, echo=FALSE, warning=FALSE, message=FALSE}

lapop2004_2018 %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(democracia7, categoria_ocup_f) %>% 
  ggplot(aes(x=categoria_ocup_f, y=democracia7, fill= country_f)) +
  geom_boxplot(outlier.shape = NA, show.legend = FALSE) +
  labs(title = "Democracia como mejor forma de gobierno según categoría laboral por país", 
       caption = "Elaboración propia en base a LAPOP 2008-2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 8)) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  scale_y_continuous(breaks=seq(1, 7, 1)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

lapop2004_2018 %>%
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(democracia7, categoria_ocup_f) %>% 
  group_by(country_f, categoria_ocup_f) %>% 
  summarise(media = mean(democracia7)) %>% 
  ggplot(aes(x=categoria_ocup_f, y=media, group=1)) +
  geom_line(size = 0.5) +
  geom_point(aes(y=media), size = 2) +
  labs(title = "Democracia como mejor forma de gobierno según categoría laboral por país (media)", 
       subtitle = "Variable democracia7 sin imputar",
       caption = "Elaboración propia en base a LAPOP 2008-2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 8)) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  scale_y_continuous(breaks=seq(1, 7, 1), limits = c(4,7)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)
  
```


```{r Cruce variable laboral y reducción de la desigualdad, echo=FALSE, warning=FALSE, message=FALSE}

lapop2004_2018 %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(reduc_desigualdad, categoria_ocup_f) %>% 
  ggplot(aes(x=categoria_ocup_f, y=reduc_desigualdad, fill= country_f)) +
  geom_boxplot(outlier.shape = NA, show.legend = FALSE) +
  labs(title = "Acuerdo con reducción de la desigualdad entre ricos y pobres según categoría laboral por país", 
       subtitle = "Variable reduc_desigualdad sin imputar",
       y = "Aprobación de reducción de la desigualdad",
       caption = "Elaboración propia en base a LAPOP 2008-2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 8)) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  scale_y_continuous(breaks=seq(1, 7, 1)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

lapop2004_2018 %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(reduc_desigualdad, categoria_ocup_f) %>% 
  group_by(country_f, categoria_ocup_f) %>% 
  summarise(media = mean(reduc_desigualdad), sd = sqrt(var(reduc_desigualdad)), 
            se = sd / sqrt(length(reduc_desigualdad))) %>% 
  ggplot(aes(x=categoria_ocup_f, y=media, group=1)) +
  geom_line(size = 0.5) +
  geom_point(aes(y=media), size = 2) +
  labs(title = "Acuerdo con reducción de la desigualdad entre ricos y pobres según categoría laboral por país (media)", 
       subtitle = "Variable reduc_desigualdad sin imputar",
       y = "Aprobación de reducción de la desigualdad",
       caption = "Elaboración propia en base a LAPOP 2008-2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 8)) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  scale_y_continuous(breaks=seq(1, 7, 1), limits = c(4,7)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)
  
```


# Cruces variable laboral / informal y variables objetivo 2018  


```{r Cruce variable laboral y variables objetivo 2018, echo=FALSE, warning=FALSE, message=FALSE}

#Desempleados

lapop2004_2018 %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(desempleados, categoria_ocup_f) %>% 
  group_by(country_f, categoria_ocup_f) %>% 
  summarise(media = mean(desempleados)) %>% 
  ggplot(aes(x=categoria_ocup_f, y=media, group=1)) +
  geom_line(size = 0.5) +
  geom_point(aes(y=media), size = 2) +
  labs(title = "Los desempleados no pueden encontrar trabajo solo por su voluntad (media)", 
       y = "Nivel de acuerdo",
       caption = "Elaboración propia en base a LAPOP 2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 8)) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  scale_y_continuous(breaks=seq(1, 7, 1), limits = c(2,5)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

lapop2004_2018 %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(desempleados, formal_estado) %>% 
  group_by(country_f, formal_estado) %>% 
  summarise(media = mean(desempleados)) %>% 
  ggplot(aes(x=formal_estado, y=media, group=1)) +
  geom_line(size = 0.5) +
  geom_point(aes(y=media), size = 2) +
  labs(title = "Los desempleados no pueden encontrar trabajo solo por su voluntad (media)", 
       y = "Nivel de acuerdo",
       caption = "Elaboración propia en base a LAPOP 2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 8)) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  scale_y_continuous(breaks=seq(1, 7, 1), limits = c(2,5)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)


#ayuda pobres

lapop2004_2018 %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(ayuda_pobres, categoria_ocup_f) %>% 
  group_by(country_f, categoria_ocup_f) %>% 
  summarise(media = mean(ayuda_pobres)) %>% 
  ggplot(aes(x=categoria_ocup_f, y=media, group=1)) +
  geom_line(size = 0.5) +
  geom_point(aes(y=media), size = 2) +
  labs(title = "Los gobiernos deben gastar más en el combate de la pobreza (media)", 
       y = "Nivel de acuerdo",
       caption = "Elaboración propia en base a LAPOP 2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 8)) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  scale_y_continuous(breaks=seq(1, 7, 1), limits = c(4,7)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

lapop2004_2018 %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(ayuda_pobres, formal_estado) %>% 
  group_by(country_f, formal_estado) %>% 
  summarise(media = mean(ayuda_pobres)) %>% 
  ggplot(aes(x=formal_estado, y=media, group=1)) +
  geom_line(size = 0.5) +
  geom_point(aes(y=media), size = 2) +
  labs(title = "Los gobiernos deben gastar más en el combate de la pobreza (media)", 
       y = "Nivel de acuerdo",
       caption = "Elaboración propia en base a LAPOP 2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 8)) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  scale_y_continuous(breaks=seq(1, 7, 1), limits = c(4,7)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)


#impuestos ricos

lapop2004_2018 %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(impuestos_ricos, categoria_ocup_f) %>% 
  group_by(country_f, categoria_ocup_f) %>% 
  summarise(media = mean(impuestos_ricos)) %>% 
  ggplot(aes(x=categoria_ocup_f, y=media, group=1)) +
  geom_line(size = 0.5) +
  geom_point(aes(y=media), size = 2) +
  labs(title = "Los ricos paguen mucho en impuestos pero reciban poco en servicios del Estado (media)", 
       y = "Nivel de acuerdo",
       caption = "Elaboración propia en base a LAPOP 2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 8)) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  scale_y_continuous(breaks=seq(1, 7, 1), limits = c(3,6)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

lapop2004_2018 %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(impuestos_ricos, formal_estado) %>% 
  group_by(country_f, formal_estado) %>% 
  summarise(media = mean(impuestos_ricos)) %>% 
  ggplot(aes(x=formal_estado, y=media, group=1)) +
  geom_line(size = 0.5) +
  geom_point(aes(y=media), size = 2) +
  labs(title = "Los ricos paguen mucho en impuestos pero reciban poco en servicios del Estado (media)", 
       y = "Nivel de acuerdo",
       caption = "Elaboración propia en base a LAPOP 2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 8)) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  scale_y_continuous(breaks=seq(1, 7, 1), limits = c(3,6)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

#Reducción desigualdad

lapop2004_2018 %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(reduc_desigualdad, formal_estado) %>% 
  group_by(country_f, formal_estado) %>% 
  summarise(media = mean(reduc_desigualdad)) %>% 
  ggplot(aes(x=formal_estado, y=media, group=1)) +
  geom_line(size = 0.5) +
  geom_point(aes(y=media), size = 2) +
  labs(title = "Acuerdo con reducción de la desigualdad entre ricos y pobres según categoría laboral por país (media)", 
       subtitle = "Variable reduc_desigualdad sin imputar",
       y = "Aprobación de reducción de la desigualdad",
       caption = "Elaboración propia en base a LAPOP 2008-2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 8)) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  scale_y_continuous(breaks=seq(1, 7, 1), limits = c(4,7)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

#Democracia
lapop2004_2018 %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(democracia7, formal_estado) %>% 
  group_by(country_f, formal_estado) %>% 
  summarise(media = mean(democracia7)) %>% 
  ggplot(aes(x=formal_estado, y=media, group=1)) +
  geom_line(size = 0.5) +
  geom_point(aes(y=media), size = 2) +
  labs(title = "Democracia como mejor forma de gobierno según categoría laboral por país (media)", 
       subtitle = "Variable democracia7 sin imputar",
       caption = "Elaboración propia en base a LAPOP 2008-2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 8)) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  scale_y_continuous(breaks=seq(1, 7, 1), limits = c(4,7)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)


```
