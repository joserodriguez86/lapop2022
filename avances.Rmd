---
title: "Avances Multinivel LAPOP"
author: "José Rodríguez de la Fuente - Gonzalo Assusa"
date: "`r Sys.Date()`"
output: html_document
---

```{r librerias y base, echo=FALSE, warning=FALSE, message=FALSE}
rm(list = ls())

if (!require("pacman")) install.packages("pacman") 

pacman::p_load(tidyverse, kableExtra, GDAtools, FactoMineR, VIM)

load("bases/lapop2004_2018.RData")

# Filtro países
lapop2004_2018 <- lapop2004_2018 %>% 
  filter(country %in% c(1, 8, 11, 13, 14, 15, 17) & wave >= 2008)

```

# Preparación de la base

```{r prepación variables}

#2008-2018
lapop2004_2018$democracia7 <- lapop2004_2018$ing4
lapop2004_2018$democracia_ord <- lapop2004_2018$pn4
lapop2004_2018$reduc_desigualdad <- lapop2004_2018$ros4

lapop2004_2018$country_f <- factor(lapop2004_2018$country, 
                                   labels = c("México", "Colombia", "Perú", 
                                              "Chile", "Uruguay", "Brasil", "Argentina"))

lapop2004_2018$sexo <- factor(lapop2004_2018$q1, labels = c("Varón", "Mujer"))

lapop2004_2018 <- lapop2004_2018 %>% 
  mutate(estatus_ocup = case_when(ocup4a <= 2 & ocup1a == 3 ~ 1,
                                  ocup4a <= 2 & ocup1a %in% c(1,2) ~ 2,
                                  ocup4a <= 2 & ocup1a == 4 ~ 3,
                                  ocup4a == 3 | ocup1a == 5 ~ 4,
                                  ocup4a >= 4 ~ 5),
         estatus_ocup_f = factor(estatus_ocup, labels = c("Patrón", "Asalariado",
                                                          "Cuenta propia", "Desocupado",
                                                          "Inactivo")),
         ing_decil = case_when(wave == 2008 | wave == 2010 ~ q10,
                               wave == 2012 ~ q10new_12,
                               wave == 2014 ~ q10new_14,
                               wave == 2016 ~ q10new_16,
                               wave == 2018 ~ q10new_18))

#2018
lapop2004_2018$desempleados <- lapop2004_2018$redist3
lapop2004_2018$desempleados <- car::recode(lapop2004_2018$desempleados,
                                           "7=1;6=2;5=3;4=4;3=5;2=6;1=7")

lapop2004_2018$ayuda_pobres <- lapop2004_2018$redist1

lapop2004_2018 <- lapop2004_2018 %>% 
  mutate(redist2_inv = car::recode(redist2, "1=7; 2=6; 3=5; 4=4; 5=3; 6=2; 7=1"),
         impuestos_ricos = case_when(country == 8 ~ redist2_inv,
                                     TRUE ~ redist2a),
         urbano = factor(ur, labels = c("Urbano", "Rural")),
         formal_f = factor(formal, labels = c("formal", "informal")))


```


# Casos perdidos variables objetivo

```{r Resumen casos perdidos variables objetivo 2008-2018, echo=FALSE, warning=FALSE, message=FALSE}
print(lapop2004_2018 %>% 
  select(democracia7, reduc_desigualdad) %>% 
  summarytools::dfSummary(plain.ascii  = FALSE, 
          style        = "grid", 
          graph.magnif = 0.75, 
          valid.col    = FALSE),
  method = "render")
```

```{r Casos perdidos democracia7, echo=FALSE, warning=FALSE, message=FALSE}

kable(round(prop.table(table(lapop2004_2018$democracia7, lapop2004_2018$wave, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Democracia 7 categorías x onda") %>% 
  kable_styling()

kable(round(prop.table(table(lapop2004_2018$democracia7, lapop2004_2018$ed, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Democracia 7 categorías x educación") %>% 
  kable_styling()

kable(round(prop.table(table(lapop2004_2018$democracia7, lapop2004_2018$estatus_ocup_f, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Democracia 7 categorías x ocupación") %>% 
  kable_styling()

kable(round(prop.table(table(lapop2004_2018$democracia7, lapop2004_2018$ing_decil, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Democracia 7 categorías x ingresos (decil)") %>% 
  kable_styling()

```


```{r Casos perdidos Desigualdad7, echo=FALSE, warning=FALSE, message=FALSE}
kable(round(prop.table(table(lapop2004_2018$reduc_desigualdad, lapop2004_2018$wave, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Reducción de la desigualdad x onda") %>% 
  kable_styling()

kable(round(prop.table(table(lapop2004_2018$reduc_desigualdad, lapop2004_2018$ed, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Reducción desigualdad x educación") %>% 
  kable_styling()

kable(round(prop.table(table(lapop2004_2018$reduc_desigualdad, lapop2004_2018$estatus_ocup_f,
                             useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Reducción desigualdad x ocupación") %>% 
  kable_styling()

kable(round(prop.table(table(lapop2004_2018$reduc_desigualdad, lapop2004_2018$ing_decil, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Reducción desigualdad x ingresos (decil)") %>% 
  kable_styling()
```


```{r Resumen casos perdidos variables objetivo 2018, echo=FALSE, warning=FALSE, message=FALSE}
lapop2018 <- subset(lapop2004_2018, wave == 2018)

print(lapop2018 %>% 
  select(desempleados, impuestos_ricos, ayuda_pobres) %>% 
  summarytools::dfSummary(plain.ascii  = FALSE, 
          style        = "grid", 
          graph.magnif = 0.75, 
          valid.col    = FALSE),
  method = "render")
```

```{r Casos perdidos Desempleados, echo=FALSE, warning=FALSE, message=FALSE}

kable(round(prop.table(table(lapop2018$desempleados, lapop2018$ed, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Desempleados x educación") %>% 
  kable_styling()

kable(round(prop.table(table(lapop2018$desempleados, lapop2018$estatus_ocup_f,
                             useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Desempleados x ocupación") %>% 
  kable_styling()

kable(round(prop.table(table(lapop2018$desempleados, lapop2018$ing_decil, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Desempleados x ingresos (decil)") %>% 
  kable_styling()
```


```{r Casos perdidos Ayuda pobreza, echo=FALSE, warning=FALSE, message=FALSE}

kable(round(prop.table(table(lapop2018$ayuda_pobres, lapop2018$ed, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Ayuda pobres x educación") %>% 
  kable_styling()

kable(round(prop.table(table(lapop2018$ayuda_pobres, lapop2018$estatus_ocup_f,
                             useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Ayuda pobres x ocupación") %>% 
  kable_styling()

kable(round(prop.table(table(lapop2018$ayuda_pobres, lapop2018$ing_decil, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Ayuda pobres x ingresos (decil)") %>% 
  kable_styling()
```

```{r Casos perdidos impuesto ricos, echo=FALSE, warning=FALSE, message=FALSE}

kable(round(prop.table(table(lapop2018$impuestos_ricos, lapop2018$ed, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Impuestos ricos x educación") %>% 
  kable_styling()

kable(round(prop.table(table(lapop2018$impuestos_ricos, lapop2018$estatus_ocup_f,
                             useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Impuestos ricos x ocupación") %>% 
  kable_styling()

kable(round(prop.table(table(lapop2018$impuestos_ricos, lapop2018$ing_decil, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Impuestos ricos x ingresos (decil)") %>% 
  kable_styling()
```


Se observa que para las variables objetivo de *impuestos*, *ayuda a la pobreza* y *desempleo* no existiría un sesgo importante por parte de los grupos más desfavorecidos en educación, ingresos y trabajo. Por tal motivo, esos casos perdidos pueden ser no considerados en el análisis.  

Se realiza un análisis de correspondencias múltiples para observar el vínculo entre la variable de *democracia* y *reducción de la desigualdad*. De este surge que los grupos más desfavorecidos son los que menos reponden a dichas preguntas. 

```{r Análisis multivariado casos perdidos, echo=FALSE, warning=FALSE, message=FALSE}
lapop2018$ed_f <- factor(lapop2018$ed, labels = c(0:18))
lapop2018$ing_decil_f <- factor(lapop2018$ing_decil, labels = c(0:16))
lapop2018$democracia7_f <- factor(lapop2018$democracia7, labels = c(1:7))
lapop2018$reduc_desigualdad_f <- factor(lapop2018$reduc_desigualdad, labels = c(1:7))
lapop2018$ayuda_pobres_f <- factor(lapop2018$ayuda_pobres, labels = c(1:7))
lapop2018$impuestos_ricos_f <- factor(lapop2018$impuestos_ricos, labels = c(1:7))
lapop2018$desempleados_f <- factor(lapop2018$desempleados, labels = c(1:7))

variables_mca <- lapop2018 %>% 
  select(democracia7_f, reduc_desigualdad_f,
         ed_f, estatus_ocup_f, ing_decil_f)

mca1 <- MCA(variables_mca, ncp = 2, graph = F)

ggcloud_variables(mca1, vlab = F, shapes = T, shapesize = 2, points = "besth")

```

Se opta entonces por imputar a los casos sin respuesta en las variables de *democracia* y *reducción de la desigualdad*, utilizando la técnica de hot deck. Esta realiza una imputación aleatoria, brindándole un valor válido a un caso con valor faltante. Para ello, la imputación se hará al interior de los grupos de ingresos y posteriormente, en el caso los grupos con ingresos faltantes, se utilizará el nivel educativo.

## Imputación variables objetivo

```{r Imputación variables objetivo, results="asis", warning=FALSE}
#1) Random Hot Deck para la variable democracia7 -----

lapop2004_2018$democracia7_imp <- lapop2004_2018$democracia7

set.seed(971986)
lapop2004_2018 <- lapop2004_2018 %>%
  hotdeck(variable = "democracia7_imp",
          domain_var = "ing_decil")

print(lapop2004_2018 %>% 
  select(democracia7, democracia7_imp) %>% 
  summarytools::dfSummary(plain.ascii  = FALSE, 
          style        = "grid", 
          graph.magnif = 0.75, 
          valid.col    = FALSE),
  method = "render")


#2) Random Hot Deck para la variable reduc_desigualdad -----
lapop2004_2018$reduc_desigualdad_imp <- lapop2004_2018$reduc_desigualdad

set.seed(971986)
lapop2004_2018 <- lapop2004_2018 %>%
  hotdeck(variable = "reduc_desigualdad_imp",
          domain_var = "ing_decil")

print(lapop2004_2018 %>% 
  select(reduc_desigualdad, reduc_desigualdad_imp) %>% 
  summarytools::dfSummary(plain.ascii  = FALSE, 
          style        = "grid", 
          graph.magnif = 0.75, 
          valid.col    = FALSE),
  method = "render")

```




```{r Casos perdidos variables predictoras, include=FALSE, eval=FALSE}
kable(round(prop.table(table(lapop2004_2018$l1, lapop2004_2018$wave, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Ideología x onda") %>% 
  kable_styling()


lapop2004_2018 %>% 
  group_by(country_f, wave) %>% 
  summarise(promedio = round(mean(l1, na.rm = T), digits = 2)) %>% 
  pivot_wider(id_cols = country_f, names_from = wave, values_from = promedio) %>% 
  kable() %>% 
  kable_styling()

```

