---
title: "Avances LAPOP"
author: "José Rodríguez de la Fuente - Gonzalo Assusa"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: True
    toc_float: True
    code_folding: hide
---


```{r librerias y base, echo=FALSE, warning=FALSE, message=FALSE}
rm(list = ls())

if (!require("pacman")) install.packages("pacman") 

pacman::p_load(tidyverse, kableExtra, GDAtools, FactoMineR, VIM, janitor, gridExtra,
               janitor, readxl, gtsummary, lme4, texreg, reghelper, nlme, plm, performance,
               sjPlot, jtools, flextable)

load("bases/lapop2004_2018.RData")

# Filtro países
lapop2004_2018 <- lapop2004_2018 %>% 
  filter(country %in% c(1, 8, 11, 13, 14, 15, 17) & wave >= 2008)

#Bases contextuales
paises_desempleo <- read_excel("bases/datos_agregados.xlsx", sheet = "Desempleo")
paises_informalidad <- read_excel("bases/datos_agregados.xlsx", sheet = "Informalidad")
paises_empleopub <- read_excel("bases/datos_agregados.xlsx", sheet = "Empleo público")
paises_brecha <- read_excel("bases/datos_agregados.xlsx", sheet = "Brecha remun")

agregados <- paises_desempleo %>% 
  left_join(paises_informalidad, by = c("country_f", "wave")) %>% 
  left_join(paises_empleopub, by = c("country_f", "wave")) %>% 
  left_join(paises_brecha, by = c("country_f", "wave")) %>% 
  mutate(wave = ifelse(wave == 2013 & country_f != "Chile", 2012, wave),
         wave = case_when(country_f == "Chile" & wave == 2006 ~ 2008,
                          country_f == "Chile" & wave == 2009 ~ 2010,
                          country_f == "Chile" & wave == 2011 ~ 2012,
                          country_f == "Chile" & wave == 2013 ~ 2014,
                          country_f == "Chile" & wave == 2015 ~ 2016,
                          country_f == "Chile" & wave == 2017 ~ 2018,
                          TRUE ~ wave)) %>% 
  filter(wave >= 2008)

```

# Preparación de la base

```{r prepación variables}

#2008-2018
lapop2004_2018$democracia7 <- lapop2004_2018$ing4
lapop2004_2018$democracia_ord <- lapop2004_2018$pn4
lapop2004_2018$reduc_desigualdad <- lapop2004_2018$ros4

lapop2004_2018 <- lapop2004_2018 %>% 
  mutate(voto_pasado = car::recode(vb2, "1=1; 2=0"),
         voto_presente = car::recode(vb20, "1=0; c(2,3,4)=1"))

lapop2004_2018$country_f <- factor(lapop2004_2018$country, 
                                   labels = c("México", "Colombia", "Perú", 
                                              "Chile", "Uruguay", "Brasil", "Argentina"))

lapop2004_2018$sexo <- factor(lapop2004_2018$q1, labels = c("Varón", "Mujer"))

lapop2004_2018 <- lapop2004_2018 %>% 
  mutate(categoria_ocup = case_when((colocup4a <= 2 | ocup4a <= 2) & ocup1a == 3 ~ 1,
                                  (colocup4a <= 2 | ocup4a <= 2) & ocup1a == 1 ~ 2,
                                  (colocup4a <= 2 | ocup4a <= 2) & ocup1a == 2 ~ 3,
                                  (colocup4a <= 2 | ocup4a <= 2) & ocup1a == 4 ~ 4,
                                  (colocup4a == 3 |ocup4a == 3) | ocup1a == 5 ~ 5,
                                  colocup4a >= 4 |ocup4a >= 4 ~ 6),
         categoria_ocup_f = factor(categoria_ocup, labels = c("Patrón", "Asalariado público",
                                                          "Asalariado privado",
                                                          "Cuenta propia", "Desocupado",
                                                          "Inactivo")),
         ing_decil = case_when(wave == 2008 | wave == 2010 ~ q10,
                               wave == 2012 ~ q10new_12,
                               wave == 2014 ~ q10new_14,
                               wave == 2016 ~ q10new_16,
                               wave == 2018 ~ q10new_18),
         ideologia = car::recode(l1, "1=10; 2=9; 3=8; 4=7; 5=6; 6=5; 7=4; 8=3; 9=2; 10=1"))

#2018
lapop2004_2018$desempleados <- lapop2004_2018$redist3
lapop2004_2018$desempleados <- car::recode(lapop2004_2018$desempleados,
                                           "7=1;6=2;5=3;4=4;3=5;2=6;1=7")

lapop2004_2018$ayuda_pobres <- lapop2004_2018$redist1

lapop2004_2018 <- lapop2004_2018 %>%
  mutate(redist2_inv = ifelse(wave == 2018, car::recode(redist2, "1=7; 2=6; 3=5; 4=4; 5=3; 
                                                        6=2; 7=1"), NA),
         impuestos_ricos = ifelse(wave == 2018, case_when(country == 8 ~ redist2_inv,
                                     TRUE ~ redist2a), NA),
         corrup_func = car::recode(exc7, "1:2=0; 3:4=1"),
         corrup_pol = car::recode(exc7new, "1:2=1; 3:5=0"),
         golpe = car::recode(jc13, "2=1; 1=0"),
         cierre_congreso = car::recode(jc15a, "2=1; 1=0"),
         cierre_corte = car::recode(jc16a, "2=1; 1=0"),
         simpatiza_partido = car::recode(vb10, "2=0"),
         urbano = ifelse(wave == 2018, factor(ur, labels = c("Urbano", "Rural")), NA),
         informal = ifelse(wave == 2018, car::recode(formal, "1=0; 2=1"), NA),
         formal_f = ifelse(wave == 2018, factor(formal, labels = c("formal", "informal")), NA),
         formal_estado = factor(ifelse(wave == 2018, case_when(formal == 1 ~ 1,
                                   formal == 2 ~ 2,
                                   categoria_ocup == 5 ~ 3,
                                   categoria_ocup == 6 ~ 4,
                                   TRUE ~ NA_real_), NA)),
         formal_estado = factor(formal_estado, labels = c("Formal", "Informal", "Desocupado",
                                                          "Inactivo")),
         formal_estado2 = factor(ifelse(wave == 2018, case_when(formal == 1 ~ 1,
                                   formal == 2 ~ 2,
                                   categoria_ocup >= 5 ~ 3,
                                   TRUE ~ NA_real_), NA)),
         formal_estado2 = factor(formal_estado2, labels = c("Formal", "Informal", "No ocupados")),
         estatus_ocup = ifelse(wave == 2018, case_when(ocupoit <= 2 ~ 1,
                                  ocupoit > 2 & ocupoit < 4 ~ 2,
                                  ocupoit %in% c(5, 7, 8, 10) ~ 3,
                                  ocupoit %in% c(6, 9) ~ 4,
                                  categoria_ocup >= 5 ~ 5,
                                  TRUE ~ NA_real_), NA),
         estatus_ocup_f = factor(estatus_ocup, labels =
                                                        c("Directivos-Profesionales",
                                                          "Técnicos-administrativos-vendedores",
                                                          "Trabajadores manuales calificados",
                                                          "Trabajadores manuales no calificados",
                                                          "No ocupados")))

#Pegado bases

lapop2004_2018 <- lapop2004_2018 %>% 
  left_join(agregados, by = c("country_f", "wave"))

rm(paises_brecha, paises_desempleo, paises_empleopub, paises_informalidad)
 
```


# Casos perdidos variables objetivo

```{r Resumen casos perdidos variables objetivo 2008-2018, echo=FALSE, warning=FALSE, message=FALSE}
print(lapop2004_2018 %>% 
  select(democracia7, reduc_desigualdad) %>% 
  summarytools::dfSummary(plain.ascii  = FALSE, 
          style        = "grid", 
          graph.magnif = 0.75, 
          valid.col    = FALSE),
  method = "render")
```

```{r Casos perdidos democracia7, echo=FALSE, warning=FALSE, message=FALSE}

kable(round(prop.table(table(lapop2004_2018$democracia7, lapop2004_2018$wave, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Democracia 7 categorías x onda") %>% 
  kable_styling()

kable(round(prop.table(table(lapop2004_2018$democracia7, lapop2004_2018$ed, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Democracia 7 categorías x educación") %>% 
  kable_styling()

kable(round(prop.table(table(lapop2004_2018$democracia7, lapop2004_2018$categoria_ocup_f, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Democracia 7 categorías x ocupación") %>% 
  kable_styling()

kable(round(prop.table(table(lapop2004_2018$democracia7, lapop2004_2018$ing_decil, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Democracia 7 categorías x ingresos (decil)") %>% 
  kable_styling()

```

```{r Casos perdidos Desigualdad7, echo=FALSE, warning=FALSE, message=FALSE}
kable(round(prop.table(table(lapop2004_2018$reduc_desigualdad, lapop2004_2018$wave, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Reducción de la desigualdad x onda") %>% 
  kable_styling()

kable(round(prop.table(table(lapop2004_2018$reduc_desigualdad, lapop2004_2018$ed, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Reducción desigualdad x educación") %>% 
  kable_styling()

kable(round(prop.table(table(lapop2004_2018$reduc_desigualdad, lapop2004_2018$categoria_ocup_f,
                             useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Reducción desigualdad x ocupación") %>% 
  kable_styling()

kable(round(prop.table(table(lapop2004_2018$reduc_desigualdad, lapop2004_2018$ing_decil, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Reducción desigualdad x ingresos (decil)") %>% 
  kable_styling()
```

```{r Resumen casos perdidos variables objetivo 2018, echo=FALSE, warning=FALSE, message=FALSE}
lapop2018 <- subset(lapop2004_2018, wave == 2018)

print(lapop2018 %>% 
  select(desempleados, impuestos_ricos, ayuda_pobres) %>% 
  summarytools::dfSummary(plain.ascii  = FALSE, 
          style        = "grid", 
          graph.magnif = 0.75, 
          valid.col    = FALSE),
  method = "render")
```

```{r Casos perdidos Desempleados, echo=FALSE, warning=FALSE, message=FALSE}

kable(round(prop.table(table(lapop2018$desempleados, lapop2018$ed, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Desempleados x educación") %>% 
  kable_styling()

kable(round(prop.table(table(lapop2018$desempleados, lapop2018$categoria_ocup_f,
                             useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Desempleados x ocupación") %>% 
  kable_styling()

kable(round(prop.table(table(lapop2018$desempleados, lapop2018$ing_decil, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Desempleados x ingresos (decil)") %>% 
  kable_styling()
```

```{r Casos perdidos Ayuda pobreza, echo=FALSE, warning=FALSE, message=FALSE}

kable(round(prop.table(table(lapop2018$ayuda_pobres, lapop2018$ed, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Ayuda pobres x educación") %>% 
  kable_styling()

kable(round(prop.table(table(lapop2018$ayuda_pobres, lapop2018$categoria_ocup_f,
                             useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Ayuda pobres x ocupación") %>% 
  kable_styling()

kable(round(prop.table(table(lapop2018$ayuda_pobres, lapop2018$ing_decil, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Ayuda pobres x ingresos (decil)") %>% 
  kable_styling()
```

```{r Casos perdidos impuesto ricos, echo=FALSE, warning=FALSE, message=FALSE}

kable(round(prop.table(table(lapop2018$impuestos_ricos, lapop2018$ed, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Impuestos ricos x educación") %>% 
  kable_styling()

kable(round(prop.table(table(lapop2018$impuestos_ricos, lapop2018$categoria_ocup_f,
                             useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Impuestos ricos x ocupación") %>% 
  kable_styling()

kable(round(prop.table(table(lapop2018$impuestos_ricos, lapop2018$ing_decil, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Impuestos ricos x ingresos (decil)") %>% 
  kable_styling()
```


Se observa que para las variables objetivo de *impuestos*, *ayuda a la pobreza* y *desempleo* no existiría un sesgo importante por parte de los grupos más desfavorecidos en educación, ingresos y trabajo. Por tal motivo, esos casos perdidos pueden ser no considerados en el análisis.  

Se realiza un análisis de correspondencias múltiples para observar el vínculo entre la variable de *democracia* y *reducción de la desigualdad*. De este surge que los grupos más desfavorecidos son los que menos reponden a dichas preguntas. 

```{r Análisis multivariado casos perdidos, echo=FALSE, warning=FALSE, message=FALSE}
lapop2018$ed_f <- factor(lapop2018$ed, labels = c(0:18))
lapop2018$ing_decil_f <- factor(lapop2018$ing_decil, labels = c(0:16))
lapop2018$democracia7_f <- factor(lapop2018$democracia7, labels = c(1:7))
lapop2018$reduc_desigualdad_f <- factor(lapop2018$reduc_desigualdad, labels = c(1:7))
lapop2018$ayuda_pobres_f <- factor(lapop2018$ayuda_pobres, labels = c(1:7))
lapop2018$impuestos_ricos_f <- factor(lapop2018$impuestos_ricos, labels = c(1:7))
lapop2018$desempleados_f <- factor(lapop2018$desempleados, labels = c(1:7))

variables_mca <- lapop2018 %>% 
  select(democracia7_f, reduc_desigualdad_f,
         ed_f, categoria_ocup_f, ing_decil_f)

mca1 <- MCA(variables_mca, ncp = 2, graph = F)

ggcloud_variables(mca1, vlab = F, shapes = T, shapesize = 2, points = "besth")

```

Se opta entonces por imputar a los casos sin respuesta en las variables de *democracia* y *reducción de la desigualdad*, utilizando la técnica de hot deck. Esta realiza una imputación aleatoria, brindándole un valor válido a un caso con valor faltante. Para ello, la imputación se hará al interior de los grupos de ingresos y posteriormente, en el caso los grupos con ingresos faltantes, se utilizará el nivel educativo.

## Imputación variables objetivo

```{r Imputación variables objetivo, results="asis", warning=FALSE}
#1) Random Hot Deck para la variable democracia7 -----

lapop2004_2018$democracia7_imp <- lapop2004_2018$democracia7

set.seed(971986)
lapop2004_2018 <- lapop2004_2018 %>%
  hotdeck(variable = "democracia7_imp",
          domain_var = "ing_decil",
          imp_suffix = "check")

print(lapop2004_2018 %>% 
  select(democracia7, democracia7_imp) %>% 
  summarytools::dfSummary(plain.ascii  = FALSE, 
          style        = "grid", 
          graph.magnif = 0.75, 
          valid.col    = FALSE),
  method = "render")


#2) Random Hot Deck para la variable reduc_desigualdad -----
lapop2004_2018$reduc_desigualdad_imp <- lapop2004_2018$reduc_desigualdad

set.seed(971986)
lapop2004_2018 <- lapop2004_2018 %>%
  hotdeck(variable = "reduc_desigualdad_imp",
          domain_var = "ing_decil",
          imp_suffix = "check")

print(lapop2004_2018 %>% 
  select(reduc_desigualdad, reduc_desigualdad_imp) %>% 
  summarytools::dfSummary(plain.ascii  = FALSE, 
          style        = "grid", 
          graph.magnif = 0.75, 
          valid.col    = FALSE),
  method = "render")

```

# Casos perdidos variables predictoras

```{r Casos perdidos variables predictoras, results="asis", warning=FALSE}

print(lapop2004_2018 %>% 
  select(ideologia) %>% 
  summarytools::dfSummary(plain.ascii  = FALSE, 
          style        = "grid", 
          graph.magnif = 0.75, 
          valid.col    = FALSE),
  method = "render")


kable(round(prop.table(table(lapop2004_2018$ideologia, lapop2004_2018$wave, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Ideología x onda") %>% 
  kable_styling()

kable(round(prop.table(table(lapop2004_2018$ideologia, lapop2004_2018$ing_decil, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Ideología x ingreso") %>% 
  kable_styling()

kable(round(prop.table(table(lapop2004_2018$ideologia, lapop2004_2018$ed, 
                 useNA = "always"), margin = 2)*100, digits = 2),
      format = "html", caption = "Ideología x educacion") %>% 
  kable_styling()

#MCA
lapop2004_2018$ed_f <- factor(lapop2004_2018$ed, labels = c(0:18))
lapop2004_2018$ing_decil_f <- factor(lapop2004_2018$ing_decil, labels = c(0:16))
lapop2004_2018$ideologia_f <- factor(lapop2004_2018$ideologia, labels = c(1:10))

variables_mca <- lapop2004_2018 %>% 
  select(ideologia_f, ed_f, categoria_ocup_f, ing_decil_f)

mca2 <- MCA(variables_mca, ncp = 2, graph = F)

ggcloud_variables(mca2, vlab = F, shapes = T, shapesize = 2, points = "besth")

```

Los casos perdidos en la variable *ideología* se encuentran muy asociaciados al nivel educativo bajo y a los ingresos bajos. Nuevamente, como en el caso de las variables objetivo, lo mejor sería imputarlas según nivel económico, ya que está relacionada y no formará parte del modelo de regresión.

```{r Imputación ideologia, echo=FALSE, warning=FALSE, message=FALSE}
#Random Hot Deck para la variable ideologia -----

lapop2004_2018$ideologia_imp <- lapop2004_2018$ideologia

set.seed(971986)
lapop2004_2018 <- lapop2004_2018 %>%
  hotdeck(variable = "ideologia_imp",
          domain_var = "ing_decil",
          imp_suffix = "check")

print(lapop2004_2018 %>% 
  select(ideologia, ideologia_imp) %>% 
  summarytools::dfSummary(plain.ascii  = FALSE, 
          style        = "grid", 
          graph.magnif = 0.75, 
          valid.col    = FALSE),
  method = "render")
```

# Problema variable Tranferencias Condicionadas 

```{r Transferencias condicionadas, echo=FALSE, warning=FALSE, message=FALSE}
kable(lapop2004_2018 %>% 
  filter(wave == 2016 & country_f %in% "Chile") %>% 
  group_by(wf1, cct1b) %>% 
  tally() %>% 
  pivot_wider(id_cols = wf1, names_from = cct1b, values_from = n) %>%
  adorn_totals(where = c("row", "col")) %>% 
  adorn_percentages(denominator = "col") %>% 
  adorn_pct_formatting(digits = 1),
  format = "html", 
  caption = "Ayuda gobierno x Transferencias condicionadas. Chile 2016.") %>% 
  kable_styling()

kable(lapop2004_2018 %>% 
  filter(wave == 2016) %>% 
  group_by(wf1, cct1b) %>% 
  tally() %>% 
  pivot_wider(id_cols = wf1, names_from = cct1b, values_from = n) %>%
  adorn_totals(where = c("row", "col")) %>% 
  adorn_percentages(denominator = "col") %>% 
  adorn_pct_formatting(digits = 1),
  format = "html", 
  caption = "Ayuda gobierno x Transferencias condicionadas. Todos los países 2016.") %>% 
  kable_styling()


```

Las variables de *Ayuda económica del gobierno* y *Transferencias condicionadas* parecieran no apuntar a lo mismo. Del total de familias que recibió transferencias condicionadas, solo un 35,5% indicó declarar que recibió ayuda económica del gobierno. 


# Descriptivos

## Tablas resumen 

```{r tablas, echo=FALSE, warning=FALSE, message=FALSE, results='asis'}
variables_seleccion <- lapop2004_2018 %>% 
  select(democracia7, reduc_desigualdad, voto_pasado, voto_presente, desempleados, 
         ayuda_pobres, impuestos_ricos, corrup_func, golpe, cierre_congreso,
         cierre_corte, simpatiza_partido,
         categoria_ocup_f, formal_estado, estatus_ocup_f,
         ideologia_imp, sexo, q2, ed, urbano, desempleo, informalidad, empleo_publico,
         brecha_remun, country_f, wave)

variables_seleccion$informalidad <- variables_seleccion$informalidad * 100
variables_seleccion$desempleo <- variables_seleccion$desempleo * 100
variables_seleccion$empleo_publico <- variables_seleccion$empleo_publico * 100
variables_seleccion$brecha_remun <- variables_seleccion$brecha_remun * 100

theme_gtsummary_language("es")

variables_seleccion %>%
  tbl_summary(by = wave,
              type = list(c(democracia7, reduc_desigualdad, 
                          desempleados, ayuda_pobres,
                          impuestos_ricos) ~ "continuous"),
              label = c(democracia7 ~ "Acuerdo con democracia",
                           reduc_desigualdad ~ "Acuerdo con políticas de 
                           reducción de desigualdad", 
                        voto_pasado ~ "Voto pasado",
                        voto_presente ~ "Voto presente",
                          desempleados ~ "Desempleo como fenómeno voluntario",
                          ayuda_pobres ~ "Los gobiernos deben invertir en ayudar 
                          a los pobres",
                          impuestos_ricos ~ "Injusto que los ricos paguen altos
                          impuestos",
                        corrup_func ~ "Generalización corrupción",
                        golpe ~ "Golpe militar por corrupción",
                        cierre_congreso ~ "Aprobación de cierre del congreso",
                        cierre_corte ~ "Aprobación de cierre de la corte",
                        simpatiza_partido ~ "Simpatía por partido político",
                          categoria_ocup_f ~ "Categoría ocupacional",
                          formal_estado ~ "Formalidad",
                          estatus_ocup_f ~ "Estatus ocupacional",
                          ideologia_imp ~ "Ideología (der-izq)",
                          sexo ~ "Sexo",
                          q2 ~ "Edad",
                          ed ~ "Años educativos",
                          urbano ~ "Región",
                          desempleo ~ "Nivel de desempleo",
                          informalidad ~ "Nivel de informalidad",
                          empleo_publico ~ "Nivel de empleo público",
                          brecha_remun ~ "Brecha informales / asalariados reg.",
                          country_f ~ "País"
                          ),
                 statistic = list(all_continuous() ~ "{mean} ({sd})", 
                                  all_categorical() ~ "{n} ({p}%)"),
                 digits = list(all_categorical() ~ c(0, 1)),
  							 missing = "no") %>% 
  add_overall(col_label = "**Total**", last = TRUE) 

tabla_resumen <- variables_seleccion %>%
  tbl_summary(by = wave,
              type = list(c(democracia7, reduc_desigualdad, 
                          desempleados, ayuda_pobres,
                          impuestos_ricos) ~ "continuous"),
              label = c(democracia7 ~ "Acuerdo con democracia",
                           reduc_desigualdad ~ "Acuerdo con políticas de 
                           reducción de desigualdad", 
                        voto_pasado ~ "Voto pasado",
                        voto_presente ~ "Voto presente",
                          desempleados ~ "Desempleo como fenómeno voluntario",
                          ayuda_pobres ~ "Los gobiernos deben invertir en ayudar 
                          a los pobres",
                          impuestos_ricos ~ "Injusto que los ricos paguen altos
                          impuestos",
                        corrup_func ~ "Generalización corrupción",
                        golpe ~ "Golpe militar por corrupción",
                        cierre_congreso ~ "Aprobación de cierre del congreso",
                        cierre_corte ~ "Aprobación de cierre de la corte",
                        simpatiza_partido ~ "Simpatía por partido político",
                          categoria_ocup_f ~ "Categoría ocupacional",
                          formal_estado ~ "Formalidad",
                          estatus_ocup_f ~ "Estatus ocupacional",
                          ideologia_imp ~ "Ideología (der-izq)",
                          sexo ~ "Sexo",
                          q2 ~ "Edad",
                          ed ~ "Años educativos",
                          urbano ~ "Región",
                          desempleo ~ "Nivel de desempleo",
                          informalidad ~ "Nivel de informalidad",
                          empleo_publico ~ "Nivel de empleo público",
                          brecha_remun ~ "Brecha informales / asalariados reg.",
                          country_f ~ "País"
                          ),
                 statistic = list(all_continuous() ~ "{mean} ({sd})", 
                                  all_categorical() ~ "{n} ({p}%)"),
                 digits = list(all_categorical() ~ c(0, 1)),
  							 missing = "no") %>% 
  add_overall(col_label = "**Total**", last = TRUE) %>% 
  as_flex_table()

flextable::save_as_docx(tabla_resumen, path = "salidas/tabla_resumen.docx")


```


## Boxplot y gráficos de medias (año y país)  

```{r Análisis de boxplot por año y país democracia, echo=FALSE, warning=FALSE, message=FALSE}

lapop2004_2018 %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(democracia7) %>%
  ggplot(aes(x=as.factor(wave), y=democracia7, fill = country_f)) +
  geom_boxplot(outlier.shape = NA, show.legend = FALSE) +
  labs(title = "Democracia como mejor forma de gobierno por año y país", 
       y = "Aprobación de la democracia",
       caption = "Elaboración propia en base a LAPOP 2008-2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 8),
        axis.text.y = element_text(size = 8)) +
  scale_y_continuous(breaks=seq(1, 7, 1)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/boxplot_democracia.png", dpi = 300, type = "cairo", width = 8, height = 6)

lapop2004_2018 %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(democracia7) %>%
  group_by(country_f, wave) %>% 
  summarise(media = mean(democracia7)) %>% 
  ggplot(aes(x=as.factor(wave), y=media, group = 1)) +
  geom_line(size = 0.5) +
  geom_point(aes(y=media), size = 2) +
  labs(title = "Democracia como mejor forma de gobierno por año y país", 
       y = "Aprobación de la democracia",
       caption = "Elaboración propia en base a LAPOP 2008-2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 8),
        axis.text.y = element_text(size = 8)) +
  scale_y_continuous(breaks=seq(1, 7, 1), limits = c(4,7)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/medias_democracia.png", dpi = 300, type = "cairo", width = 8, height = 6)


```

```{r Análisis de boxplot por año y país reducción de la desigualdad, echo=FALSE, warning=FALSE, message=FALSE}

lapop2004_2018 %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(reduc_desigualdad) %>% 
  ggplot(aes(x=as.factor(wave), y=reduc_desigualdad, fill= country_f)) +
  geom_boxplot(outlier.shape = NA, show.legend = FALSE) +
  labs(title = "Acuerdo con reducción de la desigualdad entre ricos y pobres por año y país", 
       y = "Aprobación de reducción de la desigualdad",
       caption = "Elaboración propia en base a LAPOP 2008-2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 8),
        axis.text.y = element_text(size = 8)) +
  scale_y_continuous(breaks=seq(1, 7, 1)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/boxplot_desigualdad.png", dpi = 300, type = "cairo", width = 8, height = 6)


lapop2004_2018 %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(reduc_desigualdad) %>%
  group_by(country_f, wave) %>% 
  summarise(media = mean(reduc_desigualdad)) %>% 
  ggplot(aes(x=as.factor(wave), y=media, group = 1)) +
  geom_line(size = 0.5) +
  geom_point(aes(y=media), size = 2) +
  labs(title = "Acuerdo con reducción de la desigualdad entre ricos y pobres por año y país", 
       y = "Aprobación de reducción de la desigualdad",
       caption = "Elaboración propia en base a LAPOP 2008-2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 8),
        axis.text.y = element_text(size = 8)) +
  scale_y_continuous(breaks=seq(1, 7, 1), limits = c(4,7)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/medias_desigualdad.png", dpi = 300, type = "cairo", width = 8, height = 6)


```


```{r Análisis barras por año y país voto pasado, echo=FALSE, warning=FALSE, message=FALSE}

lapop2004_2018 %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(voto_pasado) %>%
  group_by(country_f, wave, voto_pasado) %>% 
  tally() %>%
  group_by(country_f, wave) %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  ggplot(aes(x=as.factor(wave), y=porcentaje, fill= as.factor(voto_pasado))) +
  geom_col() +
  scale_fill_discrete(labels=c('No', 'Si'))+
  labs(title = "Voto en elecciones pasadas por año y país", 
       caption = "Elaboración propia en base a LAPOP 2008-2018",
       fill = "Voto") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7),
        axis.text.y = element_text(size = 7)) +
  scale_y_continuous(labels= scales::percent_format(accuracy = 1L), 
                     breaks=seq(0, 1, 0.2)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/barras_voto_pasado.png", dpi = 300, type = "cairo", width = 8, height = 6)


```


```{r Análisis barras por año y país voto presente, echo=FALSE, warning=FALSE, message=FALSE}

lapop2004_2018 %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(voto_presente) %>%
  group_by(country_f, wave, voto_presente) %>% 
  tally() %>%
  group_by(country_f, wave) %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  ggplot(aes(x=as.factor(wave), y=porcentaje, fill= as.factor(voto_presente))) +
  geom_col() +
  scale_fill_discrete(labels=c('No', 'Si'))+
  labs(title = "Voto en elecciones presentes por año y país", 
       caption = "Elaboración propia en base a LAPOP 2008-2018",
       fill = "Voto") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7),
        axis.text.y = element_text(size = 7)) +
  scale_y_continuous(labels= scales::percent_format(accuracy = 1L), 
                     breaks=seq(0, 1, 0.2)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/barras_voto_presente.png", dpi = 300, type = "cairo", width = 8, height = 6)


```

## Boxplot 2018  

```{r Análisis de boxplot 2018, echo=FALSE, warning=FALSE, message=FALSE}

desempleados <- lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(desempleados) %>%
  ggplot(aes(x=fct_relevel(country_f, "Total", after = Inf), y=desempleados, 
             fill= country_f)) +
  geom_boxplot(outlier.shape = NA, show.legend = FALSE) +
  stat_summary(fun.y = mean, geom ="point", aes(group = 1), show.legend = F) +
  stat_summary(fun.y = mean, geom = "line", linetype = "dotted", aes(group = 1)) +
  labs(title = "Los desempleados no pueden encontrar \ntrabajo solo por su voluntad", 
       y = "Nivel de acuerdo") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 8),
        axis.text.y = element_text(size = 8)) +
  scale_y_continuous(breaks=seq(1, 7, 1))

ayuda_pobres <- lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(ayuda_pobres) %>% 
  ggplot(aes(x=fct_relevel(country_f, "Total", after = Inf), y=ayuda_pobres, fill= country_f)) +
  geom_boxplot(outlier.shape = NA, show.legend = FALSE) +
  stat_summary(fun.y = mean, geom ="point", aes(group = 1), show.legend = F) +
  stat_summary(fun.y = mean, geom = "line", linetype = "dotted", aes(group = 1)) +
  labs(title = "Los gobiernos deben gastar más en el \ncombate de la pobreza", 
       y = "Nivel de acuerdo") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 8),
        axis.text.y = element_text(size = 8)) +
  scale_y_continuous(breaks=seq(1, 7, 1))

impuestos_ricos <- lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(ayuda_pobres) %>% 
  ggplot(aes(x=fct_relevel(country_f, "Total", after = Inf), 
             y=impuestos_ricos, fill= country_f)) +
  geom_boxplot(outlier.shape = NA, show.legend = FALSE) +
  stat_summary(fun.y = mean, geom ="point", aes(group = 1), show.legend = F) +
  stat_summary(fun.y = mean, geom = "line", linetype = "dotted", aes(group = 1)) +
  labs(title = "Los ricos paguen mucho en impuestos pero \nreciban poco en servicios del Estado", 
       y = "Nivel de acuerdo") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 8),
        axis.text.y = element_text(size = 8)) +
  scale_y_continuous(breaks=seq(1, 7, 1))

boxplot_objetivo2018 <- grid.arrange(desempleados, ayuda_pobres, impuestos_ricos, nrow = 2,
             bottom = textGrob("Fuente: elaboración propia en base a LAPOP 2018",
                               gp = gpar(fontsize = 9),
                               hjust = 1.1, 
                               x = 1))



ggsave(filename = "salidas/boxplot_objetivo2018.png", dpi = 300, type = "cairo", width = 8, height = 6,
       boxplot_objetivo2018)


lapop2004_2018 %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  filter(wave == 2018) %>% 
  drop_na(corrup_func) %>%
  group_by(country_f, wave, corrup_func) %>% 
  tally() %>%
  group_by(country_f, wave) %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  ggplot(aes(x=fct_relevel(country_f, "Total", after = Inf), y=porcentaje, 
             fill= as.factor(corrup_func))) +
  geom_col() +
  scale_fill_discrete(labels=c('Generalizado', 'No generalizado'))+
  labs(title = "Nivel de corrupción de los funcionarios públicos", 
       caption = "Elaboración propia en base a LAPOP 2018",
       fill = "Nivel de corrupción") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 8),
        axis.text.y = element_text(size = 8)) +
  scale_y_continuous(labels= scales::percent_format(accuracy = 1L), 
                     breaks=seq(0, 1, 0.2)) 

ggsave(filename = "salidas/barras_corrupcion.png", dpi = 300, type = "cairo", width = 8, height = 6)


lapop2004_2018 %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  filter(wave == 2018) %>% 
  drop_na(golpe) %>%
  group_by(country_f, wave, golpe) %>% 
  tally() %>%
  group_by(country_f, wave) %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  ggplot(aes(x=fct_relevel(country_f, "Total", after = Inf), y=porcentaje, 
             fill= as.factor(golpe))) +
  geom_col() +
  scale_fill_discrete(labels=c('Justifica', 'No justifica'))+
  labs(title = "Justificación de golpe militar ante mucha corrupción", 
       caption = "Elaboración propia en base a LAPOP 2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 8),
        axis.text.y = element_text(size = 8),
        legend.title = element_blank()) +
  scale_y_continuous(labels= scales::percent_format(accuracy = 1L), 
                     breaks=seq(0, 1, 0.2)) 

ggsave(filename = "salidas/barras_golpe.png", dpi = 300, type = "cairo", width = 8, height = 6)

lapop2004_2018 %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  filter(wave == 2018) %>% 
  drop_na(cierre_congreso) %>%
  group_by(country_f, wave, cierre_congreso) %>% 
  tally() %>%
  group_by(country_f, wave) %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  ggplot(aes(x=fct_relevel(country_f, "Total", after = Inf), y=porcentaje, 
             fill= as.factor(cierre_congreso))) +
  geom_col() +
  scale_fill_discrete(labels=c('No justifica', 'Justifica'))+
  labs(title = "Justificación de cierre de congreso en momentos difíciles del país", 
       caption = "Elaboración propia en base a LAPOP 2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 8),
        axis.text.y = element_text(size = 8),
        legend.title = element_blank()) +
  scale_y_continuous(labels= scales::percent_format(accuracy = 1L), 
                     breaks=seq(0, 1, 0.2)) 

ggsave(filename = "salidas/barras_cierre_congreso.png", dpi = 300, type = "cairo", width = 8, height = 6)

lapop2004_2018 %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  filter(wave == 2018) %>% 
  drop_na(cierre_corte) %>%
  group_by(country_f, wave, cierre_corte) %>% 
  tally() %>%
  group_by(country_f, wave) %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  ggplot(aes(x=fct_relevel(country_f, "Total", after = Inf), y=porcentaje, 
             fill= as.factor(cierre_corte))) +
  geom_col() +
  scale_fill_discrete(labels=c('Justifica', 'No justifica'))+
  labs(title = "Justificación de disolución de corte suprema de justicia en 
       momentos difíciles", 
       caption = "Elaboración propia en base a LAPOP 2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 8),
        axis.text.y = element_text(size = 8),
        legend.title = element_blank()) +
  scale_y_continuous(labels= scales::percent_format(accuracy = 1L), 
                     breaks=seq(0, 1, 0.2)) 

ggsave(filename = "salidas/barras_cierre_corte.png", dpi = 300, type = "cairo", width = 8, height = 6)


lapop2004_2018 %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  filter(wave == 2018) %>% 
  drop_na(simpatiza_partido) %>%
  group_by(country_f, wave, simpatiza_partido) %>% 
  tally() %>%
  group_by(country_f, wave) %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  ggplot(aes(x=fct_relevel(country_f, "Total", after = Inf), y=porcentaje, 
             fill= as.factor(simpatiza_partido))) +
  geom_col() +
  scale_fill_discrete(labels=c('Simpatiza', 'No simpatiza'))+
  labs(title = "Simpatía con algún partido político", 
       caption = "Elaboración propia en base a LAPOP 2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 8),
        axis.text.y = element_text(size = 8),
        legend.title = element_blank()) +
  scale_y_continuous(labels= scales::percent_format(accuracy = 1L), 
                     breaks=seq(0, 1, 0.2)) 

ggsave(filename = "salidas/barras_simpatia.png", dpi = 300, type = "cairo", width = 8, height = 6)

```


# Descriptivos variables independientes 

```{r Barras variable laboral, echo=FALSE, warning=FALSE, message=FALSE}
lapop2004_2018 %>%
  drop_na(categoria_ocup_f) %>% 
  group_by(country_f, wave, categoria_ocup_f) %>% 
  tally() %>%
  group_by(country_f, wave) %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  ggplot(aes(x=as.factor(wave), y=porcentaje, fill= categoria_ocup_f)) +
  geom_col() +
  labs(title = "Categorías laborales por año y país", 
       caption = "Elaboración propia en base a LAPOP 2008-2018",
       fill = "Categorías laborales") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7),
        axis.text.y = element_text(size = 7)) +
  scale_y_continuous(labels= scales::percent_format(accuracy = 1L), 
                     breaks=seq(0, 1, 0.2)) +
  facet_wrap(~country_f, ncol = 3)

ggsave(filename = "salidas/categoria_laboral.png", dpi = 300, type = "cairo", width = 8, height = 6)


```

```{r Barras informalidad, echo=FALSE, warning=FALSE, message=FALSE}

lapop2004_2018 %>%
  filter(wave==2018) %>%
  group_by(country_f) %>% 
  summarise(informal_lapop = mean(informal, na.rm = T)*100,
            informal_ext = mean(informalidad)*100) %>% 
  pivot_longer(!country_f, names_to = "tipo",
               values_to = "porcentaje") %>% 
  ggplot(aes(x=country_f, y=porcentaje, fill= tipo)) +
  geom_bar(stat = "identity", position="dodge") +
  geom_text(aes(label = round(porcentaje, digits = 2), y = porcentaje + 1),
            position = position_dodge(.9), vjust = 0, size = 3) +
  labs(title = "Informalidad por país",
       caption = "Elaboración propia en base a LAPOP 2018 y encuestas de hogares",
       fill = "Tipo de fuente",
       y = "Porcentaje") +
  theme(plot.title = element_text(size = 12, face = "bold"),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 10),
        axis.text.x = element_text(size = 8),
        axis.text.y = element_text(size = 8)) +
  scale_y_continuous(breaks=seq(0, 100, 10)) +
  scale_fill_discrete(labels = c("Informalidad LAPOP", 
                                 "Informalidad fuentes \nexternas"))

ggsave(filename = "salidas/informalidad.png", dpi = 300, type = "cairo", width = 8, height = 6)



```


# Cruces variable laboral y variables objetivo 2008-2018

```{r Cruce variable laboral y democracia, echo=FALSE, warning=FALSE, message=FALSE}

lapop2004_2018 %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(democracia7, categoria_ocup_f) %>% 
  ggplot(aes(x=categoria_ocup_f, y=democracia7, fill= country_f)) +
  geom_boxplot(outlier.shape = NA, show.legend = FALSE) +
  labs(title = "Democracia como mejor forma de gobierno según categoría laboral por país", 
       caption = "Elaboración propia en base a LAPOP 2008-2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 8)) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  scale_y_continuous(breaks=seq(1, 7, 1)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/boxplot_democracia_categoria.png", dpi = 300, type = "cairo", width = 8, height = 6)


lapop2004_2018 %>%
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(democracia7, categoria_ocup_f) %>% 
  group_by(country_f, categoria_ocup_f) %>% 
  summarise(media = mean(democracia7)) %>% 
  ggplot(aes(x=categoria_ocup_f, y=media, group=1)) +
  geom_line(size = 0.5) +
  geom_point(aes(y=media), size = 2) +
  labs(title = "Democracia como mejor forma de gobierno según categoría laboral por país (media)", 
       subtitle = "Variable democracia7 sin imputar",
       caption = "Elaboración propia en base a LAPOP 2008-2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 8)) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  scale_y_continuous(breaks=seq(1, 7, 1), limits = c(4,7)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/medias_democracia_categoria.png", dpi = 300, type = "cairo", width = 8, height = 6)

lapop2004_2018 %>% 
  drop_na(categoria_ocup_f, democracia7) %>% 
  group_by(categoria_ocup_f, democracia7) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "categoria_ocup_f", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  kbl() %>%
  kable_styling()

lapop2004_2018 %>% 
  drop_na(categoria_ocup_f, democracia7) %>% 
  group_by(categoria_ocup_f, democracia7) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "categoria_ocup_f", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  flextable() %>% 
  save_as_docx(path = "salidas/democracia_catlaboral.docx")
  
  
```


```{r Cruce variable laboral y reducción de la desigualdad, echo=FALSE, warning=FALSE, message=FALSE}

lapop2004_2018 %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(reduc_desigualdad, categoria_ocup_f) %>% 
  ggplot(aes(x=categoria_ocup_f, y=reduc_desigualdad, fill= country_f)) +
  geom_boxplot(outlier.shape = NA, show.legend = FALSE) +
  labs(title = "Acuerdo con reducción de la desigualdad entre ricos y pobres según categoría laboral por país", 
       subtitle = "Variable reduc_desigualdad sin imputar",
       y = "Aprobación de reducción de la desigualdad",
       caption = "Elaboración propia en base a LAPOP 2008-2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 8)) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  scale_y_continuous(breaks=seq(1, 7, 1)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/boxplot_desigualdad_categoria.png", dpi = 300, type = "cairo", width = 8, height = 6)

lapop2004_2018 %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(reduc_desigualdad, categoria_ocup_f) %>% 
  group_by(country_f, categoria_ocup_f) %>% 
  summarise(media = mean(reduc_desigualdad), sd = sqrt(var(reduc_desigualdad)), 
            se = sd / sqrt(length(reduc_desigualdad))) %>% 
  ggplot(aes(x=categoria_ocup_f, y=media, group=1)) +
  geom_line(size = 0.5) +
  geom_point(aes(y=media), size = 2) +
  labs(title = "Acuerdo con reducción de la desigualdad entre ricos y pobres según categoría laboral por país (media)", 
       subtitle = "Variable reduc_desigualdad sin imputar",
       y = "Aprobación de reducción de la desigualdad",
       caption = "Elaboración propia en base a LAPOP 2008-2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 8)) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  scale_y_continuous(breaks=seq(1, 7, 1), limits = c(4,7)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/medias_desigualdad_categoria.png", dpi = 300, type = "cairo", width = 8, height = 6)

lapop2004_2018 %>% 
  drop_na(categoria_ocup_f, reduc_desigualdad) %>% 
  group_by(categoria_ocup_f, reduc_desigualdad) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "categoria_ocup_f", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  flextable() %>% 
  save_as_docx(path = "salidas/desigualdad_catlaboral.docx")

lapop2004_2018 %>% 
  drop_na(categoria_ocup_f, reduc_desigualdad) %>% 
  group_by(categoria_ocup_f, reduc_desigualdad) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "categoria_ocup_f", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  kbl() %>%
  kable_styling()

```


```{r Cruce variable laboral y voto pasado, echo=FALSE, warning=FALSE, message=FALSE}

lapop2004_2018 %>%
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(voto_pasado, categoria_ocup_f) %>% 
  group_by(country_f, categoria_ocup_f) %>% 
  summarise(media = mean(voto_pasado)*100) %>% 
  ggplot(aes(x=categoria_ocup_f, y=media, group=1)) +
  geom_line(size = 0.5) +
  geom_point(aes(y=media), size = 2) +
  labs(title = "Voto en elecciones pasadas según categoría laboral por país (media)", 
       caption = "Elaboración propia en base a LAPOP 2008-2018",
       y = "Porcentaje") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 6, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 8)) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/porcentaje_votopasado_categoria.png", dpi = 300, type = "cairo", width = 8, height = 6)


lapop2004_2018 %>% 
  drop_na(categoria_ocup_f, voto_pasado) %>% 
  group_by(categoria_ocup_f, voto_pasado) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "categoria_ocup_f", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  flextable() %>% 
  save_as_docx(path = "salidas/votopasado_catlaboral.docx")

lapop2004_2018 %>% 
  drop_na(categoria_ocup_f, voto_pasado) %>% 
  group_by(categoria_ocup_f, voto_pasado) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "categoria_ocup_f", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  kbl() %>%
  kable_styling() 
  
```


```{r Cruce variable laboral y voto presente, echo=FALSE, warning=FALSE, message=FALSE}

lapop2004_2018 %>%
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(voto_presente, categoria_ocup_f) %>% 
  group_by(country_f, categoria_ocup_f) %>% 
  summarise(media = mean(voto_presente)*100) %>% 
  ggplot(aes(x=categoria_ocup_f, y=media, group=1)) +
  geom_line(size = 0.5) +
  geom_point(aes(y=media), size = 2) +
  labs(title = "Voto en elecciones presentes según categoría laboral por país (media)", 
       caption = "Elaboración propia en base a LAPOP 2008-2018",
       y = "Porcentaje") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 6, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 8)) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/porcentaje_votopresente_categoria.png", dpi = 300, type = "cairo", width = 8, height = 6)


lapop2004_2018 %>% 
  drop_na(categoria_ocup_f, voto_presente) %>% 
  group_by(categoria_ocup_f, voto_presente) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "categoria_ocup_f", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  flextable() %>% 
  save_as_docx(path = "salidas/votopresente_catlaboral.docx")

lapop2004_2018 %>% 
  drop_na(categoria_ocup_f, voto_presente) %>% 
  group_by(categoria_ocup_f, voto_presente) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "categoria_ocup_f", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  kbl() %>%
  kable_styling() 
  
```

# Cruces variable laboral / informal y variables objetivo 2018  


```{r Cruce variables laborales y desempleados, echo=FALSE, warning=FALSE, message=FALSE}

#Desempleados

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(desempleados, categoria_ocup_f) %>% 
  group_by(country_f, categoria_ocup_f) %>% 
  summarise(media = mean(desempleados)) %>% 
  ggplot(aes(x=categoria_ocup_f, y=media, group=1)) +
  geom_line(size = 0.5) +
  geom_point(aes(y=media), size = 2) +
  labs(title = "Los desempleados no pueden encontrar trabajo solo por su voluntad (media)", 
       y = "Nivel de acuerdo",
       caption = "Elaboración propia en base a LAPOP 2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 8)) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  scale_y_continuous(breaks=seq(1, 7, 1), limits = c(2,5)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/desempleados_categoria.png", dpi = 300, type = "cairo", width = 8, height = 6)

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(categoria_ocup_f, desempleados) %>% 
  group_by(categoria_ocup_f, desempleados) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "categoria_ocup_f", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  flextable() %>% 
  save_as_docx(path = "salidas/desempleados_catlaboral.docx")

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(categoria_ocup_f, desempleados) %>% 
  group_by(categoria_ocup_f, desempleados) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "categoria_ocup_f", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  kbl() %>%
  kable_styling()

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(desempleados, formal_estado) %>% 
  group_by(country_f, formal_estado) %>% 
  summarise(media = mean(desempleados)) %>% 
  ggplot(aes(x=formal_estado, y=media, group=1)) +
  geom_line(size = 0.5) +
  geom_point(aes(y=media), size = 2) +
  labs(title = "Los desempleados no pueden encontrar trabajo solo por su voluntad (media)", 
       y = "Nivel de acuerdo",
       caption = "Elaboración propia en base a LAPOP 2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 8)) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  scale_y_continuous(breaks=seq(1, 7, 1), limits = c(2,5)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/desempleados_formal.png", dpi = 300, type = "cairo", width = 8, height = 6)

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(formal_estado, desempleados) %>% 
  group_by(formal_estado, desempleados) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "formal_estado", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  flextable() %>% 
  save_as_docx(path = "salidas/desempleados_formalidad.docx")

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(formal_estado, desempleados) %>% 
  group_by(formal_estado, desempleados) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "formal_estado", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  kbl() %>%
  kable_styling()


lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(desempleados, estatus_ocup) %>% 
  group_by(country_f, estatus_ocup_f) %>% 
  summarise(media = mean(desempleados)) %>% 
  ggplot(aes(x=estatus_ocup_f, y=media, group=1)) +
  geom_line(size = 0.5) +
  geom_point(aes(y=media), size = 2) +
  labs(title = "Los desempleados no pueden encontrar trabajo solo por su voluntad (media)", 
       y = "Nivel de acuerdo",
       caption = "Elaboración propia en base a LAPOP 2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 8)) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  scale_y_continuous(breaks=seq(1, 7, 1), limits = c(2,5)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/desempleados_estatus.png", dpi = 300, type = "cairo", width = 8, height = 6)

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(estatus_ocup_f, desempleados) %>% 
  group_by(estatus_ocup_f, desempleados) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "estatus_ocup_f", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  flextable() %>% 
  save_as_docx(path = "salidas/desempleo_estatus_ocup.docx")

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(estatus_ocup_f, desempleados) %>% 
  group_by(estatus_ocup_f, desempleados) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "estatus_ocup_f", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  kbl() %>%
  kable_styling()

```

```{r Cruce variables laborales y ayuda pobres, echo=FALSE, warning=FALSE, message=FALSE}

#ayuda pobres

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(ayuda_pobres, categoria_ocup_f) %>% 
  group_by(country_f, categoria_ocup_f) %>% 
  summarise(media = mean(ayuda_pobres)) %>% 
  ggplot(aes(x=categoria_ocup_f, y=media, group=1)) +
  geom_line(size = 0.5) +
  geom_point(aes(y=media), size = 2) +
  labs(title = "Los gobiernos deben gastar más en el combate de la pobreza (media)", 
       y = "Nivel de acuerdo",
       caption = "Elaboración propia en base a LAPOP 2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 8)) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  scale_y_continuous(breaks=seq(1, 7, 1), limits = c(4,7)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/ayuda_pobres_categoria.png", dpi = 300, type = "cairo", width = 8, height = 6)

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(categoria_ocup_f, ayuda_pobres) %>% 
  group_by(categoria_ocup_f, ayuda_pobres) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "categoria_ocup_f", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  flextable() %>% 
  save_as_docx(path = "salidas/ayudalaboral_catlaboral.docx")

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(categoria_ocup_f, ayuda_pobres) %>% 
  group_by(categoria_ocup_f, ayuda_pobres) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "categoria_ocup_f", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  kbl() %>%
  kable_styling()

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(ayuda_pobres, formal_estado) %>% 
  group_by(country_f, formal_estado) %>% 
  summarise(media = mean(ayuda_pobres)) %>% 
  ggplot(aes(x=formal_estado, y=media, group=1)) +
  geom_line(size = 0.5) +
  geom_point(aes(y=media), size = 2) +
  labs(title = "Los gobiernos deben gastar más en el combate de la pobreza (media)", 
       y = "Nivel de acuerdo",
       caption = "Elaboración propia en base a LAPOP 2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 8)) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  scale_y_continuous(breaks=seq(1, 7, 1), limits = c(4,7)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/ayuda_pobres_formal.png", dpi = 300, type = "cairo", width = 8, height = 6)


lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(formal_estado, ayuda_pobres) %>% 
  group_by(formal_estado, ayuda_pobres) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "formal_estado", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  flextable() %>% 
  save_as_docx(path = "salidas/ayudapobres_formalidad.docx")

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(formal_estado, ayuda_pobres) %>% 
  group_by(formal_estado, ayuda_pobres) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "formal_estado", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  kbl() %>%
  kable_styling()


lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(ayuda_pobres, estatus_ocup) %>% 
  group_by(country_f, estatus_ocup_f) %>% 
  summarise(media = mean(ayuda_pobres)) %>% 
  ggplot(aes(x=estatus_ocup_f, y=media, group=1)) +
  geom_line(size = 0.5) +
  geom_point(aes(y=media), size = 2) +
  labs(title = "Los gobiernos deben gastar más en el combate de la pobreza (media)", 
       y = "Nivel de acuerdo",
       caption = "Elaboración propia en base a LAPOP 2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 8)) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  scale_y_continuous(breaks=seq(1, 7, 1), limits = c(4,7)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/ayuda_pobres_estatus.png", dpi = 300, type = "cairo", width = 8, height = 6)


lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(estatus_ocup_f, ayuda_pobres) %>% 
  group_by(estatus_ocup_f, ayuda_pobres) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "estatus_ocup_f", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  flextable() %>% 
  save_as_docx(path = "salidas/ayudapobres_estatusocup.docx")

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(estatus_ocup_f, ayuda_pobres) %>% 
  group_by(estatus_ocup_f, ayuda_pobres) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "estatus_ocup_f", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  kbl() %>%
  kable_styling()

```

```{r Cruce variables laborales y impuesto ricos, echo=FALSE, warning=FALSE, message=FALSE}

#impuestos ricos

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(impuestos_ricos, categoria_ocup_f) %>% 
  group_by(country_f, categoria_ocup_f) %>% 
  summarise(media = mean(impuestos_ricos)) %>% 
  ggplot(aes(x=categoria_ocup_f, y=media, group=1)) +
  geom_line(size = 0.5) +
  geom_point(aes(y=media), size = 2) +
  labs(title = "Los ricos paguen mucho en impuestos pero reciban poco en servicios del Estado (media)", 
       y = "Nivel de acuerdo",
       caption = "Elaboración propia en base a LAPOP 2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 8)) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  scale_y_continuous(breaks=seq(1, 7, 1), limits = c(3,6)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/impuestos_categoria.png", dpi = 300, type = "cairo", width = 8, height = 6)

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(categoria_ocup_f, impuestos_ricos) %>% 
  group_by(categoria_ocup_f, impuestos_ricos) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "categoria_ocup_f", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  flextable() %>% 
  save_as_docx(path = "salidas/impuestos_catlaboral.docx")

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(categoria_ocup_f, impuestos_ricos) %>% 
  group_by(categoria_ocup_f, impuestos_ricos) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "categoria_ocup_f", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  kbl() %>%
  kable_styling()

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(impuestos_ricos, formal_estado) %>% 
  group_by(country_f, formal_estado) %>% 
  summarise(media = mean(impuestos_ricos)) %>% 
  ggplot(aes(x=formal_estado, y=media, group=1)) +
  geom_line(size = 0.5) +
  geom_point(aes(y=media), size = 2) +
  labs(title = "Los ricos paguen mucho en impuestos pero reciban poco en servicios del Estado (media)", 
       y = "Nivel de acuerdo",
       caption = "Elaboración propia en base a LAPOP 2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 8)) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  scale_y_continuous(breaks=seq(1, 7, 1), limits = c(3,6)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/impuestos_formal.png", dpi = 300, type = "cairo", width = 8, height = 6)

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(formal_estado, impuestos_ricos) %>% 
  group_by(formal_estado, impuestos_ricos) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "formal_estado", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  flextable() %>% 
  save_as_docx(path = "salidas/impuestos_formalidad.docx")

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(formal_estado, impuestos_ricos) %>% 
  group_by(formal_estado, impuestos_ricos) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "formal_estado", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  kbl() %>%
  kable_styling()


lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(impuestos_ricos, estatus_ocup) %>% 
  group_by(country_f, estatus_ocup_f) %>% 
  summarise(media = mean(impuestos_ricos)) %>% 
  ggplot(aes(x=estatus_ocup_f, y=media, group=1)) +
  geom_line(size = 0.5) +
  geom_point(aes(y=media), size = 2) +
  labs(title = "Los ricos paguen mucho en impuestos pero reciban poco en servicios del Estado (media)", 
       y = "Nivel de acuerdo",
       caption = "Elaboración propia en base a LAPOP 2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 8)) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  scale_y_continuous(breaks=seq(1, 7, 1), limits = c(3,6)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/impuestos_estatus.png", dpi = 300, type = "cairo", width = 8, height = 6)

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(estatus_ocup_f, impuestos_ricos) %>% 
  group_by(estatus_ocup_f, impuestos_ricos) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "estatus_ocup_f", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  flextable() %>% 
  save_as_docx(path = "salidas/impuestos_estatusocup.docx")

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(estatus_ocup_f, impuestos_ricos) %>% 
  group_by(estatus_ocup_f, impuestos_ricos) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "estatus_ocup_f", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  kbl() %>%
  kable_styling()

```

```{r Cruce variables laborales y reducción desigualdad, echo=FALSE, warning=FALSE, message=FALSE}

#Reducción desigualdad

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(reduc_desigualdad, formal_estado) %>% 
  group_by(country_f, formal_estado) %>% 
  summarise(media = mean(reduc_desigualdad)) %>% 
  ggplot(aes(x=formal_estado, y=media, group=1)) +
  geom_line(size = 0.5) +
  geom_point(aes(y=media), size = 2) +
  labs(title = "Acuerdo con reducción de la desigualdad entre ricos y pobres según categoría laboral por país (media)", 
       subtitle = "Variable reduc_desigualdad sin imputar",
       y = "Aprobación de reducción de la desigualdad",
       caption = "Elaboración propia en base a LAPOP 2008-2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 8)) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  scale_y_continuous(breaks=seq(1, 7, 1), limits = c(4,7)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/desigualdad_formal.png", dpi = 300, type = "cairo", width = 8, height = 6)

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(formal_estado, reduc_desigualdad) %>% 
  group_by(formal_estado, reduc_desigualdad) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "formal_estado", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  flextable() %>% 
  save_as_docx(path = "salidas/reducdesigualdad_formalidad.docx")

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(formal_estado, reduc_desigualdad) %>% 
  group_by(formal_estado, reduc_desigualdad) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "formal_estado", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  kbl() %>%
  kable_styling()


lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(reduc_desigualdad, estatus_ocup) %>% 
  group_by(country_f, estatus_ocup_f) %>% 
  summarise(media = mean(reduc_desigualdad)) %>% 
  ggplot(aes(x=estatus_ocup_f, y=media, group=1)) +
  geom_line(size = 0.5) +
  geom_point(aes(y=media), size = 2) +
  labs(title = "Acuerdo con reducción de la desigualdad entre ricos y pobres según categoría laboral por país (media)", 
       subtitle = "Variable reduc_desigualdad sin imputar",
       y = "Aprobación de reducción de la desigualdad",
       caption = "Elaboración propia en base a LAPOP 2008-2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 8)) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  scale_y_continuous(breaks=seq(1, 7, 1), limits = c(4,7)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/desigualdad_estatus.png", dpi = 300, type = "cairo", width = 8, height = 6)

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(estatus_ocup_f, reduc_desigualdad) %>% 
  group_by(estatus_ocup_f, reduc_desigualdad) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "estatus_ocup_f", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  flextable() %>% 
  save_as_docx(path = "salidas/reducdesigualdad_estatusocup.docx")

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(estatus_ocup_f, reduc_desigualdad) %>% 
  group_by(estatus_ocup_f, reduc_desigualdad) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "estatus_ocup_f", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  kbl() %>%
  kable_styling() 

```

```{r Cruce variables laborales y democracia, echo=FALSE, warning=FALSE, message=FALSE}

#Democracia
lapop2004_2018 %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(democracia7, formal_estado) %>% 
  group_by(country_f, formal_estado) %>% 
  summarise(media = mean(democracia7)) %>% 
  ggplot(aes(x=formal_estado, y=media, group=1)) +
  geom_line(size = 0.5) +
  geom_point(aes(y=media), size = 2) +
  labs(title = "Democracia como mejor forma de gobierno según categoría laboral por país (media)", 
       subtitle = "Variable democracia7 sin imputar",
       caption = "Elaboración propia en base a LAPOP 2008-2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 8)) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  scale_y_continuous(breaks=seq(1, 7, 1), limits = c(4,7)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/democracia_formal.png", dpi = 300, type = "cairo", width = 8, height = 6)

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(formal_estado, democracia7) %>% 
  group_by(formal_estado, democracia7) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "formal_estado", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  flextable() %>% 
  save_as_docx(path = "salidas/democracia_formalidad.docx")

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(formal_estado, democracia7) %>% 
  group_by(formal_estado, democracia7) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "formal_estado", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  kbl() %>%
  kable_styling()

lapop2004_2018 %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(democracia7, estatus_ocup) %>% 
  group_by(country_f, estatus_ocup_f) %>% 
  summarise(media = mean(democracia7)) %>% 
  ggplot(aes(x=estatus_ocup_f, y=media, group=1)) +
  geom_line(size = 0.5) +
  geom_point(aes(y=media), size = 2) +
  labs(title = "Democracia como mejor forma de gobierno según categoría laboral por país (media)", 
       subtitle = "Variable democracia7 sin imputar",
       caption = "Elaboración propia en base a LAPOP 2008-2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        plot.subtitle = element_text(size = 9),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 8)) +
    scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  scale_y_continuous(breaks=seq(1, 7, 1), limits = c(4,7)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/democracia_estatus.png", dpi = 300, type = "cairo", width = 8, height = 6)

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(estatus_ocup_f, democracia7) %>% 
  group_by(estatus_ocup_f, democracia7) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "estatus_ocup_f", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  flextable() %>% 
  save_as_docx(path = "salidas/democracia_estatusocup.docx")

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(estatus_ocup_f, democracia7) %>% 
  group_by(estatus_ocup_f, democracia7) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "estatus_ocup_f", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  kbl() %>%
  kable_styling()

```

```{r Cruce variables laborales y voto pasado, echo=FALSE, warning=FALSE, message=FALSE}
#Voto pasado
lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(voto_pasado, formal_estado) %>% 
  group_by(country_f, formal_estado, voto_pasado) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  ggplot(aes(x=formal_estado, y=porcentaje, fill= as.factor(voto_pasado))) +
  geom_col() +
  scale_fill_discrete(labels=c('No', 'Si'))+
  labs(title = "Voto en elecciones presentes por formalidad", 
       caption = "Elaboración propia en base a LAPOP 2018",
       fill = "Voto") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7),
        axis.text.y = element_text(size = 7)) +
  scale_y_continuous(labels= scales::percent_format(accuracy = 1L), 
                     breaks=seq(0, 1, 0.2)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/voto_pasado_formal.png", dpi = 300, type = "cairo", width = 8, height = 6)


lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(formal_estado, voto_pasado) %>% 
  group_by(formal_estado, voto_pasado) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "formal_estado", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  flextable() %>% 
  save_as_docx(path = "salidas/votopasado_formalidad.docx")

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(formal_estado, voto_pasado) %>% 
  group_by(formal_estado, voto_pasado) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "formal_estado", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  kbl() %>%
  kable_styling()


lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(voto_pasado, estatus_ocup_f) %>% 
  group_by(country_f, estatus_ocup_f, voto_pasado) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  ggplot(aes(x=estatus_ocup_f, y=porcentaje, fill= as.factor(voto_pasado))) +
  geom_col() +
  scale_fill_discrete(labels=c('No', 'Si'))+
  labs(title = "Voto en elecciones presentes por estatus laboral", 
       caption = "Elaboración propia en base a LAPOP 2018",
       fill = "Voto") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 7)) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  scale_y_continuous(labels= scales::percent_format(accuracy = 1L), 
                     breaks=seq(0, 1, 0.2)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/voto_pasado_estatus.png", dpi = 300, type = "cairo", width = 8, height = 6)

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(estatus_ocup_f, voto_pasado) %>% 
  group_by(estatus_ocup_f, voto_pasado) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "estatus_ocup_f", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  flextable() %>% 
  save_as_docx(path = "salidas/votopasado_estatusocup.docx")

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(estatus_ocup_f, voto_pasado) %>% 
  group_by(estatus_ocup_f, voto_pasado) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "estatus_ocup_f", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  kbl() %>%
  kable_styling()

```

```{r Cruce variables laborales y voto presente, echo=FALSE, warning=FALSE, message=FALSE}
#Voto presente
lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(voto_presente, categoria_ocup_f) %>% 
  group_by(country_f, categoria_ocup_f, voto_presente) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  ggplot(aes(x=categoria_ocup_f, y=porcentaje, fill= as.factor(voto_presente))) +
  geom_col() +
  scale_fill_discrete(labels=c('No', 'Si'))+
  labs(title = "Voto en elecciones presentes por categoría laboral", 
       caption = "Elaboración propia en base a LAPOP 2018",
       fill = "Voto") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 7)) +
  scale_y_continuous(labels= scales::percent_format(accuracy = 1L), 
                     breaks=seq(0, 1, 0.2)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/voto_presente_categoria.png", dpi = 300, type = "cairo", width = 8, height = 6)


lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(categoria_ocup_f, voto_presente) %>% 
  group_by(categoria_ocup_f, voto_presente) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "categoria_ocup_f", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  flextable() %>% 
  save_as_docx(path = "salidas/votopresente_catocup.docx")

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(categoria_ocup_f, voto_presente) %>% 
  group_by(categoria_ocup_f, voto_presente) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "categoria_ocup_f", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  kbl() %>%
  kable_styling()

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(voto_presente, formal_estado) %>% 
  group_by(country_f, formal_estado, voto_presente) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  ggplot(aes(x=formal_estado, y=porcentaje, fill= as.factor(voto_presente))) +
  geom_col() +
  scale_fill_discrete(labels=c('No', 'Si'))+
  labs(title = "Voto en elecciones pasadas por formalidad", 
       caption = "Elaboración propia en base a LAPOP 2018",
       fill = "Voto") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7),
        axis.text.y = element_text(size = 7)) +
  scale_y_continuous(labels= scales::percent_format(accuracy = 1L), 
                     breaks=seq(0, 1, 0.2)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/voto_presente_formal.png", dpi = 300, type = "cairo", width = 8, height = 6)


lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(formal_estado, voto_presente) %>% 
  group_by(formal_estado, voto_presente) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "formal_estado", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  flextable() %>% 
  save_as_docx(path = "salidas/votopresente_formalidad.docx")

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(formal_estado, voto_presente) %>% 
  group_by(formal_estado, voto_presente) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "formal_estado", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  kbl() %>%
  kable_styling()


lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(voto_presente, estatus_ocup_f) %>% 
  group_by(country_f, estatus_ocup_f, voto_presente) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  ggplot(aes(x=estatus_ocup_f, y=porcentaje, fill= as.factor(voto_presente))) +
  geom_col() +
  scale_fill_discrete(labels=c('No', 'Si'))+
  labs(title = "Voto en elecciones pasadas por estatus laboral", 
       caption = "Elaboración propia en base a LAPOP 2018",
       fill = "Voto") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 7)) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  scale_y_continuous(labels= scales::percent_format(accuracy = 1L), 
                     breaks=seq(0, 1, 0.2)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/voto_presente_estatus.png", dpi = 300, type = "cairo", width = 8, height = 6)

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(estatus_ocup_f, voto_presente) %>% 
  group_by(estatus_ocup_f, voto_presente) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "estatus_ocup_f", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  flextable() %>% 
  save_as_docx(path = "salidas/votopresente_estatusocup.docx")

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(estatus_ocup_f, voto_presente) %>% 
  group_by(estatus_ocup_f, voto_presente) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "estatus_ocup_f", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  kbl() %>%
  kable_styling()

```

```{r Cruce variables laborales y corrupción, echo=FALSE, warning=FALSE, message=FALSE}
#Corrupción
lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(corrup_func, categoria_ocup_f) %>% 
  group_by(country_f, categoria_ocup_f, corrup_func) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  ggplot(aes(x=categoria_ocup_f, y=porcentaje, fill= as.factor(corrup_func))) +
  geom_col() +
  scale_fill_discrete(labels=c('Generalizado', 'No generalizado'))+
  labs(title = "Nivel de corrupción de los funcionarios públicos por categoría laboral",  
       caption = "Elaboración propia en base a LAPOP 2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 7),
        legend.title = element_blank()) +
  scale_y_continuous(labels= scales::percent_format(accuracy = 1L), 
                     breaks=seq(0, 1, 0.2)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/corrupcion_categoria.png", dpi = 300, type = "cairo", width = 8, height = 6)


lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(categoria_ocup_f, corrup_func) %>% 
  group_by(categoria_ocup_f, corrup_func) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "categoria_ocup_f", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  flextable() %>% 
  save_as_docx(path = "salidas/corrup_catlaboral.docx")

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(categoria_ocup_f, corrup_func) %>% 
  group_by(categoria_ocup_f, corrup_func) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "categoria_ocup_f", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  kbl() %>%
  kable_styling()

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(corrup_func, formal_estado) %>% 
  group_by(country_f, formal_estado, corrup_func) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  ggplot(aes(x=formal_estado, y=porcentaje, fill= as.factor(corrup_func))) +
  geom_col() +
  scale_fill_discrete(labels=c('Generalizado', 'No generalizado'))+
  labs(title = "Nivel de corrupción de los funcionarios públicos por formalidad", 
       caption = "Elaboración propia en base a LAPOP 2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 7),
        legend.title = element_blank()) +
  scale_y_continuous(labels= scales::percent_format(accuracy = 1L), 
                     breaks=seq(0, 1, 0.2)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/corrupcion_formal.png", dpi = 300, type = "cairo", width = 8, height = 6)


lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(formal_estado, corrup_func) %>% 
  group_by(formal_estado, corrup_func) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "corrup_func", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  flextable() %>% 
  save_as_docx(path = "salidas/corrup_formalidad.docx")

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(formal_estado, corrup_func) %>% 
  group_by(formal_estado, corrup_func) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "corrup_func", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  kbl() %>%
  kable_styling() 


lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(corrup_func, estatus_ocup_f) %>% 
  group_by(country_f, estatus_ocup_f, corrup_func) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  ggplot(aes(x=estatus_ocup_f, y=porcentaje, fill= as.factor(corrup_func))) +
  geom_col() +
  scale_fill_discrete(labels=c('Generalizado', 'No generalizado'))+
  labs(title = "Nivel de corrupción de los funcionarios públicos por estatus laboral", 
       caption = "Elaboración propia en base a LAPOP 2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 7),
        legend.title = element_blank()) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  scale_y_continuous(labels= scales::percent_format(accuracy = 1L), 
                     breaks=seq(0, 1, 0.2)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/corrup_estatus.png", dpi = 300, type = "cairo", width = 8, height = 6)

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(estatus_ocup_f, corrup_func) %>% 
  group_by(estatus_ocup_f, corrup_func) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "estatus_ocup_f", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  flextable() %>% 
  save_as_docx(path = "salidas/corrup_estatusocup.docx")

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(estatus_ocup_f, corrup_func) %>% 
  group_by(estatus_ocup_f, corrup_func) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "estatus_ocup_f", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  kbl() %>%
  kable_styling() 

```


```{r Cruce variables laborales y golpe, echo=FALSE, warning=FALSE, message=FALSE}

#Golpe
lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(golpe, categoria_ocup_f) %>% 
  group_by(country_f, categoria_ocup_f, golpe) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  ggplot(aes(x=categoria_ocup_f, y=porcentaje, fill= as.factor(golpe))) +
  geom_col() +
  scale_fill_discrete(labels=c('Justifica', 'No justifica'))+
  labs(title = "Justificación de golpe militar ante mucha corrupción según categoría laboral",  
       caption = "Elaboración propia en base a LAPOP 2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 7),
        legend.title = element_blank()) +
  scale_y_continuous(labels= scales::percent_format(accuracy = 1L), 
                     breaks=seq(0, 1, 0.2)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/golpe_categoria.png", dpi = 300, type = "cairo", width = 8, height = 6)


lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(categoria_ocup_f, golpe) %>% 
  group_by(categoria_ocup_f, golpe) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "categoria_ocup_f", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  flextable() %>% 
  save_as_docx(path = "salidas/golpe_catlaboral.docx")

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(categoria_ocup_f, golpe) %>% 
  group_by(categoria_ocup_f, golpe) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "categoria_ocup_f", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  kbl() %>%
  kable_styling()


lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(golpe, formal_estado) %>% 
  group_by(country_f, formal_estado, golpe) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  ggplot(aes(x=formal_estado, y=porcentaje, fill= as.factor(golpe))) +
  geom_col() +
  scale_fill_discrete(labels=c('Justifica', 'No justifica'))+
  labs(title = "Justificación de golpe militar ante mucha corrupción según formalidad", 
       caption = "Elaboración propia en base a LAPOP 2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 7),
        legend.title = element_blank()) +
  scale_y_continuous(labels= scales::percent_format(accuracy = 1L), 
                     breaks=seq(0, 1, 0.2)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/golpe_formal.png", dpi = 300, type = "cairo", width = 8, height = 6)


lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(formal_estado, golpe) %>% 
  group_by(formal_estado, golpe) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "golpe", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  flextable() %>% 
  save_as_docx(path = "salidas/golpe_formalidad.docx")

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(formal_estado, golpe) %>% 
  group_by(formal_estado, golpe) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "golpe", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  kbl() %>%
  kable_styling()


lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(golpe, estatus_ocup_f) %>% 
  group_by(country_f, estatus_ocup_f, golpe) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  ggplot(aes(x=estatus_ocup_f, y=porcentaje, fill= as.factor(golpe))) +
  geom_col() +
  scale_fill_discrete(labels=c('Justifica', 'No justifica'))+
  labs(title = "Justificación de golpe militar ante mucha corrupción según estatus laboral", 
       caption = "Elaboración propia en base a LAPOP 2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 7),
        legend.title = element_blank()) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  scale_y_continuous(labels= scales::percent_format(accuracy = 1L), 
                     breaks=seq(0, 1, 0.2)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/golpe_estatus.png", dpi = 300, type = "cairo", width = 8, height = 6)

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(estatus_ocup_f, golpe) %>% 
  group_by(estatus_ocup_f, golpe) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "estatus_ocup_f", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  flextable() %>% 
  save_as_docx(path = "salidas/golpe_estatusocup.docx")

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(estatus_ocup_f, golpe) %>% 
  group_by(estatus_ocup_f, golpe) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "estatus_ocup_f", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  kbl() %>%
  kable_styling()

```


```{r Cruce variables laborales y cierre congreso, echo=FALSE, warning=FALSE, message=FALSE}

#Cierre congreso
lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(cierre_congreso, categoria_ocup_f) %>% 
  group_by(country_f, categoria_ocup_f, cierre_congreso) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  ggplot(aes(x=categoria_ocup_f, y=porcentaje, fill= as.factor(cierre_congreso))) +
  geom_col() +
  scale_fill_discrete(labels=c('No justifica', 'Justifica'))+
  labs(title = "Justificación de cierre de congreso en situaciones difíciles del país según categoría laboral",  
       caption = "Elaboración propia en base a LAPOP 2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 7),
        legend.title = element_blank()) +
  scale_y_continuous(labels= scales::percent_format(accuracy = 1L), 
                     breaks=seq(0, 1, 0.2)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/cierre_congreso_categoria.png", dpi = 300, type = "cairo", width = 8, height = 6)


lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(categoria_ocup_f, cierre_congreso) %>% 
  group_by(categoria_ocup_f, cierre_congreso) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "categoria_ocup_f", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  flextable() %>% 
  save_as_docx(path = "salidas/cierrecongreso_catlaboral.docx")

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(categoria_ocup_f, cierre_congreso) %>% 
  group_by(categoria_ocup_f, cierre_congreso) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "categoria_ocup_f", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  kbl() %>%
  kable_styling()


lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(cierre_congreso, formal_estado) %>% 
  group_by(country_f, formal_estado, cierre_congreso) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  ggplot(aes(x=formal_estado, y=porcentaje, fill= as.factor(cierre_congreso))) +
  geom_col() +
  scale_fill_discrete(labels=c('Justifica', 'No justifica'))+
  labs(title = "Justificación de cierre de congreso en situaciones difíciles del país según formalidad", 
       caption = "Elaboración propia en base a LAPOP 2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 7),
        legend.title = element_blank()) +
  scale_y_continuous(labels= scales::percent_format(accuracy = 1L), 
                     breaks=seq(0, 1, 0.2)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/cierre_congreso_formal.png", dpi = 300, type = "cairo", width = 8, height = 6)


lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(formal_estado, cierre_congreso) %>% 
  group_by(formal_estado, cierre_congreso) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "cierre_congreso", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  flextable() %>% 
  save_as_docx(path = "salidas/cierrecongreso_formalidad.docx")

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(formal_estado, cierre_congreso) %>% 
  group_by(formal_estado, cierre_congreso) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "cierre_congreso", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  kbl() %>%
  kable_styling()

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(cierre_congreso, estatus_ocup_f) %>% 
  group_by(country_f, estatus_ocup_f, cierre_congreso) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  ggplot(aes(x=estatus_ocup_f, y=porcentaje, fill= as.factor(cierre_congreso))) +
  geom_col() +
  scale_fill_discrete(labels=c('Justifica', 'No justifica'))+
  labs(title = "Justificación de cierre del congreso en situaciones difíciles del país según estatus laboral", 
       caption = "Elaboración propia en base a LAPOP 2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 7),
        legend.title = element_blank()) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  scale_y_continuous(labels= scales::percent_format(accuracy = 1L), 
                     breaks=seq(0, 1, 0.2)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/cierre_congreso_estatus.png", dpi = 300, type = "cairo", width = 8, height = 6)

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(estatus_ocup_f, cierre_congreso) %>% 
  group_by(estatus_ocup_f, cierre_congreso) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "estatus_ocup_f", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  flextable() %>% 
  save_as_docx(path = "salidas/cierrecongreso_estatusocup.docx")

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(estatus_ocup_f, cierre_congreso) %>% 
  group_by(estatus_ocup_f, cierre_congreso) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "estatus_ocup_f", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  kbl() %>%
  kable_styling()

```

```{r Cruce variables laborales y cierre corte, echo=FALSE, warning=FALSE, message=FALSE}

#Cierre corte
lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(cierre_corte, categoria_ocup_f) %>% 
  group_by(country_f, categoria_ocup_f, cierre_corte) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  ggplot(aes(x=categoria_ocup_f, y=porcentaje, fill= as.factor(cierre_corte))) +
  geom_col() +
  scale_fill_discrete(labels=c('Justifica', 'No justifica'))+
  labs(title = "Justificación de cierre de corte suprema en situaciones difíciles del país según categoría laboral",  
       caption = "Elaboración propia en base a LAPOP 2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 7),
        legend.title = element_blank()) +
  scale_y_continuous(labels= scales::percent_format(accuracy = 1L), 
                     breaks=seq(0, 1, 0.2)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/cierre_corte_categoria.png", dpi = 300, type = "cairo", width = 8, height = 6)


lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(categoria_ocup_f, cierre_corte) %>% 
  group_by(categoria_ocup_f, cierre_corte) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "categoria_ocup_f", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  flextable() %>% 
  save_as_docx(path = "salidas/cierrecorte_catlaboral.docx")

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(categoria_ocup_f, cierre_corte) %>% 
  group_by(categoria_ocup_f, cierre_corte) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "categoria_ocup_f", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  kbl() %>%
  kable_styling()


lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(cierre_corte, formal_estado) %>% 
  group_by(country_f, formal_estado, cierre_corte) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  ggplot(aes(x=formal_estado, y=porcentaje, fill= as.factor(cierre_corte))) +
  geom_col() +
  scale_fill_discrete(labels=c('Justifica', 'No justifica'))+
  labs(title = "Justificación de cierre de corte suprema en situaciones difíciles del país según formalidad", 
       caption = "Elaboración propia en base a LAPOP 2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 7),
        legend.title = element_blank()) +
  scale_y_continuous(labels= scales::percent_format(accuracy = 1L), 
                     breaks=seq(0, 1, 0.2)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/cierre_corte_formal.png", dpi = 300, type = "cairo", width = 8, height = 6)


lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(formal_estado, cierre_corte) %>% 
  group_by(formal_estado, cierre_corte) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "cierre_corte", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  flextable() %>% 
  save_as_docx(path = "salidas/cierrecorte_formalidad.docx")

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(formal_estado, cierre_corte) %>% 
  group_by(formal_estado, cierre_corte) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "cierre_corte", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  kbl() %>%
  kable_styling()

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(cierre_corte, estatus_ocup_f) %>% 
  group_by(country_f, estatus_ocup_f, cierre_corte) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  ggplot(aes(x=estatus_ocup_f, y=porcentaje, fill= as.factor(cierre_corte))) +
  geom_col() +
  scale_fill_discrete(labels=c('Justifica', 'No justifica'))+
  labs(title = "Justificación de cierre de corte suprema en situaciones difíciles del país según estatus laboral", 
       caption = "Elaboración propia en base a LAPOP 2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 7),
        legend.title = element_blank()) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  scale_y_continuous(labels= scales::percent_format(accuracy = 1L), 
                     breaks=seq(0, 1, 0.2)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/cierre_corte_estatus.png", dpi = 300, type = "cairo", width = 8, height = 6)

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(estatus_ocup_f, cierre_corte) %>% 
  group_by(estatus_ocup_f, cierre_corte) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "estatus_ocup_f", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  flextable() %>% 
  save_as_docx(path = "salidas/cierrecorte_estatusocup.docx")

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(estatus_ocup_f, cierre_corte) %>% 
  group_by(estatus_ocup_f, cierre_corte) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "estatus_ocup_f", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  kbl() %>%
  kable_styling()

```

```{r Cruce variables laborales y simpatía política, echo=FALSE, warning=FALSE, message=FALSE}

#Simpatía política
lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(simpatiza_partido, categoria_ocup_f) %>% 
  group_by(country_f, categoria_ocup_f, simpatiza_partido) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  ggplot(aes(x=categoria_ocup_f, y=porcentaje, fill= as.factor(simpatiza_partido))) +
  geom_col() +
  scale_fill_discrete(labels=c('No simpatiza', 'Simpatiza'))+
  labs(title = "Simpatía con partido político según categoría laboral",  
       caption = "Elaboración propia en base a LAPOP 2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 7),
        legend.title = element_blank()) +
  scale_y_continuous(labels= scales::percent_format(accuracy = 1L), 
                     breaks=seq(0, 1, 0.2)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/simpatiza_partido_categoria.png", dpi = 300, type = "cairo", width = 8, height = 6)


lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(categoria_ocup_f, simpatiza_partido) %>% 
  group_by(categoria_ocup_f, simpatiza_partido) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "categoria_ocup_f", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  flextable() %>% 
  save_as_docx(path = "salidas/simpatiapolitica_catlaboral.docx")

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(categoria_ocup_f, simpatiza_partido) %>% 
  group_by(categoria_ocup_f, simpatiza_partido) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "categoria_ocup_f", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  kbl() %>%
  kable_styling() 


lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(simpatiza_partido, formal_estado) %>% 
  group_by(country_f, formal_estado, simpatiza_partido) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  ggplot(aes(x=formal_estado, y=porcentaje, fill= as.factor(simpatiza_partido))) +
  geom_col() +
  scale_fill_discrete(labels=c('No simpatiza', 'Simpatiza'))+
  labs(title = "Simpatía con partido político según formalidad",  
       caption = "Elaboración propia en base a LAPOP 2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 7),
        legend.title = element_blank()) +
  scale_y_continuous(labels= scales::percent_format(accuracy = 1L), 
                     breaks=seq(0, 1, 0.2)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/simpatiza_partido_formal.png", dpi = 300, type = "cairo", width = 8, height = 6)


lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(formal_estado, simpatiza_partido) %>% 
  group_by(formal_estado, simpatiza_partido) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "simpatiza_partido", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  flextable() %>% 
  save_as_docx(path = "salidas/simpatiapolitica_formalidad.docx")

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(formal_estado, simpatiza_partido) %>% 
  group_by(formal_estado, simpatiza_partido) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "simpatiza_partido", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  kbl() %>%
  kable_styling() 


lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  bind_rows(lapop2004_2018 %>% mutate(country_f = "Total")) %>% 
  drop_na(simpatiza_partido, estatus_ocup_f) %>% 
  group_by(country_f, estatus_ocup_f, simpatiza_partido) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  ggplot(aes(x=estatus_ocup_f, y=porcentaje, fill= as.factor(simpatiza_partido))) +
  geom_col() +
  scale_fill_discrete(labels=c('No simpatiza', 'Simpatiza'))+
  labs(title = "Simpatía con partido político según estatus laboral",  
       caption = "Elaboración propia en base a LAPOP 2018") +
  theme(plot.title = element_text(size = 10, face = "bold"),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 8),
        axis.text.x = element_text(size = 7, angle = 45, hjust = 1),
        axis.text.y = element_text(size = 7),
        legend.title = element_blank()) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10)) +
  scale_y_continuous(labels= scales::percent_format(accuracy = 1L), 
                     breaks=seq(0, 1, 0.2)) +
  facet_wrap(~fct_relevel(country_f, "Total", after = Inf), ncol = 3)

ggsave(filename = "salidas/simpatiza_partido_estatus.png", dpi = 300, type = "cairo", width = 8, height = 6)

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(estatus_ocup_f, simpatiza_partido) %>% 
  group_by(estatus_ocup_f, simpatiza_partido) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "estatus_ocup_f", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  flextable() %>% 
  save_as_docx(path = "salidas/simpatiapolitica_estatusocup.docx")

lapop2004_2018 %>% 
  filter(wave == 2018) %>% 
  drop_na(estatus_ocup_f, simpatiza_partido) %>% 
  group_by(estatus_ocup_f, simpatiza_partido) %>% 
  tally() %>% 
  mutate(porcentaje = n/sum(n)) %>% 
  pivot_wider(!n, names_from = "estatus_ocup_f", values_from = "porcentaje") %>% 
  adorn_totals() %>% 
  adorn_pct_formatting() %>% 
  kbl() %>%
  kable_styling()

```

# Modelos Multinivel 2008-2018


```{r Modelo multinivel ICC, echo=FALSE, warning=FALSE, message=FALSE}

base_ml <- lapop2004_2018 %>% 
  mutate(pais_anio = paste(country_f, wave, sep = "_")) %>% 
  drop_na(democracia7, reduc_desigualdad, categoria_ocup_f, ideologia_imp, sexo, 
         q2, ed, desempleo, informalidad, empleo_publico, brecha_remun)

democracia_null <- lmer(democracia7 ~ 1 + (1 | pais_anio), data = base_ml)

reduc_desigualdad_null <- lmer(reduc_desigualdad ~ 1 + (1 | pais_anio), data = base_ml)

voto_pasado_null <- glmer(voto_pasado ~ 1 + (1 | pais_anio), data = base_ml,
                         family=binomial(link="logit"),
                          control = glmerControl(optimizer = "bobyqa", 
                                                optCtrl = list(maxfun=2e5)))

voto_presente_null <- glmer(voto_presente ~ 1 + (1 | pais_anio), data = base_ml,
                           family=binomial(link="logit"),
                          control = glmerControl(optimizer = "bobyqa", 
                                                optCtrl = list(maxfun=2e5)))

ideologia_null <- lmer(ideologia ~ 1 + (1 | pais_anio), data = base_ml)

```

El **ICC** para la variable objetivo de _acuerdo con la democracia_ es de **`r round(icc(democracia_null), digits = 3)`**.  

El **ICC** para la variable objetivo de _reducción de la desigualdad_ es de **`r round(icc(reduc_desigualdad_null), digits = 3)`**.

El **ICC** para la variable objetivo de _voto pasado_ es de **`r round(icc(voto_pasado_null), digits = 3)`**.

El **ICC** para la variable objetivo de _voto presente_ es de **`r round(icc(voto_presente_null), digits = 3)`**.


```{r Centrado de variables, echo=FALSE, warning=FALSE, message=FALSE}

#Centrado de variables
base_ml$sexo_dic <- car::recode(base_ml$sex, "2=0")

base_ml$patron <- ifelse(base_ml$categoria_ocup == 1, 1, 0) 
base_ml$asal_pub <- ifelse(base_ml$categoria_ocup == 2, 1, 0) 
base_ml$asal_pri <- ifelse(base_ml$categoria_ocup == 3, 1, 0)
base_ml$cuenta_prop <- ifelse(base_ml$categoria_ocup == 4, 1, 0)
base_ml$desocupado <- ifelse(base_ml$categoria_ocup == 5, 1, 0)

base_ml <- base_ml %>% 
  mutate(sexo_cwc = sexo_dic - ave(sexo_dic, pais_anio),
         edad_cwc = q2 - ave(q2, pais_anio, FUN=function(x) mean(x, na.rm=T)),
         educ_cwc = ed - ave(ed, pais_anio, FUN=function(x) mean(x, na.rm=T)),
         patron_cwc = patron - ave(patron, pais_anio, 
                                   FUN=function(x) mean(x, na.rm=T)),
         asal_pub_cwc = asal_pub - ave(asal_pub, pais_anio, 
                                   FUN=function(x) mean(x, na.rm=T)),
         asal_pri_cwc = asal_pri - ave(asal_pri, pais_anio, 
                                   FUN=function(x) mean(x, na.rm=T)),
         cuenta_prop_cwc = cuenta_prop - ave(cuenta_prop, pais_anio, 
                                   FUN=function(x) mean(x, na.rm=T)),
         desocupado_cwc = desocupado - ave(desocupado, pais_anio, 
                                   FUN=function(x) mean(x, na.rm=T)),
         ideologia_cwc = ideologia_imp - ave(ideologia_imp, pais_anio),
         desempleo_cgm = (desempleo - mean(desempleo))*100,
         informalidad_cgm = (informalidad - mean(informalidad))*100,
         empleo_pub_cgm = (empleo_publico - mean(empleo_publico))*100,
         brecha_remun_cgm = (brecha_remun - mean(brecha_remun))*100)

```

## Multinivel democracia


```{r Multinivel democracia, echo=FALSE, warning=FALSE, message=FALSE, results='asis'}

democracia_ind <- lmer(democracia7 ~ 1 + patron_cwc + asal_pub_cwc + asal_pri_cwc + 
                         cuenta_prop_cwc + desocupado_cwc + ideologia_cwc + sexo_cwc +
                         edad_cwc + educ_cwc + (1 | pais_anio), 
                         data = base_ml,
                       REML = F)

democracia_ind_grup <- lmer(democracia7 ~ 1 + patron_cwc + asal_pub_cwc + asal_pri_cwc + 
                         cuenta_prop_cwc + desocupado_cwc + ideologia_cwc + sexo_cwc +
                         edad_cwc + educ_cwc + desempleo_cgm + informalidad_cgm +
                         empleo_pub_cgm + brecha_remun_cgm + (1 | pais_anio), 
                         data = base_ml,
                       REML = F)

democracia_ind_grup_int <- lmer(democracia7 ~ 1 + patron_cwc + asal_pub_cwc + asal_pri_cwc + 
                         cuenta_prop_cwc + desocupado_cwc + ideologia_cwc + sexo_cwc +
                         edad_cwc + educ_cwc + desempleo_cgm + informalidad_cgm +
                         empleo_pub_cgm + brecha_remun_cgm + desocupado_cwc*desempleo_cgm + 
                           (1 | pais_anio), 
                         data = base_ml,
                       REML = F)

democracia_random_apub <- lmer(democracia7 ~ 1 + patron_cwc + asal_pub_cwc + asal_pri_cwc + 
                         cuenta_prop_cwc + desocupado_cwc + ideologia_cwc + sexo_cwc +
                         edad_cwc + educ_cwc + desempleo_cgm + informalidad_cgm +
                         empleo_pub_cgm + brecha_remun_cgm + desocupado_cwc*desempleo_cgm + (1 + asal_pub_cwc | pais_anio), 
                         data = base_ml,
                       REML = F)

democracia_random_apri <- lmer(democracia7 ~ 1 + patron_cwc + asal_pub_cwc + asal_pri_cwc + 
                         cuenta_prop_cwc + desocupado_cwc + ideologia_cwc + sexo_cwc +
                         edad_cwc + educ_cwc + desempleo_cgm + informalidad_cgm +
                         empleo_pub_cgm + brecha_remun_cgm + desocupado_cwc*desempleo_cgm + (1 + asal_pri_cwc | pais_anio), 
                         data = base_ml,
                       REML = F)

democracia_random_cuent <- lmer(democracia7 ~ 1 + patron_cwc + asal_pub_cwc + asal_pri_cwc + 
                         cuenta_prop_cwc + desocupado_cwc + ideologia_cwc + sexo_cwc +
                         edad_cwc + educ_cwc + desempleo_cgm + informalidad_cgm +
                         empleo_pub_cgm + brecha_remun_cgm + desocupado_cwc*desempleo_cgm + (1 + cuenta_prop_cwc | pais_anio), 
                         data = base_ml,
                       REML = F)

democracia_random_desoc <- lmer(democracia7 ~ 1 + patron_cwc + asal_pub_cwc + asal_pri_cwc + 
                         cuenta_prop_cwc + desocupado_cwc + ideologia_cwc + sexo_cwc +
                         edad_cwc + educ_cwc + desempleo_cgm + informalidad_cgm +
                         empleo_pub_cgm + brecha_remun_cgm + desocupado_cwc*desempleo_cgm + 
                           (1 + desocupado_cwc | pais_anio), 
                         data = base_ml,
                       REML = F)

tab_model(democracia_ind, democracia_ind_grup, democracia_ind_grup_int,
          democracia_random_apub, democracia_random_apri, democracia_random_cuent,
          democracia_random_desoc,
             p.style = "stars",
             show.ci = F,
             show.icc = FALSE,
             show.aic = T,
             dv.labels = c("Ind", "Ind + grup", "Ind + grup + int", "Random_apub",
                           "Random_apri", "Random_cuent",
                           "Random_desoc"),
             pred.labels = c("Intercepto", "Patrón", "Asalariado pub.", "Asalariado priv.",
                              "Cuenta propia",
                              "Desocupado", "Ideología (der-izq)",
                              "Varón", "Edad", "Años educ.", "Desempleo", "Informalidad",
                              "Empleo pub.", "Brecha remun.", "Desocupado*desempleo"),
          file = "salidas/multilevel_democracia.doc")

```


```{r ajustes democracia, warning=FALSE, message=FALSE, echo=FALSE}
anova(democracia_null, democracia_ind)
anova(democracia_ind, democracia_ind_grup)
anova(democracia_ind_grup, democracia_ind_grup_int)
anova(democracia_ind_grup_int, democracia_random_apub)
anova(democracia_ind_grup_int, democracia_random_apri)
anova(democracia_ind_grup_int, democracia_random_cuent)
anova(democracia_ind_grup_int, democracia_random_desoc)

```


```{r Pseudo R2 1, echo=FALSE, warning=FALSE, message=FALSE}

varcomp_0=as.data.frame(VarCorr(democracia_null))
tau00_0=varcomp_0[1,4]
sigma2_0=varcomp_0[2,4]

varcomp_1=as.data.frame(VarCorr(democracia_ind))
tau00_1=varcomp_1[1,4]
sigma2_1=varcomp_1[2,4]

varcomp_2=as.data.frame(VarCorr(democracia_ind_grup))
tau00_2=varcomp_2[1,4]
sigma2_2=varcomp_2[2,4]

varcomp_3=as.data.frame(VarCorr(democracia_ind_grup_int))
tau00_3=varcomp_3[1,4]
sigma2_3=varcomp_3[2,4]

varcomp_4=as.data.frame(VarCorr(democracia_random_apub))
tau00_4=varcomp_4[1,4]
sigma2_4=varcomp_4[2,4]

varcomp_5=as.data.frame(VarCorr(democracia_random_apri))
tau00_5=varcomp_5[1,4]
sigma2_5=varcomp_5[2,4]


R2_ind_m1=(sigma2_0-sigma2_1)/sigma2_0
R2_grup_m1=(tau00_0-tau00_1)/tau00_0

R2_ind_m2=(sigma2_0-sigma2_2)/sigma2_0
R2_grup_m2=(tau00_0-tau00_2)/tau00_0

R2_ind_m3=(sigma2_0-sigma2_3)/sigma2_0
R2_grup_m3=(tau00_0-tau00_3)/tau00_0

R2_ind_m4=(sigma2_0-sigma2_4)/sigma2_0
R2_grup_m4=(tau00_0-tau00_4)/tau00_0

```


**Importante**  
El test de devianza muestra que los modelos de pendiente aleatoria para los **cuentapropia** y para **desocupados** no mejoran el ajuste.
El pseudo r2 para el segundo nivel (países años) 

* en el modelo con predictores individuales es de **`r R2_grup_m1`**,  
* en el modelo de predictores individuales y grupales es de  **`r R2_grup_m2`**, 
* en el modelo con interacciones es de **`r R2_grup_m3`**,
* en el los modelos de pendiente aleatoria es de **`r R2_grup_m4`**.

```{r gráficos democracia multinivel, warning=FALSE, message=FALSE, echo=FALSE}
reg_coef <- plot_summs(democracia_ind_grup_int, ci_level = 0.95,
                       omit.coefs = "(Intercept)",
                       coefs = c("Patrón (ref: inactivos)" = "patron_cwc", 
                                 "Asalariado pub." = "asal_pub_cwc", 
                                 "Asalariado priv." = "asal_pri_cwc",
                                 "Cuenta propia" = "cuenta_prop_cwc",
                                 "Desocupado" = "desocupado_cwc", 
                                 "Ideología (der-izq)" = "ideologia_cwc",
                                 "Varón (ref: Mujer)" = "sexo_cwc", 
                                 "Edad" = "edad_cwc", 
                                 "Años educ." = "educ_cwc", 
                                 "Nivel de desempleo" = "desempleo_cgm", 
                                 "Nivel de Informalidad" = "informalidad_cgm",
                                 "Nivel de Empleo pub." = "empleo_pub_cgm", 
                                 "Brecha remuneraciones" = "brecha_remun_cgm",
                                 "Desocupado*desempleo" = "desocupado_cwc:desempleo_cgm"))

reg_coef +
  theme_light() +
  labs(title = "Efectos sobre la percepción de la democracia como \nmejor forma de gobierno",
       subtitle = "Países seleccionados 2008-2018. Regresión lineal multinivel",
         caption = "Fuente: elaboración propia en base a LAPOP 2008-2018") +
  theme(axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_text(size = 9),
        axis.text.y = element_text(size = 8),
        legend.position= "bottom",
        panel.background = element_rect(fill = "transparent", colour = NA),
        plot.background = element_rect(fill = "transparent", colour = NA),
        legend.key = element_rect(fill = "transparent", colour = NA),
        legend.background= element_rect(fill = "transparent", colour = NA)) +
  scale_x_continuous(breaks = seq(-0.2, 0.1, by = .02))

ggsave(filename = "salidas/multilevel_democracia.png", dpi = 300, type = "cairo", width = 8, height = 6, bg='white')


```


## Multinivel reducción desigualdad

```{r Multinivel reducción desigualdad, echo=FALSE, warning=FALSE, message=FALSE, results='asis'}

reduc_desigualdad_ind <- lmer(reduc_desigualdad ~ 1 + patron_cwc + asal_pub_cwc + asal_pri_cwc + 
                         cuenta_prop_cwc + desocupado_cwc + ideologia_cwc + sexo_cwc +
                         edad_cwc + educ_cwc + (1 | pais_anio), data = base_ml,
                       REML = F)

reduc_desigualdad_ind_grup <- lmer(reduc_desigualdad  ~ 1 + patron_cwc + asal_pub_cwc +
                                     asal_pri_cwc + cuenta_prop_cwc + desocupado_cwc +
                                     ideologia_cwc + sexo_cwc +
                         edad_cwc + educ_cwc + desempleo_cgm + informalidad_cgm +
                         empleo_pub_cgm + brecha_remun_cgm + (1 | pais_anio), 
                         data = base_ml,
                       REML = F)

reduc_desigualdad_random_apub <- lmer(reduc_desigualdad  ~ 1 + patron_cwc + asal_pub_cwc + asal_pri_cwc + 
                         cuenta_prop_cwc + desocupado_cwc + ideologia_cwc + sexo_cwc +
                         edad_cwc + educ_cwc + desempleo_cgm + informalidad_cgm +
                         empleo_pub_cgm + brecha_remun_cgm + (1 + asal_pub_cwc | pais_anio), 
                         data = base_ml,
                       REML = F)

reduc_desigualdad_random_apri <- lmer(reduc_desigualdad ~ 1 + patron_cwc + asal_pub_cwc + asal_pri_cwc + 
                         cuenta_prop_cwc + desocupado_cwc + ideologia_cwc + sexo_cwc +
                         edad_cwc + educ_cwc + desempleo_cgm + informalidad_cgm +
                         empleo_pub_cgm + brecha_remun_cgm + (1 + asal_pri_cwc | pais_anio), 
                         data = base_ml,
                       REML = F)

reduc_desigualdad_random_cuent <- lmer(reduc_desigualdad ~ 1 + patron_cwc + asal_pub_cwc + asal_pri_cwc + 
                         cuenta_prop_cwc + desocupado_cwc + ideologia_cwc + sexo_cwc +
                         edad_cwc + educ_cwc + desempleo_cgm + informalidad_cgm +
                         empleo_pub_cgm + brecha_remun_cgm + (1 + cuenta_prop_cwc | pais_anio), 
                         data = base_ml,
                       REML = F)

tab_model(reduc_desigualdad_ind, reduc_desigualdad_ind_grup,
             reduc_desigualdad_random_apub, reduc_desigualdad_random_apri,
             reduc_desigualdad_random_cuent,
             p.style = "stars",
             show.ci = F,
             show.icc = FALSE,
             show.aic = T,
             dv.labels = c("Ind", "Ind + grup", "Random_apub",
                           "Random_apri", "Random_cuent"),
             pred.labels = c("Intercepto", "Patrón", "Asalariado pub.", "Asalariado priv.",
                              "Cuenta propia",
                              "Desocupado", "Ideología (der-izq)",
                              "Varón", "Edad", "Años educ.", "Desempleo", "Informalidad",
                              "Empleo pub.", "Brecha remun."),
          file = "salidas/reduccion_desigualdad_multilevel.doc")

```


```{r ajustes desigualdad, warning=FALSE, message=FALSE, echo=FALSE}
anova(reduc_desigualdad_null, reduc_desigualdad_ind)
anova(reduc_desigualdad_ind, reduc_desigualdad_ind_grup)

```

**Importante**  
Para la variable objetivo *reducción de la desigualdad* la prueba de devianza muestra que el modelo con variables contextuales agregadas no mejora el ajuste por sobre el modelo de variables individuales.  

```{r gráficos reducción pobreza multinivel, warning=FALSE, message=FALSE, echo=FALSE}
reg_coef <- plot_summs(reduc_desigualdad_ind, ci_level = 0.95,
                       omit.coefs = "(Intercept)",
                       coefs = c("Patrón (ref: inactivos)" = "patron_cwc", 
                                 "Asalariado pub." = "asal_pub_cwc", 
                                 "Asalariado priv." = "asal_pri_cwc",
                                 "Cuenta propia" = "cuenta_prop_cwc",
                                 "Desocupado" = "desocupado_cwc", 
                                 "Ideología (der-izq)" = "ideologia_cwc",
                                 "Varón (ref: Mujer)" = "sexo_cwc", 
                                 "Edad" = "edad_cwc", 
                                 "Años educ." = "educ_cwc", 
                                 "Nivel de desempleo" = "desempleo_cgm", 
                                 "Nivel de Informalidad" = "informalidad_cgm",
                                 "Nivel de Empleo pub." = "empleo_pub_cgm", 
                                 "Brecha remuneraciones" = "brecha_remun_cgm",
                                 "Desocupado*desempleo" = "desocupado_cwc:desempleo_cgm"))

reg_coef +
  theme_light() +
  labs(title = "Efectos sobre el grado de acuerdo en la implementación de \npolíticas firmes para reducir la desigualdad de ingresos entre ricos y pobres",
       subtitle = "Países seleccionados 2008-2018. Regresión lineal multinivel",
         caption = "Fuente: elaboración propia en base a LAPOP 2008-2018") +
  theme(axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_text(size = 9),
        axis.text.y = element_text(size = 8),
        legend.position= "bottom",
        panel.background = element_rect(fill = "transparent", colour = NA),
        plot.background = element_rect(fill = "transparent", colour = NA),
        legend.key = element_rect(fill = "transparent", colour = NA),
        legend.background= element_rect(fill = "transparent", colour = NA)) +
  scale_x_continuous(breaks = seq(-0.2, 0.2, by = .02))

ggsave(filename = "salidas/multilevel_desigualdad.png", dpi = 300, type = "cairo", width = 8, height = 6, bg='white')

```


## Multinivel voto pasado

```{r Multinivel voto pasado, echo=FALSE, warning=FALSE, message=FALSE, results='asis'}

voto_pasado_ind <- glmer(voto_pasado ~ patron_cwc + asal_pub_cwc + asal_pri_cwc + 
                          cuenta_prop_cwc + 
                         desocupado_cwc + ideologia_cwc + sexo_cwc +
                         edad_cwc + educ_cwc + (1 | pais_anio), 
                         data = base_ml,
                         family=binomial(link="logit"))

voto_pasado_ind_grup <- glmer(voto_pasado ~ patron_cwc + asal_pub_cwc + asal_pri_cwc + 
                          cuenta_prop_cwc + desocupado_cwc +
                        ideologia_cwc + sexo_cwc +
                         edad_cwc + educ_cwc + desempleo_cgm + informalidad_cgm +
                         empleo_pub_cgm + brecha_remun_cgm + (1 | pais_anio), 
                         data = base_ml,
                         family=binomial(link="logit"))

voto_pasado_ind_grup_int <- glmer(voto_pasado ~ patron_cwc + asal_pub_cwc + asal_pri_cwc + 
                          cuenta_prop_cwc + 
                           desocupado_cwc + ideologia_cwc + sexo_cwc +
                         edad_cwc + educ_cwc + desempleo_cgm + informalidad_cgm +
                         empleo_pub_cgm + brecha_remun_cgm + desocupado_cwc*desempleo_cgm + 
                           (1 | pais_anio), 
                         data = base_ml,
                         family=binomial(link="logit"))

voto_pasado_random_apub <- glmer(voto_pasado ~ patron_cwc + asal_pub_cwc + asal_pri_cwc + 
                          cuenta_prop_cwc + 
                           desocupado_cwc + ideologia_cwc + sexo_cwc +
                         edad_cwc + educ_cwc + desempleo_cgm + informalidad_cgm +
                         empleo_pub_cgm + brecha_remun_cgm + desocupado_cwc*desempleo_cgm + 
                           (1 + asal_pub_cwc | pais_anio), 
                         data = base_ml,
                         family=binomial(link="logit"))

voto_pasado_random_apri <- glmer(voto_pasado ~ patron_cwc + asal_pub_cwc + asal_pri_cwc + 
                          cuenta_prop_cwc + 
                           desocupado_cwc + ideologia_cwc + sexo_cwc +
                         edad_cwc + educ_cwc + desempleo_cgm + informalidad_cgm +
                         empleo_pub_cgm + brecha_remun_cgm + desocupado_cwc*desempleo_cgm + 
                           (1 + asal_pri_cwc | pais_anio), 
                         data = base_ml,
                         family=binomial(link="logit"))

voto_pasado_random_cuent <- glmer(voto_pasado ~ patron_cwc + asal_pub_cwc + 
                                        asal_pri_cwc + 
                          cuenta_prop_cwc + 
                           desocupado_cwc + ideologia_cwc + sexo_cwc +
                         edad_cwc + educ_cwc + desempleo_cgm + informalidad_cgm +
                         empleo_pub_cgm + brecha_remun_cgm + desocupado_cwc*desempleo_cgm + 
                           (1 + cuenta_prop_cwc | pais_anio), 
                         data = base_ml,
                         family=binomial(link="logit"))


voto_pasado_random_desoc <- glmer(voto_pasado ~ patron_cwc + asal_pub_cwc + asal_pri_cwc + 
                          cuenta_prop_cwc + 
                           desocupado_cwc + ideologia_cwc + sexo_cwc +
                         edad_cwc + educ_cwc + desempleo_cgm + informalidad_cgm +
                         empleo_pub_cgm + brecha_remun_cgm + desocupado_cwc*desempleo_cgm + 
                           (1 + desocupado_cwc | pais_anio), 
                         data = base_ml,
                         family=binomial(link="logit"))


tab_model(voto_pasado_ind, voto_pasado_ind_grup, voto_pasado_ind_grup_int,
             voto_pasado_random_apub, voto_pasado_random_apri,
             voto_pasado_random_cuent,
             p.style = "stars",
             show.ci = F,
             show.icc = FALSE,
             show.aic = T,
             dv.labels = c("Ind", "Ind + grup", "voto_pasado_ind_grup_int", "Random_apub",
                           "Random_apri", "Random_cuent"),
             pred.labels = c("Intercepto", "Patrón", "Asalariado pub.", "Asalariado priv.",
                              "Cuenta propia",
                              "Desocupado", "Ideología (der-izq)",
                              "Varón", "Edad", "Años educ.", "Desempleo", "Informalidad",
                              "Empleo pub.", "Brecha remun.", "Desocupado*desempleo"),
          file = "salidas/multilevel_votopasado.doc")

```

```{r ajustes voto pasado, warning=FALSE, message=FALSE, echo=FALSE}
anova(voto_pasado_null, voto_pasado_ind)
anova(voto_pasado_ind, voto_pasado_ind_grup)
anova(voto_pasado_ind_grup, voto_pasado_ind_grup_int)
anova(voto_pasado_ind_grup_int, voto_pasado_random_apub)
anova(voto_pasado_ind_grup_int, voto_pasado_random_apri)
anova(voto_pasado_ind_grup_int, voto_pasado_random_cuent)
anova(voto_pasado_ind_grup_int, voto_pasado_random_desoc)

```

```{r gráficos voto pasado multinivel, warning=FALSE, message=FALSE, echo=FALSE}
reg_coef <- plot_summs(voto_pasado_ind_grup, ci_level = 0.95, exp = T,
                       omit.coefs = "(Intercept)",
                       coefs = c("Patrón (ref: inactivos)" = "patron_cwc", 
                                 "Asalariado pub." = "asal_pub_cwc", 
                                 "Asalariado priv." = "asal_pri_cwc",
                                 "Cuenta propia" = "cuenta_prop_cwc",
                                 "Desocupado" = "desocupado_cwc", 
                                 "Ideología (der-izq)" = "ideologia_cwc",
                                 "Varón (ref: Mujer)" = "sexo_cwc", 
                                 "Edad" = "edad_cwc", 
                                 "Años educ." = "educ_cwc", 
                                 "Nivel de desempleo" = "desempleo_cgm", 
                                 "Nivel de Informalidad" = "informalidad_cgm",
                                 "Nivel de Empleo pub." = "empleo_pub_cgm", 
                                 "Brecha remuneraciones" = "brecha_remun_cgm",
                                 "Desocupado*desempleo" = "desocupado_cwc:desempleo_cgm"))

reg_coef +
  theme_light() +
  labs(title = "Oportunidades relativas de haber votado en elecciones pasadas",
       subtitle = "Países seleccionados 2008-2018. Regresión logística multinivel. \nCoeficientes exponenciados",
         caption = "Fuente: elaboración propia en base a LAPOP 2008-2018") +
  theme(axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_text(size = 9),
        axis.text.y = element_text(size = 8),
        legend.position= "bottom",
        panel.background = element_rect(fill = "transparent", colour = NA),
        plot.background = element_rect(fill = "transparent", colour = NA),
        legend.key = element_rect(fill = "transparent", colour = NA),
        legend.background= element_rect(fill = "transparent", colour = NA))

ggsave(filename = "salidas/multilevel_votopasado.png", dpi = 300, type = "cairo", width = 8, height = 6, bg='white')


```

## Multinivel voto presente

```{r Multinivel voto presente, echo=FALSE, warning=FALSE, message=FALSE, results='asis'}

voto_presente_ind <- glmer(voto_presente ~ patron_cwc + asal_pub_cwc + asal_pri_cwc + 
                          cuenta_prop_cwc + 
                         desocupado_cwc + ideologia_cwc + sexo_cwc +
                         edad_cwc + educ_cwc + (1 | pais_anio), 
                         data = base_ml,
                         family=binomial(link="logit"))

voto_presente_ind_grup <- glmer(voto_presente ~ patron_cwc + asal_pub_cwc + asal_pri_cwc + 
                          cuenta_prop_cwc + desocupado_cwc +
                        ideologia_cwc + sexo_cwc +
                         edad_cwc + educ_cwc + desempleo_cgm + informalidad_cgm +
                         empleo_pub_cgm + brecha_remun_cgm + (1 | pais_anio), 
                         data = base_ml,
                         family=binomial(link="logit"))

voto_presente_ind_grup_int <- glmer(voto_presente ~ patron_cwc + asal_pub_cwc + asal_pri_cwc + 
                          cuenta_prop_cwc + 
                           desocupado_cwc + ideologia_cwc + sexo_cwc +
                         edad_cwc + educ_cwc + desempleo_cgm + informalidad_cgm +
                         empleo_pub_cgm + brecha_remun_cgm + desocupado_cwc*desempleo_cgm + 
                           (1 | pais_anio), 
                         data = base_ml,
                         family=binomial(link="logit"))

voto_presente_random_apub <- glmer(voto_presente ~ patron_cwc + asal_pub_cwc + asal_pri_cwc + 
                          cuenta_prop_cwc + 
                           desocupado_cwc + ideologia_cwc + sexo_cwc +
                         edad_cwc + educ_cwc + desempleo_cgm + informalidad_cgm +
                         empleo_pub_cgm + brecha_remun_cgm + desocupado_cwc*desempleo_cgm + 
                           (1 + asal_pub_cwc | pais_anio), 
                         data = base_ml,
                         family=binomial(link="logit"))

voto_presente_random_apri <- glmer(voto_presente ~ patron_cwc + asal_pub_cwc + asal_pri_cwc + 
                          cuenta_prop_cwc + 
                           desocupado_cwc + ideologia_cwc + sexo_cwc +
                         edad_cwc + educ_cwc + desempleo_cgm + informalidad_cgm +
                         empleo_pub_cgm + brecha_remun_cgm + desocupado_cwc*desempleo_cgm + 
                           (1 + asal_pri_cwc | pais_anio), 
                         data = base_ml,
                         family=binomial(link="logit"))

voto_presente_random_cuent <- glmer(voto_presente ~ patron_cwc + asal_pub_cwc + 
                                        asal_pri_cwc + 
                          cuenta_prop_cwc + 
                           desocupado_cwc + ideologia_cwc + sexo_cwc +
                         edad_cwc + educ_cwc + desempleo_cgm + informalidad_cgm +
                         empleo_pub_cgm + brecha_remun_cgm + desocupado_cwc*desempleo_cgm + 
                           (1 + cuenta_prop_cwc | pais_anio), 
                         data = base_ml,
                         family=binomial(link="logit"))


voto_presente_random_desoc <- glmer(voto_presente ~ patron_cwc + asal_pub_cwc + asal_pri_cwc + 
                          cuenta_prop_cwc + 
                           desocupado_cwc + ideologia_cwc + sexo_cwc +
                         edad_cwc + educ_cwc + desempleo_cgm + informalidad_cgm +
                         empleo_pub_cgm + brecha_remun_cgm + desocupado_cwc*desempleo_cgm + 
                           (1 + desocupado_cwc | pais_anio), 
                         data = base_ml,
                         family=binomial(link="logit"))


tab_model(voto_presente_ind, voto_presente_ind_grup, voto_presente_ind_grup_int,
             voto_presente_random_apub, voto_presente_random_apri,
             voto_presente_random_cuent,
             p.style = "stars",
             show.ci = F,
             show.icc = FALSE,
             show.aic = T,
             dv.labels = c("Ind", "Ind + grup", "Ind + grup + int", "Random_apub",
                           "Random_apri", "Random_cuent"),
             pred.labels = c("Intercepto", "Patrón", "Asalariado pub.", "Asalariado priv.",
                              "Cuenta propia",
                              "Desocupado", "Ideología (der-izq)",
                              "Varón", "Edad", "Años educ.", "Desempleo", "Informalidad",
                              "Empleo pub.", "Brecha remun.", "Desocupado*desempleo"),
          file = "salidas/multilevel_votopasado.doc")

```

```{r ajustes voto presente, warning=FALSE, message=FALSE, echo=FALSE}
anova(voto_presente_null, voto_presente_ind)
anova(voto_presente_ind, voto_presente_ind_grup)
anova(voto_presente_ind_grup, voto_presente_ind_grup_int)
anova(voto_presente_ind_grup_int, voto_presente_random_apub)
anova(voto_presente_ind_grup_int, voto_presente_random_apri)
anova(voto_presente_ind_grup_int, voto_presente_random_cuent)
anova(voto_presente_ind_grup_int, voto_presente_random_desoc)

```



```{r gráficos voto presente multinivel, warning=FALSE, message=FALSE, echo=FALSE}
reg_coef <- plot_summs(voto_presente_ind_grup_int, ci_level = 0.95, exp = T,
                       omit.coefs = "(Intercept)",
                       coefs = c("Patrón (ref: inactivos)" = "patron_cwc", 
                                 "Asalariado pub." = "asal_pub_cwc", 
                                 "Asalariado priv." = "asal_pri_cwc",
                                 "Cuenta propia" = "cuenta_prop_cwc",
                                 "Desocupado" = "desocupado_cwc", 
                                 "Ideología (der-izq)" = "ideologia_cwc",
                                 "Varón (ref: Mujer)" = "sexo_cwc", 
                                 "Edad" = "edad_cwc", 
                                 "Años educ." = "educ_cwc", 
                                 "Nivel de desempleo" = "desempleo_cgm", 
                                 "Nivel de Informalidad" = "informalidad_cgm",
                                 "Nivel de Empleo pub." = "empleo_pub_cgm", 
                                 "Brecha remuneraciones" = "brecha_remun_cgm",
                                 "Desocupado*desempleo" = "desocupado_cwc:desempleo_cgm"))

reg_coef +
  theme_light() +
  labs(title = "Oportunidades relativas de votar en el presente",
       subtitle = "Países seleccionados 2008-2018. Regresión logística multinivel. \nCoeficientes exponenciados",
         caption = "Fuente: elaboración propia en base a LAPOP 2008-2018") +
  theme(axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_text(size = 9),
        axis.text.y = element_text(size = 8),
        legend.position= "bottom",
        panel.background = element_rect(fill = "transparent", colour = NA),
        plot.background = element_rect(fill = "transparent", colour = NA),
        legend.key = element_rect(fill = "transparent", colour = NA),
        legend.background= element_rect(fill = "transparent", colour = NA))

ggsave(filename = "salidas/multilevel_votopresente.png", dpi = 300, type = "cairo", width = 8, height = 6, bg='white')

```

## Multinivel ideología

```{r Multinivel ideologia, echo=FALSE, warning=FALSE, message=FALSE, results='asis'}

ideologia_ind <- lmer(ideologia ~ 1 + patron_cwc + asal_pub_cwc + asal_pri_cwc + 
                         cuenta_prop_cwc + desocupado_cwc + sexo_cwc +
                         edad_cwc + educ_cwc + (1 | pais_anio), 
                         data = base_ml,
                       REML = F)

ideologia_ind_grup <- lmer(ideologia ~ 1 + patron_cwc + asal_pub_cwc + asal_pri_cwc + 
                         cuenta_prop_cwc + desocupado_cwc + sexo_cwc +
                         edad_cwc + educ_cwc + desempleo_cgm + informalidad_cgm +
                         empleo_pub_cgm + brecha_remun_cgm + (1 | pais_anio), 
                         data = base_ml,
                       REML = F)

ideologia_ind_grup_int <- lmer(ideologia ~ 1 + patron_cwc + asal_pub_cwc + asal_pri_cwc + 
                         cuenta_prop_cwc + desocupado_cwc + sexo_cwc +
                         edad_cwc + educ_cwc + desempleo_cgm + informalidad_cgm +
                         empleo_pub_cgm + brecha_remun_cgm + desocupado_cwc*desempleo_cgm + 
                           (1 | pais_anio), 
                         data = base_ml,
                       REML = F)

ideologia_random_apub <- lmer(ideologia ~ 1 + patron_cwc + asal_pub_cwc + asal_pri_cwc + 
                         cuenta_prop_cwc + desocupado_cwc + sexo_cwc +
                         edad_cwc + educ_cwc + desempleo_cgm + informalidad_cgm +
                         empleo_pub_cgm + brecha_remun_cgm + desocupado_cwc*desempleo_cgm + (1 + asal_pub_cwc | pais_anio), 
                         data = base_ml,
                       REML = F)

ideologia_random_apri <- lmer(ideologia ~ 1 + patron_cwc + asal_pub_cwc + asal_pri_cwc + 
                         cuenta_prop_cwc + desocupado_cwc + sexo_cwc +
                         edad_cwc + educ_cwc + desempleo_cgm + informalidad_cgm +
                         empleo_pub_cgm + brecha_remun_cgm + desocupado_cwc*desempleo_cgm + (1 + asal_pri_cwc | pais_anio), 
                         data = base_ml,
                       REML = F)

ideologia_random_cuent <- lmer(ideologia ~ 1 + patron_cwc + asal_pub_cwc + asal_pri_cwc + 
                         cuenta_prop_cwc + desocupado_cwc + sexo_cwc +
                         edad_cwc + educ_cwc + desempleo_cgm + informalidad_cgm +
                         empleo_pub_cgm + brecha_remun_cgm + desocupado_cwc*desempleo_cgm + (1 + cuenta_prop_cwc | pais_anio), 
                         data = base_ml,
                       REML = F)

ideologia_random_desoc <- lmer(ideologia ~ 1 + patron_cwc + asal_pub_cwc + asal_pri_cwc + 
                         cuenta_prop_cwc + desocupado_cwc + sexo_cwc +
                         edad_cwc + educ_cwc + desempleo_cgm + informalidad_cgm +
                         empleo_pub_cgm + brecha_remun_cgm + desocupado_cwc*desempleo_cgm + 
                           (1 + desocupado_cwc | pais_anio), 
                         data = base_ml,
                       REML = F)

tab_model(ideologia_ind, ideologia_ind_grup, ideologia_ind_grup_int,
          ideologia_random_apub, ideologia_random_apri, ideologia_random_cuent,
          ideologia_random_desoc,
             p.style = "stars",
             show.ci = F,
             show.icc = FALSE,
             show.aic = T,
             dv.labels = c("Ind", "Ind + grup", "Ind + grup + int", "Random_apub",
                           "Random_apri", "Random_cuent",
                           "Random_desoc"),
             pred.labels = c("Intercepto", "Patrón", "Asalariado pub.", "Asalariado priv.",
                              "Cuenta propia",
                              "Desocupado",
                              "Varón", "Edad", "Años educ.", "Desempleo", "Informalidad",
                              "Empleo pub.", "Brecha remun.", "Desocupado*desempleo"),
          file = "salidas/multilevel_ideologia.doc")

```


```{r ajustes ideologia, warning=FALSE, message=FALSE, echo=FALSE}
anova(ideologia_null, ideologia_ind)
anova(ideologia_ind, ideologia_ind_grup)
anova(ideologia_ind_grup, ideologia_ind_grup_int)
anova(ideologia_ind_grup_int, ideologia_random_apub)
anova(ideologia_ind_grup_int, ideologia_random_apri)
anova(ideologia_ind_grup_int, ideologia_random_cuent)
anova(ideologia_ind_grup_int, ideologia_random_desoc)

```



# Modelos de efectos fijos (2018) 

## Utilizando todas las variables laborales

```{r modelos efectos fijos 1, warning=FALSE, message=FALSE, echo=FALSE, results='asis'}

lapop2018 <- lapop2004_2018 %>% 
  filter(wave == 2018)

lapop2018$estatus_ocup_f <- relevel(lapop2018$estatus_ocup_f, ref = "No ocupados")
lapop2018$formal_estado2 <- relevel(lapop2018$formal_estado2, ref = "No ocupados")
lapop2018$formal_estado <- relevel(lapop2018$formal_estado, ref = "Inactivo")
lapop2018$categoria_ocup_f <- relevel(lapop2018$categoria_ocup_f, ref = "Inactivo")
lapop2018$sexo <- relevel(lapop2018$sexo, ref = "Mujer")

democracia_fijo <- plm(democracia7 ~ categoria_ocup_f + formal_estado2 + estatus_ocup_f +
                         ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018, index=c("country_f"), model="within")

desigualdad_fijo <- plm(reduc_desigualdad ~ categoria_ocup_f + formal_estado2 +
                          estatus_ocup_f + ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018, index=c("country_f"), model="within")

desempleados_fijo <- plm(desempleados ~ categoria_ocup_f + formal_estado2 +
                          estatus_ocup_f + ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018, index=c("country_f"), model="within")

ayuda_pobres_fijo <- plm(ayuda_pobres ~ categoria_ocup_f + formal_estado2 +
                          estatus_ocup_f + ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018, index=c("country_f"), model="within")

impuestos_ricos_fijo <- plm(impuestos_ricos ~ categoria_ocup_f + formal_estado2 +
                          estatus_ocup_f + ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018, index=c("country_f"), model="within")

tab_model(democracia_fijo, desigualdad_fijo, desempleados_fijo, ayuda_pobres_fijo,
          impuestos_ricos_fijo,
          p.style = "stars",
          show.ci = F,
          show.aic = T,
          dv.labels = c("Democracia", "Desigualdad", "Desempleados", "Ayuda pobres",
                        "Impuestos ricos"),
          pred.labels = c("Patrón", "Asalariado pub.", "Asalariado priv.",
                          "Cuenta propia", "Desocupado", "Formal", "Informal",
                          "Directivos-profesionales", "Téc-adm-vend", 
                          "Trab. Man. calif",
                          "Trab. Man. No calif", "Ideología (der-izq)", "Urbano",
                          "Varón", "Edad", "Años educ."),
          title = "Regresión lineal múltiple con control por países. 2018.",
          file = "salidas/efectosfijos_completo1.doc")

# 
# 
# htmlreg(list(democracia_fijo, desigualdad_fijo, desempleados_fijo, ayuda_pobres_fijo, impuestos_ricos_fijo),
#         custom.model.names = c("Democracia", "Desigualdad", "Desempleados", "Ayuda pobres", "Impuestos ricos"),
#         caption = "Con variables laborales",
#         caption.above = T,
#         type = "html", doctype = FALSE)

corrupcion_pub <- glm(corrup_func ~ categoria_ocup_f + formal_estado2 +
                          estatus_ocup_f + ideologia_imp + urbano + sexo + q2 + ed +
                        country_f, 
                       data=lapop2018, family=binomial(link="logit"))

golpe <- glm(golpe ~ categoria_ocup_f + formal_estado2 +
                          estatus_ocup_f + ideologia_imp + urbano + sexo + q2 + ed +
                        country_f, 
                       data=lapop2018, family=binomial(link="logit"))

cierre_congreso <- glm(cierre_congreso ~ categoria_ocup_f + formal_estado2 +
                          estatus_ocup_f + ideologia_imp + urbano + sexo + q2 + ed +
                        country_f, 
                       data=lapop2018, family=binomial(link="logit"))

cierre_corte <- glm(cierre_corte ~ categoria_ocup_f + formal_estado2 +
                          estatus_ocup_f + ideologia_imp + urbano + sexo + q2 + ed +
                        country_f, 
                       data=lapop2018, family=binomial(link="logit"))

simpatiza_partido <- glm(simpatiza_partido ~ categoria_ocup_f + formal_estado2 +
                          estatus_ocup_f + ideologia_imp + urbano + sexo + q2 + ed +
                        country_f, 
                       data=lapop2018, family=binomial(link="logit"))

tab_model(corrupcion_pub, golpe, cierre_congreso, cierre_corte, simpatiza_partido,
          p.style = "stars",
          show.ci = F,
          show.aic = T,
          dv.labels = c("Corrupción", "Golpe militar", "Cierre congreso", 
                        "Cierre corte", "Simpatiza partido"),
          pred.labels = c("Intercepto", "Patrón", "Asalariado pub.", "Asalariado priv.",
                          "Cuenta propia", "Desocupado", "Formal", "Informal",
                          "Directivos-profesionales", "Téc-adm-vend", 
                          "Trab. Man. calif",
                          "Trab. Man. No calif", "Ideología (der-izq)", "Urbano",
                          "Varón", "Edad", "Años educ."),
          title = "Regresión logística binaria con control por países. 2018.",
          rm.terms = c("country_fBrasil",
                       "country_fChile",
                       "country_fColombia",
                       "country_fMéxico",
                       "country_fPerú",
                       "country_fUruguay",
                       "country_fArgentina"),
          file = "salidas/efectosfijos_completo2.doc")

```

En el caso de las regresiones logísticas la categoría 1 de la variable dependiente siempre es la opción *más progre*.

```{r vif, warning=FALSE, message=FALSE, echo=FALSE}
democracia <- lm(democracia7 ~ categoria_ocup_f + formal_estado2 + estatus_ocup_f +
                         ideologia_imp + urbano + sexo + q2 + ed + country_f, data=lapop2018)

reduc_desigualdad <- lm(reduc_desigualdad ~ categoria_ocup_f + formal_estado2 + estatus_ocup_f +
                         ideologia_imp + urbano + sexo + q2 + ed + country_f, data=lapop2018)

car::vif(democracia)
car::vif(reduc_desigualdad)
car::vif(corrupcion_pub)
car::vif(golpe)
car::vif(cierre_congreso)
```

Para el caso de las regresiones logísticas no es recomendable utilizar las tres variables laborales ya que están altamente correlacionadas.



## Utilizando solo categoría laboral

```{r modelos efectos fijos 2, warning=FALSE, message=FALSE, echo=FALSE, results='asis'}

democracia_fijo <- plm(democracia7 ~ categoria_ocup_f  +
                         ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018, index=c("country_f"), model="within")

desigualdad_fijo <- plm(reduc_desigualdad ~ categoria_ocup_f + 
                          ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018, index=c("country_f"), model="within")

desempleados_fijo <- plm(desempleados ~ categoria_ocup_f + 
                           ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018, index=c("country_f"), model="within")

ayuda_pobres_fijo <- plm(ayuda_pobres ~ categoria_ocup_f + 
                           ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018, index=c("country_f"), model="within")

impuestos_ricos_fijo <- plm(impuestos_ricos ~ categoria_ocup_f 
                            + ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018, index=c("country_f"), model="within")

tab_model(democracia_fijo, desigualdad_fijo, desempleados_fijo, ayuda_pobres_fijo,
          impuestos_ricos_fijo,
          p.style = "stars",
          show.ci = F,
          show.aic = T,
          dv.labels = c("Democracia", "Desigualdad", "Desempleados", "Ayuda pobres",
                        "Impuestos ricos"),
          pred.labels = c("Patrón", "Asalariado pub.", "Asalariado priv.",
                          "Cuenta propia", "Desocupado", "Ideología (der-izq)", "Urbano",
                          "Varón", "Edad", "Años educ."),
          title = "Regresión lineal múltiple con control por países. 2018.",
          file = "salidas/efectosfijos_catlaboral1.doc")


corrupcion_pub <- glm(corrup_func ~ categoria_ocup_f + 
                        ideologia_imp + urbano + sexo + q2 + ed +
                        country_f, 
                       data=lapop2018, family=binomial(link="logit"))

golpe <- glm(golpe ~ categoria_ocup_f + ideologia_imp + urbano + sexo + q2 + ed +
                        country_f, 
                       data=lapop2018, family=binomial(link="logit"))

cierre_congreso <- glm(cierre_congreso ~ categoria_ocup_f + 
                         ideologia_imp + urbano + sexo + q2 + ed +
                        country_f, 
                       data=lapop2018, family=binomial(link="logit"))

cierre_corte <- glm(cierre_corte ~ categoria_ocup_f + 
                      ideologia_imp + urbano + sexo + q2 + ed +
                        country_f, 
                       data=lapop2018, family=binomial(link="logit"))

simpatiza_partido <- glm(simpatiza_partido ~ categoria_ocup_f  + 
                           ideologia_imp + urbano + sexo + q2 + ed +
                        country_f, 
                       data=lapop2018, family=binomial(link="logit"))

tab_model(corrupcion_pub, golpe, cierre_congreso, cierre_corte, simpatiza_partido,
          p.style = "stars",
          show.ci = F,
          show.aic = T,
          dv.labels = c("Corrupción", "Golpe militar", "Cierre congreso", 
                        "Cierre corte", "Simpatiza partido"),
          pred.labels = c("Intercepto", "Patrón", "Asalariado pub.", "Asalariado priv.",
                          "Cuenta propia", "Desocupado", "Ideología (der-izq)", "Urbano",
                          "Varón", "Edad", "Años educ."),
          title = "Regresión logística binaria con control por países. 2018.",
          rm.terms = c("country_fBrasil",
                       "country_fChile",
                       "country_fColombia",
                       "country_fMéxico",
                       "country_fPerú",
                       "country_fUruguay",
                       "country_fArgentina"),
          file = "salidas/efectosfijos_catlaboral2.doc")

```


```{r prueba efectos fijos 2, warning=FALSE, message=FALSE, echo=FALSE}
democracia <- lm(democracia7 ~ categoria_ocup_f +
                         ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018)

desigualdad <- lm(reduc_desigualdad ~ categoria_ocup_f +
                          ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018)

desempleados <- lm(desempleados ~ categoria_ocup_f +
                          ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018)

ayuda_pobres <- lm(ayuda_pobres ~ categoria_ocup_f +
                          ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018)

impuestos_ricos <- lm(impuestos_ricos ~ categoria_ocup_f +
                          ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018)

pFtest(democracia_fijo, democracia)
pFtest(desigualdad_fijo, desigualdad)
pFtest(desempleados_fijo, desempleados)
pFtest(ayuda_pobres_fijo, ayuda_pobres)
pFtest(impuestos_ricos_fijo, impuestos_ricos)

```
```{r gráficos efectos fijos categoría laboral, warning=FALSE, message=FALSE, echo=FALSE}
reg_coef <- plot_summs(democracia_fijo, desigualdad_fijo, desempleados_fijo, ayuda_pobres_fijo,
                       impuestos_ricos_fijo, ci_level = 0.95,
                       coefs = c("Patrón (Ref: inac)" = "categoria_ocup_fPatrón",
                                 "Asalariado pub." = "categoria_ocup_fAsalariado Público",
                                 "Asalariado priv." = "categoria_ocup_fAsalariado privado",
                                 "Cuenta propia" = "categoria_ocup_fCuenta propia",
                                 "Desocupados" = "categoria_ocup_fDesocupado",
                                 "Ideología (Der-Izq)" = "ideologia_imp",
                                 "Urbano (Ref: rural)" = "urbano",
                                 "Varón (Ref: Mujer)" = "sexoVarón",
                                 "Edad" = "q2",
                                 "Años educativos" = "ed"),
                       model.names = c("Democracia", "Desigualdad", "Desempleados", 
                                       "Ayuda pobres", "Impuestos ricos"),
                       point.size = 2,
                       legend.title = "Modelos")

reg_coef +
  theme_light() +
  labs(title = "Efectos sobre variables dependiente",
       subtitle = "Países seleccionados 2018. Regresiones lineales múltiples. Efectos fijos: países.",
         caption = "Fuente: elaboración propia en base a LAPOP 2018") +
  theme(axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_text(size = 9),
        axis.text.y = element_text(size = 8),
        legend.position= "right",
        panel.background = element_rect(fill = "transparent", colour = NA),
        plot.background = element_rect(fill = "transparent", colour = NA),
        legend.key = element_rect(fill = "transparent", colour = NA),
        legend.background= element_rect(fill = "transparent", colour = NA))

ggsave(filename = "salidas/efectosfijos_laboral1.png", dpi = 300, type = "cairo", width = 8, height = 6, bg='white')


reg_coef <- plot_summs(corrupcion_pub, golpe, cierre_congreso, cierre_corte, simpatiza_partido,
                       ci_level = 0.95, exp = T,
                       coefs = c("Patrón (Ref: inac)" = "categoria_ocup_fPatrón",
                                 "Asalariado pub." = "categoria_ocup_fAsalariado Público",
                                 "Asalariado priv." = "categoria_ocup_fAsalariado privado",
                                 "Cuenta propia" = "categoria_ocup_fCuenta propia",
                                 "Desocupados" = "categoria_ocup_fDesocupado",
                                 "Ideología (Der-Izq)" = "ideologia_imp",
                                 "Urbano (Ref: rural)" = "urbano",
                                 "Varón (Ref: Mujer)" = "sexoVarón",
                                 "Edad" = "q2",
                                 "Años educativos" = "ed"),
                       model.names = c("Corrupción", "Golpe militar", "Cierre congreso",
                                       "Cierre corte", "Simpatiza partido"),
                       point.size = 2,
                       legend.title = "Modelos")

reg_coef +
  theme_light() +
  labs(title = "Efectos sobre variables dependiente",
       subtitle = "Países seleccionados 2018. Regresiones logísticas binarias. \nCoeficientes exponenciados. Efectos fijos: países.",
         caption = "Fuente: elaboración propia en base a LAPOP 2018") +
  theme(axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_text(size = 9),
        axis.text.y = element_text(size = 8),
        legend.position= "right",
        panel.background = element_rect(fill = "transparent", colour = NA),
        plot.background = element_rect(fill = "transparent", colour = NA),
        legend.key = element_rect(fill = "transparent", colour = NA),
        legend.background= element_rect(fill = "transparent", colour = NA))

ggsave(filename = "salidas/efectosfijos_laboral2.png", dpi = 300, type = "cairo", width = 8, height = 6, bg='white')


```



## Utilizando solo formalidad  


```{r modelos efectos fijos 3, warning=FALSE, message=FALSE, echo=FALSE, results='asis'}

democracia_fijo <- plm(democracia7 ~ formal_estado +
                         ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018, index=c("country_f"), model="within")

desigualdad_fijo <- plm(reduc_desigualdad ~ formal_estado +
                          ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018, index=c("country_f"), model="within")

desempleados_fijo <- plm(desempleados ~ formal_estado +
                          ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018, index=c("country_f"), model="within")

ayuda_pobres_fijo <- plm(ayuda_pobres ~ formal_estado +
                          ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018, index=c("country_f"), model="within")

impuestos_ricos_fijo <- plm(impuestos_ricos ~ formal_estado +
                          ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018, index=c("country_f"), model="within")

tab_model(democracia_fijo, desigualdad_fijo, desempleados_fijo, ayuda_pobres_fijo,
          impuestos_ricos_fijo,
          p.style = "stars",
          show.ci = F,
          show.aic = T,
          dv.labels = c("Democracia", "Desigualdad", "Desempleados", "Ayuda pobres",
                        "Impuestos ricos"),
          pred.labels = c("Formal", "Informal", "Desocupado", 
                          "Ideología (der-izq)", "Urbano",
                          "Varón", "Edad", "Años educ."),
          title = "Regresión lineal múltiple con control por países. 2018.",
          file = "salidas/efectosfijos_formalidad1.doc")

# htmlreg(list(democracia_fijo, desigualdad_fijo, desempleados_fijo, ayuda_pobres_fijo, impuestos_ricos_fijo),
#         custom.model.names = c("Democracia", "Desigualdad", "Desempleados", "Ayuda pobres", "Impuestos ricos"),
#         caption = "Con variables laborales",
#         caption.above = T,
#         type = "html", doctype = FALSE)


corrupcion_pub <- glm(corrup_func ~ formal_estado +
                          ideologia_imp + urbano + sexo + q2 + ed + country_f, 
                       data=lapop2018, family=binomial(link="logit"))

golpe <- glm(golpe ~ formal_estado +
                          ideologia_imp + urbano + sexo + q2 + ed + country_f, 
                       data=lapop2018, family=binomial(link="logit"))

cierre_congreso <- glm(cierre_congreso ~ formal_estado +
                          ideologia_imp + urbano + sexo + q2 + ed + country_f, 
                       data=lapop2018, family=binomial(link="logit"))

cierre_corte <- glm(cierre_corte ~ formal_estado +
                          ideologia_imp + urbano + sexo + q2 + ed + country_f, 
                       data=lapop2018, family=binomial(link="logit"))

simpatiza_partido <- glm(simpatiza_partido ~ formal_estado +
                          ideologia_imp + urbano + sexo + q2 + ed + country_f,
                       data=lapop2018, family=binomial(link="logit"))

tab_model(corrupcion_pub, golpe, cierre_congreso, cierre_corte, simpatiza_partido,
          p.style = "stars",
          show.ci = F,
          show.aic = T,
          dv.labels = c("Corrupción", "Golpe militar", "Cierre congreso", 
                        "Cierre corte", "Simpatiza partido"),
          pred.labels = c("Intercepto", "Formal", "Informal", "Desocupado",
                          "Ideología (der-izq)", "Urbano",
                          "Varón", "Edad", "Años educ."),
          title = "Regresión logística binaria con control por países. 2018.",
          rm.terms = c("country_fBrasil",
                       "country_fChile",
                       "country_fColombia",
                       "country_fMéxico",
                       "country_fPerú",
                       "country_fUruguay",
                       "country_fArgentina"),
          file = "salidas/efectosfijos_formalidad2.doc")

```


```{r prueba efectos fijos 3, warning=FALSE, message=FALSE, echo=FALSE}
democracia <- lm(democracia7 ~ formal_estado +
                         ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018)

desigualdad <- lm(reduc_desigualdad ~ formal_estado +
                          ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018)

desempleados <- lm(desempleados ~ formal_estado +
                          ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018)

ayuda_pobres <- lm(ayuda_pobres ~ formal_estado +
                          ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018)

impuestos_ricos <- lm(impuestos_ricos ~ formal_estado +
                          ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018)

pFtest(democracia_fijo, democracia)
pFtest(desigualdad_fijo, desigualdad)
pFtest(desempleados_fijo, desempleados)
pFtest(ayuda_pobres_fijo, ayuda_pobres)
pFtest(impuestos_ricos_fijo, impuestos_ricos)

```
Para todos los modelos es significativo utilizar **efectos fijos**.  

```{r gráficos efectos fijos formalidad , warning=FALSE, message=FALSE, echo=FALSE}
reg_coef <- plot_summs(democracia_fijo, desigualdad_fijo, desempleados_fijo, ayuda_pobres_fijo,
                       impuestos_ricos_fijo, ci_level = 0.95,
                       coefs = c("Formal (Ref: inactivo)" = "formal_estadoFormal",
                                 "Informal" = "formal_estadoInformal",
                                 "Desocupado" = "formal_estadoDesocupado",
                                 "Ideología (Der-Izq)" = "ideologia_imp",
                                 "Urbano (Ref: rural)" = "urbano",
                                 "Varón (Ref: Mujer)" = "sexoVarón",
                                 "Edad" = "q2",
                                 "Años educativos" = "ed"),
                       model.names = c("Democracia", "Desigualdad", "Desempleados", 
                                       "Ayuda pobres", "Impuestos ricos"),
                       point.size = 2,
                       legend.title = "Modelos")

reg_coef +
  theme_light() +
  labs(title = "Efectos sobre variables dependiente",
       subtitle = "Países seleccionados 2018. Regresiones lineales múltiples. Efectos fijos: países.",
         caption = "Fuente: elaboración propia en base a LAPOP 2018") +
  theme(axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_text(size = 9),
        axis.text.y = element_text(size = 8),
        legend.position= "right",
        panel.background = element_rect(fill = "transparent", colour = NA),
        plot.background = element_rect(fill = "transparent", colour = NA),
        legend.key = element_rect(fill = "transparent", colour = NA),
        legend.background= element_rect(fill = "transparent", colour = NA))

ggsave(filename = "salidas/efectosfijos_formalidad1.png", dpi = 300, type = "cairo", width = 8, height = 6, bg='white')


reg_coef <- plot_summs(corrupcion_pub, golpe, cierre_congreso, cierre_corte, simpatiza_partido,
                       ci_level = 0.95, exp = T,
                       coefs = c("Formal (Ref: inactivo)" = "formal_estadoFormal",
                                 "Informal" = "formal_estadoInformal",
                                 "Desocupado" = "formal_estadoDesocupado",
                                 "Ideología (Der-Izq)" = "ideologia_imp",
                                 "Urbano (Ref: rural)" = "urbano",
                                 "Varón (Ref: Mujer)" = "sexoVarón",
                                 "Edad" = "q2",
                                 "Años educativos" = "ed"),
                       model.names = c("Corrupción", "Golpe militar", "Cierre congreso",
                                       "Cierre corte", "Simpatiza partido"),
                       point.size = 2,
                       legend.title = "Modelos")

reg_coef +
  theme_light() +
  labs(title = "Efectos sobre variables dependiente",
       subtitle = "Países seleccionados 2018. Regresiones logísticas binarias. \nCoeficientes exponenciados. Efectos fijos: países.",
         caption = "Fuente: elaboración propia en base a LAPOP 2018") +
  theme(axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_text(size = 9),
        axis.text.y = element_text(size = 8),
        legend.position= "right",
        panel.background = element_rect(fill = "transparent", colour = NA),
        plot.background = element_rect(fill = "transparent", colour = NA),
        legend.key = element_rect(fill = "transparent", colour = NA),
        legend.background= element_rect(fill = "transparent", colour = NA))

ggsave(filename = "salidas/efectosfijos_formalidad2.png", dpi = 300, type = "cairo", width = 8, height = 6, bg='white')


```

## Utilizando estatus ocupacional  


```{r modelos efectos fijos 4, warning=FALSE, message=FALSE, echo=FALSE, results='asis'}

democracia_fijo <- plm(democracia7 ~ estatus_ocup_f +
                         ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018, index=c("country_f"), model="within")

desigualdad_fijo <- plm(reduc_desigualdad ~ estatus_ocup_f +
                          ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018, index=c("country_f"), model="within")

desempleados_fijo <- plm(desempleados ~ estatus_ocup_f +
                          ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018, index=c("country_f"), model="within")

ayuda_pobres_fijo <- plm(ayuda_pobres ~ estatus_ocup_f +
                          ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018, index=c("country_f"), model="within")

impuestos_ricos_fijo <- plm(impuestos_ricos ~ estatus_ocup_f +
                          ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018, index=c("country_f"), model="within")

tab_model(democracia_fijo, desigualdad_fijo, desempleados_fijo, ayuda_pobres_fijo,
          impuestos_ricos_fijo,
          p.style = "stars",
          show.ci = F,
          show.aic = T,
          dv.labels = c("Democracia", "Desigualdad", "Desempleados", "Ayuda pobres",
                        "Impuestos ricos"),
          pred.labels = c("Directivos-profesionales", "Téc-adm-vend", 
                          "Trab. Man. calif",
                          "Trab. Man. No calif", "Ideología (der-izq)", "Urbano",
                          "Varón", "Edad", "Años educ."),
          title = "Regresión lineal múltiple con control por países. 2018.",
          file = "salidas/efectosfijos_estatus1.doc")


# htmlreg(list(democracia_fijo, desigualdad_fijo, desempleados_fijo, ayuda_pobres_fijo, impuestos_ricos_fijo),
#         custom.model.names = c("Democracia", "Desigualdad", "Desempleados", "Ayuda pobres", "Impuestos ricos"),
#         caption = "Con variable de estatus",
#         caption.above = T,
#         type = "html", doctype = FALSE)

corrupcion_pub <- glm(corrup_func ~ estatus_ocup_f +
                          ideologia_imp + urbano + sexo + q2 + ed + country_f, 
                       data=lapop2018, family=binomial(link="logit"))

golpe <- glm(golpe ~ estatus_ocup_f +
                          ideologia_imp + urbano + sexo + q2 + ed + country_f, 
                       data=lapop2018, family=binomial(link="logit"))

cierre_congreso <- glm(cierre_congreso ~ estatus_ocup_f +
                          ideologia_imp + urbano + sexo + q2 + ed + country_f, 
                       data=lapop2018, family=binomial(link="logit"))

cierre_corte <- glm(cierre_corte ~ estatus_ocup_f +
                          ideologia_imp + urbano + sexo + q2 + ed + country_f, 
                       data=lapop2018, family=binomial(link="logit"))

simpatiza_partido <- glm(simpatiza_partido ~ estatus_ocup_f +
                          ideologia_imp + urbano + sexo + q2 + ed + country_f,
                       data=lapop2018, family=binomial(link="logit"))

tab_model(corrupcion_pub, golpe, cierre_congreso, cierre_corte, simpatiza_partido,
          p.style = "stars",
          show.ci = F,
          show.aic = T,
          dv.labels = c("Corrupción", "Golpe militar", "Cierre congreso", 
                        "Cierre corte", "Simpatiza partido"),
          pred.labels = c("Intercepto", "Directivos-profesionales", "Téc-adm-vend", 
                          "Trab. Man. calif",
                          "Trab. Man. No calif",
                          "Ideología (der-izq)", "Urbano",
                          "Varón", "Edad", "Años educ."),
          title = "Regresión logística binaria con control por países. 2018.",
          rm.terms = c("country_fBrasil",
                       "country_fChile",
                       "country_fColombia",
                       "country_fMéxico",
                       "country_fPerú",
                       "country_fUruguay",
                       "country_fArgentina"),
          file = "salidas/efectosfijos_estatus2.doc")

```


```{r prueba efectos fijos 4, warning=FALSE, message=FALSE, echo=FALSE}
democracia <- lm(democracia7 ~ estatus_ocup_f +
                         ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018)

desigualdad <- lm(reduc_desigualdad ~ estatus_ocup_f +
                          ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018)

desempleados <- lm(desempleados ~ estatus_ocup_f +
                          ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018)

ayuda_pobres <- lm(ayuda_pobres ~ estatus_ocup_f +
                          ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018)

impuestos_ricos <- lm(impuestos_ricos ~ estatus_ocup_f +
                          ideologia_imp + urbano + sexo + q2 + ed, 
                       data=lapop2018)

pFtest(democracia_fijo, democracia)
pFtest(desigualdad_fijo, desigualdad)
pFtest(desempleados_fijo, desempleados)
pFtest(ayuda_pobres_fijo, ayuda_pobres)
pFtest(impuestos_ricos_fijo, impuestos_ricos)

```

Para todos los modelos es significativo utilizar **efectos fijos**.  

```{r gráficos efectos fijos estatus ocupacional, warning=FALSE, message=FALSE, echo=FALSE}
reg_coef <- plot_summs(democracia_fijo, desigualdad_fijo, desempleados_fijo, ayuda_pobres_fijo,
                       impuestos_ricos_fijo, ci_level = 0.95,
                       coefs = c("Directivos-profesionales (Ref: desocup-inac)" = "estatus_ocup_fDirectivos-Profesionales", 
                                 "Téc-adm-vend" = "estatus_ocup_fTécnicos-administrativos-vendedores",
                                 "Trab. Man. calif" = "estatus_ocup_fTrabajadores manuales calificados",
                                 "Trab. Man. No calif" = "estatus_ocup_fTrabajadores manuales no calificados", 
                                 "Ideología (Der-Izq)" = "ideologia_imp",
                                 "Urbano (Ref: rural)" = "urbano",
                                 "Varón (Ref: Mujer)" = "sexoVarón",
                                 "Edad" = "q2",
                                 "Años educativos" = "ed"),
                       model.names = c("Democracia", "Desigualdad", "Desempleados", 
                                       "Ayuda pobres", "Impuestos ricos"),
                       point.size = 2,
                       legend.title = "Modelos")

reg_coef +
  theme_light() +
  labs(title = "Efectos sobre variables dependiente",
       subtitle = "Países seleccionados 2018. Regresiones lineales múltiples. \nEfectos fijos: países.",
         caption = "Fuente: elaboración propia en base a LAPOP 2018") +
  theme(axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_text(size = 9),
        axis.text.y = element_text(size = 8),
        legend.position= "right",
        panel.background = element_rect(fill = "transparent", colour = NA),
        plot.background = element_rect(fill = "transparent", colour = NA),
        legend.key = element_rect(fill = "transparent", colour = NA),
        legend.background= element_rect(fill = "transparent", colour = NA))

ggsave(filename = "salidas/efectosfijos_estatusocup1.png", dpi = 300, type = "cairo", width = 8, height = 6, bg='white')


reg_coef <- plot_summs(corrupcion_pub, golpe, cierre_congreso, cierre_corte, simpatiza_partido,
                       ci_level = 0.95, exp = T,
                       coefs = c("Directivos-profesionales (Ref: desocup-inac)" = "estatus_ocup_fDirectivos-Profesionales", 
                                 "Téc-adm-vend" = "estatus_ocup_fTécnicos-administrativos-vendedores",
                                 "Trab. Man. calif" = "estatus_ocup_fTrabajadores manuales calificados",
                                 "Trab. Man. No calif" = "estatus_ocup_fTrabajadores manuales no calificados", 
                                 "Ideología (Der-Izq)" = "ideologia_imp",
                                 "Urbano (Ref: rural)" = "urbano",
                                 "Varón (Ref: Mujer)" = "sexoVarón",
                                 "Edad" = "q2",
                                 "Años educativos" = "ed"),
                       model.names = c("Corrupción", "Golpe militar", "Cierre congreso",
                                       "Cierre corte", "Simpatiza partido"),
                       point.size = 2,
                       legend.title = "Modelos")

reg_coef +
  theme_light() +
  labs(title = "Efectos sobre variables dependiente",
       subtitle = "Países seleccionados 2018. Regresiones logísticas binarias. \nCoeficientes exponenciados. Efectos fijos: países.",
         caption = "Fuente: elaboración propia en base a LAPOP 2018") +
  theme(axis.title.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_text(size = 9),
        axis.text.y = element_text(size = 8),
        legend.position= "right",
        panel.background = element_rect(fill = "transparent", colour = NA),
        plot.background = element_rect(fill = "transparent", colour = NA),
        legend.key = element_rect(fill = "transparent", colour = NA),
        legend.background= element_rect(fill = "transparent", colour = NA))

ggsave(filename = "salidas/efectosfijos_estatusocup2.png", dpi = 300, type = "cairo", width = 8, height = 6, bg='white')


```